# Golden Reference Test Fixtures

## Purpose

These fixtures contain golden reference outputs for inference validation.
They ensure that model loading produces correct inference results.

## Constitution Alignment

- **AP-007**: No stub data in production - these fixtures hold REAL validation data
- **REQ-EMB-003**: Inference validation against golden references
- **TECH-EMB-002**: Warm loading validation specification

## File Format

### test_input.bin

Binary format for dense embeddings (E1-E5, E7-E11):
- 4 bytes: dimension count (u32, little-endian)
- N * 4 bytes: f32 values (little-endian)

Example for 768-dim input:
```
Bytes 0-3:   0x00 0x03 0x00 0x00  (768 in little-endian)
Bytes 4-7:   f32 value #0 (little-endian)
Bytes 8-11:  f32 value #1 (little-endian)
...
```

### golden_output.bin

Same binary format as test_input.bin for dense models.

For sparse models (E6_Sparse, E13_Splade):
- 4 bytes: number of non-zero elements (u32, little-endian)
- For each non-zero element:
  - 4 bytes: index (u32, little-endian)
  - 4 bytes: value (f32, little-endian)

For late interaction (E12_LateInteraction):
- 4 bytes: number of tokens (u32, little-endian)
- 4 bytes: dimension per token (u32, little-endian = 128)
- For each token: 128 * 4 bytes: f32 values

### checksum.txt

SHA-256 checksum (64 hex characters) of the model weight file that produced this golden output.
Used to verify that golden data matches the current model weights.

Example content:
```
a1b2c3d4e5f67890a1b2c3d4e5f67890a1b2c3d4e5f67890a1b2c3d4e5f67890
```

## Model Directory Mapping

| Directory | Model | Input Dim | Output Dim | Notes |
|-----------|-------|-----------|------------|-------|
| E1_Semantic | nomic-embed-text-v1.5 | 768 | 1024 | Dense, Matryoshka |
| E2_TemporalRecent | Temporal Recent | 512 | 512 | Dense |
| E3_TemporalPeriodic | Temporal Periodic | 512 | 512 | Dense |
| E4_TemporalPositional | Temporal Positional | 512 | 512 | Dense |
| E5_Causal | Causal SCM | 768 | 768 | Dense, Asymmetric |
| E6_Sparse | Sparse Projection | 1536 | ~30K | Sparse (~5% active) |
| E7_Code | CodeBERT | 768 | 1536 | Dense |
| E8_Graph | MiniLM Graph | 384 | 384 | Dense |
| E9_Hdc | HDC Binary | 1024 | 1024 | Binary (packed bits) |
| E10_Multimodal | CLIP | 768 | 768 | Dense |
| E11_Entity | MiniLM Entity | 384 | 384 | Dense |
| E12_LateInteraction | ColBERT | Variable | 128/tok | Token-level |
| E13_Splade | SPLADE v2 | Variable | ~30K | Sparse |

## Validation Tolerance

Per `WarmValidator::DEFAULT_TOLERANCE` in `warm/validation/validator.rs`:
- **FP32**: 1e-5 absolute difference
- **Mixed precision**: 1e-3 absolute difference (for Float8/PQ-8 quantized models)

## Generating Golden Data

Golden data is generated by running real inference with verified model weights:

```bash
# After model weights are available:
cargo run --bin generate-golden -- --model E1_Semantic --output tests/fixtures/golden/E1_Semantic/
```

Generation steps:
1. Load model weights (verified SHA256 checksum)
2. Run forward pass with standard test input
3. Save output as golden_output.bin
4. Record weight file checksum in checksum.txt

## Placeholder Status

Until weights are trained and inference is operational, directories contain
placeholder files (0 bytes).

Run this command to list all placeholder files:
```bash
find tests/fixtures/golden -size 0 -type f
```

Run this command to verify directory structure:
```bash
find tests/fixtures/golden -type d | sort
```

## Related Files

- `crates/context-graph-embeddings/src/warm/validation/validator.rs` - Validation logic
- `crates/context-graph-embeddings/src/warm/validation/comparisons.rs` - Output comparison
- `crates/context-graph-embeddings/src/warm/loader/types.rs` - Data types
- `docs2/codecheck/embeddingissues/TECH-EMB-002-warm-loading.md` - Technical spec
