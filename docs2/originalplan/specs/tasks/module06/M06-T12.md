# M06-T12: Production Validation & Stub Audit

```yaml
metadata:
  id: "M06-T12"
  title: "Production Validation & Stub Audit"
  module: "module-06"
  module_name: "Stub Elimination"
  layer: "surface"
  priority: "critical"
  estimated_hours: 4
  created: "2026-01-04"
  status: "blocked"
  dependencies:
    - "M06-T11"  # Integration tests
  spec_refs:
    - "constitution.yaml:73"   # AP-007: No stub data in prod
```

## Problem Statement

This is the final validation task ensuring NO stub implementations remain in production code paths.

## Context

After all other M06 tasks are complete, we need to:
1. Audit all code for remaining stubs
2. Verify feature flags are correct
3. Create CI checks to prevent regression
4. Document acceptable stub usage (tests only)

## Input Context Files

```
crates/context-graph-core/src/stubs/           # Stub implementations
crates/context-graph-mcp/src/                  # MCP server code
crates/context-graph-*/src/                    # All crates
```

## Prerequisites

- [ ] M06-T11 complete (integration tests pass)

## Scope

### In Scope

- Full codebase audit for stub usage
- CI check scripts
- Production build verification
- Documentation of acceptable stubs
- Final traceability matrix update

### Out of Scope

- Actually fixing any found issues (should be caught by prior tasks)

## Definition of Done

### Audit Scripts

```bash
#!/bin/bash
# File: scripts/audit-stubs.sh

set -e

echo "=== STUB AUDIT FOR PRODUCTION BUILD ==="

# 1. No StubUtlProcessor in non-test code
echo "Checking for StubUtlProcessor..."
if grep -r "StubUtlProcessor" crates/*/src/*.rs 2>/dev/null | grep -v test | grep -v "#\[cfg(feature = \"stub\")\]"; then
    echo "FAIL: StubUtlProcessor found in production code"
    exit 1
fi
echo "PASS: No StubUtlProcessor in production"

# 2. No InMemoryStore in server code
echo "Checking for InMemoryStore in server..."
if grep "InMemoryStore" crates/context-graph-mcp/src/server.rs 2>/dev/null | grep -v "#\[cfg(feature = \"stub\")\]"; then
    echo "FAIL: InMemoryStore found in server.rs"
    exit 1
fi
echo "PASS: No InMemoryStore in server"

# 3. No fake embeddings
echo "Checking for fake embeddings..."
if grep -r "vec!\[0\.1" crates/*/src/*.rs 2>/dev/null | grep -v test; then
    echo "FAIL: Fake embeddings found"
    exit 1
fi
echo "PASS: No fake embeddings"

# 4. No stub imports without feature gate
echo "Checking for ungated stub imports..."
if grep -r "use.*stubs::" crates/*/src/*.rs 2>/dev/null | grep -v test | grep -v "#\[cfg(feature = \"stub\")\]" | grep -v "#\[cfg(test)\]"; then
    echo "FAIL: Ungated stub import found"
    exit 1
fi
echo "PASS: All stub imports are gated"

# 5. Count remaining unwrap_or in handlers
echo "Counting unwrap_or in handlers..."
COUNT=$(grep -c "unwrap_or" crates/context-graph-mcp/src/handlers/*.rs 2>/dev/null | awk -F: '{sum+=$2} END {print sum}' || echo "0")
if [ "$COUNT" -gt 10 ]; then
    echo "WARN: $COUNT unwrap_or patterns in handlers (target: <10)"
fi
echo "INFO: $COUNT unwrap_or patterns in handlers"

# 6. Build with production features
echo "Building with production features..."
cargo build -p context-graph-mcp --features real --release 2>&1 | tail -5
echo "PASS: Production build succeeded"

# 7. Run integration tests
echo "Running integration tests..."
cargo test -p context-graph-mcp --features real 2>&1 | tail -10
echo "PASS: Tests passed"

echo ""
echo "=== STUB AUDIT COMPLETE ==="
echo "All checks passed. System is production-ready."
```

### CI Configuration

```yaml
# File: .github/workflows/stub-audit.yml
name: Stub Audit

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Run Stub Audit
        run: ./scripts/audit-stubs.sh

      - name: Verify Production Build
        run: cargo build --features real --release

      - name: Check for Stub Leakage
        run: |
          # Ensure stub feature doesn't compile without flag
          if cargo build --no-default-features 2>&1 | grep -q "StubUtlProcessor"; then
            echo "ERROR: Stub code accessible without feature flag"
            exit 1
          fi
```

### Constraints

- Audit MUST run in CI on every PR
- Production build MUST NOT include stub code
- All stubs MUST be behind `#[cfg(feature = "stub")]`
- Scripts MUST be executable and documented

### Verification

```bash
# Run audit script
./scripts/audit-stubs.sh

# Verify production build
cargo build -p context-graph-mcp --features real --release

# Verify stub isolation
cargo build -p context-graph-mcp --no-default-features
```

## Pseudo Code

```
Final Verification Checklist:

  [ ] scripts/audit-stubs.sh passes
  [ ] cargo build --features real --release succeeds
  [ ] cargo test --features real passes (73+ tests)
  [ ] No grep matches for:
      - StubUtlProcessor in production code
      - InMemoryStore in server.rs
      - vec![0.1 in handlers/
      - Ungated stub imports
  [ ] Feature flags correctly isolate stubs
  [ ] CI workflow added and passing
  [ ] Traceability matrix updated (100% coverage)
  [ ] _index.md updated (all tasks complete)

Documentation Update:

  Update constitution.yaml to add:
    rules:
      - "Stub implementations require #[cfg(feature = \"stub\")] gate"
      - "Production builds use --features real"
      - "CI runs stub audit on every PR"
```

## Files to Create

| File | Description |
|------|-------------|
| `scripts/audit-stubs.sh` | Audit script |
| `.github/workflows/stub-audit.yml` | CI workflow |

## Files to Modify

| File | Change |
|------|--------|
| `specs/tasks/module06/_index.md` | Update all task statuses |
| `specs/tasks/module06/_traceability.md` | Mark all items verified |

## Validation Criteria

- [ ] Audit script passes with zero errors
- [ ] Production build succeeds
- [ ] All integration tests pass
- [ ] CI workflow runs successfully
- [ ] Module 06 _index.md shows 100% complete
- [ ] Traceability matrix shows 100% verified

## Test Commands

```bash
# Run full audit
./scripts/audit-stubs.sh

# Verify locally
cargo build -p context-graph-mcp --features real --release
cargo test -p context-graph-mcp --features real

# Simulate CI
act push  # If using act for local CI testing
```

---

*Task created: 2026-01-04*
*Module: 06 - Stub Elimination*
*Layer: Surface*
*Priority: CRITICAL - Final gate before production*
