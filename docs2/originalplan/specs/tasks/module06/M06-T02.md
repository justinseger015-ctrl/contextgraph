# M06-T02: Define EmbeddingProvider Trait & Factory in context-graph-core

```yaml
metadata:
  id: "M06-T02"
  title: "Define EmbeddingProvider Trait & Factory in context-graph-core"
  module: "module-06"
  module_name: "Stub Elimination"
  layer: "foundation"
  priority: "critical"
  estimated_hours: 4
  created: "2026-01-04"
  updated: "2026-01-04"
  status: "complete"  # VERIFIED BY SHERLOCK-HOLMES 2026-01-04
  dependencies: []
  blocks: ["M06-T04", "M06-T10"]
  spec_refs:
    - "docs2/constitution.yaml:305-323"   # 12-model embedding pipeline
    - "docs2/constitution.yaml:108-122"   # Performance budgets: single_embed <10ms, batch_embed_64 <50ms
    - "docs2/contextprd.md:189-208"       # Embedding models E1-E12
```

## Status: COMPLETE

**Verified:** 2026-01-04 by sherlock-holmes forensic investigation agent.

All implementation requirements have been satisfied. See verification report below.

---

## Implementation Summary

### What Was Built

1. **`EmbeddingProvider` trait** in `context-graph-core/src/traits/embedding_provider.rs`:
   - 5 async trait methods: `embed`, `embed_batch`, `dimensions`, `model_id`, `is_ready`
   - `EmbeddingOutput` struct with: `vector`, `model_id`, `dimensions`, `latency`
   - Exported via `context-graph-core/src/traits/mod.rs`

2. **`StubEmbeddingProvider`** in `context-graph-core/src/stubs/embedding_stub.rs`:
   - Hash-based deterministic embeddings (NOT hardcoded `vec![0.1; 1536]`)
   - Same content produces same embedding (deterministic tests)
   - Different content produces different embedding (similarity works)
   - L2-normalized output
   - Exported via `context-graph-core/src/stubs/mod.rs`

3. **`EmbeddingProviderAdapter`** in `context-graph-mcp/src/adapters/embedding_adapter.rs`:
   - Bridges `context_graph_embeddings::FusedEmbeddingProvider` to core trait
   - Maps `EmbeddingError` to `CoreError::Embedding`
   - Used in production `server.rs`

4. **Handlers updated** to use injected `EmbeddingProvider`:
   - `handlers/tools.rs`: `inject_context` (line 230), `store_memory` (line 279)
   - `handlers/memory.rs`: `handle_memory_store` (line 42)
   - NO more hardcoded `vec![0.1; 1536]`

5. **`CoreError::Embedding`** variant added to `context-graph-core/src/error.rs` (line 205)

---

## File Locations (Verified)

| Component | File Path | Key Lines |
|-----------|-----------|-----------|
| EmbeddingProvider trait | `crates/context-graph-core/src/traits/embedding_provider.rs` | 202-294 |
| EmbeddingOutput struct | `crates/context-graph-core/src/traits/embedding_provider.rs` | 64-88 |
| Trait export | `crates/context-graph-core/src/traits/mod.rs` | 9 |
| StubEmbeddingProvider | `crates/context-graph-core/src/stubs/embedding_stub.rs` | 30-136 |
| Stub export | `crates/context-graph-core/src/stubs/mod.rs` | 12 |
| EmbeddingProviderAdapter | `crates/context-graph-mcp/src/adapters/embedding_adapter.rs` | 49-284 |
| Adapter export | `crates/context-graph-mcp/src/adapters/mod.rs` | 21 |
| CoreError::Embedding | `crates/context-graph-core/src/error.rs` | 195-206 |
| Server wiring | `crates/context-graph-mcp/src/server.rs` | 39-56 |

---

## Verification Report (Sherlock-Holmes)

### All 17 Checks PASSED

| Check | Status |
|-------|--------|
| EmbeddingProvider trait has 5 methods | PASS |
| EmbeddingOutput has 4 fields | PASS |
| Trait exported in traits/mod.rs | PASS |
| StubEmbeddingProvider exists | PASS |
| Stub uses hash-based embedding | PASS |
| NO `vec![0.1; 1536]` in stub | PASS |
| Stub exported in stubs/mod.rs | PASS |
| tools.rs uses `embedding_provider.embed()` | PASS |
| memory.rs uses `embedding_provider.embed()` | PASS |
| NO `vec![0.1; 1536]` in handlers | PASS |
| EmbeddingProviderAdapter exists | PASS |
| Adapter implements core trait | PASS |
| Adapter wraps FusedEmbeddingProvider | PASS |
| server.rs uses EmbeddingProviderAdapter | PASS |
| server.rs does NOT use StubEmbeddingProvider | PASS |
| CoreError::Embedding exists | PASS |
| All embedding tests pass | PASS |

### Test Results

```bash
cargo test -p context-graph-core embedding
# Result: 22 passed, 0 failed

cargo test -p context-graph-mcp embedding
# Result: 12 passed, 0 failed
```

---

## Verification Commands (For Future Reference)

```bash
# 1. Build core crate
cargo build -p context-graph-core

# 2. Run trait tests
cargo test -p context-graph-core embedding -- --nocapture

# 3. Verify trait exports
grep -n "pub use embedding_provider" crates/context-graph-core/src/traits/mod.rs
# Expected: Line 9: pub use embedding_provider::{EmbeddingOutput, EmbeddingProvider};

# 4. Verify stub exports
grep -n "pub use embedding_stub" crates/context-graph-core/src/stubs/mod.rs
# Expected: Line 12: pub use embedding_stub::StubEmbeddingProvider;

# 5. Verify no hardcoded vectors in stub
grep -c "vec!\[0\.1" crates/context-graph-core/src/stubs/embedding_stub.rs
# Expected: 0

# 6. Verify no hardcoded vectors in handlers
grep -rn "vec!\[0\.1" crates/context-graph-mcp/src/handlers/*.rs
# Expected: No output (no matches)

# 7. Verify stub tests pass
cargo test -p context-graph-core test_stub_embed_different_content -- --nocapture
```

---

## Performance Requirements (constitution.yaml)

| Operation | Target | Implementation |
|-----------|--------|----------------|
| Single embed | <10ms | `EmbeddingProviderAdapter::embed()` via GPU |
| Batch embed (64) | <50ms | `EmbeddingProviderAdapter::embed_batch()` via GPU |
| Dimensions | 1536 | OpenAI ada-002 compatible |

---

## Constraints Satisfied

1. **NO BACKWARDS COMPATIBILITY** - Old `vec![0.1; 1536]` patterns removed
2. **NO MOCK DATA IN TESTS** - `StubEmbeddingProvider` uses hash-based deterministic embeddings
3. **FAIL FAST** - Empty content returns `CoreError::Embedding`, never silent default
4. **Trait in core ONLY** - `context-graph-embeddings` not modified
5. **async trait required** - All methods are async for GPU operations

---

## Next Steps (Blocked Tasks)

- **M06-T04**: Implement Candle EmbeddingProvider (can use `EmbeddingProviderAdapter` as reference)
- **M06-T10**: Wire MCP Server to Real Implementations (trait infrastructure complete)

---

*Task completed: 2026-01-04*
*Verified by: sherlock-holmes forensic investigation agent*
*Module: 06 - Stub Elimination*
*Layer: Foundation*
*Priority: CRITICAL*
