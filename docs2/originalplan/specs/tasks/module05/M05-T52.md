# M05-T52: Migrate and Re-export Core UTL Types

## Task Metadata
- **ID**: M05-T52
- **Title**: Migrate and Re-export Core UTL Types
- **Module**: 05 - UTL Integration
- **Layer**: completion
- **Priority**: high
- **Estimated Hours**: 3

## Description

Handle migration of existing UTL types from context-graph-core to context-graph-utl.
Current types in context-graph-core/src/types/utl.rs must be:
1. Either moved to context-graph-utl (if not used elsewhere)
2. Or re-exported from context-graph-utl with deprecation notices
3. Or kept in core with UTL crate depending on them

Create migration path:
- Audit all uses of existing UtlState, LearningSignal in core
- Determine ownership: core types vs utl-specific types
- Add #[deprecated] attributes with migration instructions
- Update all imports across workspace

Ensure no breaking changes for Module 4 code.

## File Path

`crates/context-graph-utl/src/compat.rs`

## Dependencies

| Task ID | Task Title | Status |
|---------|------------|--------|
| M05-T00 | Initialize context-graph-utl Crate Structure | pending |
| M05-T21 | LearningSignal and UtlState | pending |

## Acceptance Criteria

- [ ] Existing core types remain functional
- [ ] New UTL types in context-graph-utl crate
- [ ] Clear deprecation path documented
- [ ] No duplicate type definitions
- [ ] All workspace crates compile
- [ ] No breaking changes for Module 4

## Test File

`crates/context-graph-utl/tests/compat_tests.rs`

## Specification References

- TECH-UTL-005 Section 1.2

## Implementation Notes

### Migration Strategy

```
Phase 1: Audit
├── Find all uses of UtlState, LearningSignal in context-graph-core
├── Identify which types are core (shared) vs UTL-specific
└── Document current dependency graph

Phase 2: Type Ownership Decision
├── Core types (stay in context-graph-core):
│   ├── Basic type aliases
│   └── Shared interfaces
└── UTL-specific types (move to context-graph-utl):
    ├── UtlState (full implementation)
    ├── LearningSignal (with all fields)
    ├── JohariQuadrant
    └── LifecycleStage

Phase 3: Migration Implementation
├── Create canonical types in context-graph-utl
├── Add re-exports with deprecation in context-graph-core
└── Update all imports across workspace
```

### Compatibility Module

```rust
//! Compatibility layer for migrating UTL types from context-graph-core.
//!
//! This module provides re-exports and type aliases to ensure backward
//! compatibility with Module 4 code during the migration to the new
//! context-graph-utl crate structure.
//!
//! # Migration Guide
//!
//! Replace imports from `context_graph_core::types::utl::*` with
//! `context_graph_utl::*` in new code.
//!
//! Old imports will continue to work but will emit deprecation warnings.

use crate::{UtlState, LearningSignal, JohariQuadrant, LifecycleStage};

/// Re-export of UtlState for backward compatibility.
///
/// # Deprecated
///
/// Use `context_graph_utl::UtlState` directly instead.
#[deprecated(
    since = "0.5.0",
    note = "Import from context_graph_utl instead of context_graph_core::types::utl"
)]
pub type LegacyUtlState = UtlState;

/// Re-export of LearningSignal for backward compatibility.
///
/// # Deprecated
///
/// Use `context_graph_utl::LearningSignal` directly instead.
#[deprecated(
    since = "0.5.0",
    note = "Import from context_graph_utl instead of context_graph_core::types::utl"
)]
pub type LegacyLearningSignal = LearningSignal;
```

### Core Crate Deprecation Shim

In `crates/context-graph-core/src/types/utl.rs`:

```rust
//! Legacy UTL types - DEPRECATED
//!
//! These types have been moved to the `context-graph-utl` crate.
//! This module provides re-exports for backward compatibility.
//!
//! # Migration
//!
//! ```rust
//! // Old (deprecated)
//! use context_graph_core::types::utl::UtlState;
//!
//! // New (preferred)
//! use context_graph_utl::UtlState;
//! ```

#[deprecated(
    since = "0.5.0",
    note = "Moved to context_graph_utl crate. Update imports."
)]
pub use context_graph_utl::{
    UtlState,
    LearningSignal,
    JohariQuadrant,
    LifecycleStage,
    // Re-export other migrated types
};
```

### Workspace Cargo.toml Update

```toml
# In crates/context-graph-core/Cargo.toml
[dependencies]
context-graph-utl = { path = "../context-graph-utl" }

# In workspace root Cargo.toml
[workspace.dependencies]
context-graph-utl = { path = "crates/context-graph-utl" }
```

### Import Update Script

```bash
#!/bin/bash
# scripts/migrate-utl-imports.sh

# Find and replace old imports with new ones
find crates -name "*.rs" -exec sed -i \
    's/context_graph_core::types::utl::/context_graph_utl::/g' {} \;

# Report remaining uses that need manual review
echo "Files still using old imports:"
grep -rn "context_graph_core::types::utl" crates/ || echo "None found!"
```

### Compatibility Tests

```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_legacy_types_still_work() {
        // Ensure old type paths still compile (with deprecation warning)
        #[allow(deprecated)]
        let _state: LegacyUtlState = UtlState::default();
    }

    #[test]
    fn test_new_types_are_canonical() {
        // New types should be the authoritative source
        let state = UtlState::default();
        assert!(state.learning_magnitude >= 0.0);
    }

    #[test]
    fn test_no_type_duplication() {
        use std::any::TypeId;

        // Verify that old and new types are the same type
        #[allow(deprecated)]
        {
            assert_eq!(
                TypeId::of::<LegacyUtlState>(),
                TypeId::of::<UtlState>()
            );
        }
    }

    #[test]
    fn test_workspace_compiles() {
        // This test exists to ensure the workspace builds without errors
        // If this test runs, compilation succeeded
        assert!(true);
    }
}
```

### Documentation Update

Add to `crates/context-graph-utl/README.md`:

```markdown
## Migration from context-graph-core

If you're upgrading from a version where UTL types were in `context-graph-core`,
update your imports:

```rust
// Before (deprecated)
use context_graph_core::types::utl::{UtlState, LearningSignal};

// After
use context_graph_utl::{UtlState, LearningSignal};
```

The old imports will continue to work but will emit deprecation warnings.
```

## Verification Commands

```bash
# Verify all workspace crates compile
cargo build --workspace

# Check for deprecation warnings
cargo build --workspace 2>&1 | grep -i deprecated

# Run compatibility tests
cargo test -p context-graph-utl compat

# Verify no duplicate type definitions
cargo doc --workspace --no-deps 2>&1 | grep -i "duplicate"

# Check that Module 4 tests still pass
cargo test -p context-graph-graph
cargo test -p context-graph-core
```

---

*Generated: 2026-01-04*
*Module: 05 - UTL Integration*
*Task: M05-T52*
