# M05-T33: Implement JohariConfig Struct

```yaml
task_id: M05-T33
title: "Implement JohariConfig Struct"
module: "module-05-utl-integration"
layer: "integration"
priority: "high"
status: "pending"
estimated_hours: 1
created: "2026-01-04"
dependencies:
  - M05-T01  # UtlConfig and UtlThresholds Structs
spec_refs:
  - "TECH-UTL-005 Section 10"
  - "SPEC-UTL-005 Section 7.4"
file_path: "crates/context-graph-utl/src/config.rs"
test_file: "crates/context-graph-utl/tests/config_tests.rs"
```

---

## Description

Implement the JohariConfig struct for Johari classifier configuration. This struct contains entropy and coherence thresholds used to classify memory states into the four Johari Window quadrants (Open, Blind, Hidden, Unknown).

The Johari Window is a psychological framework adapted here for memory classification:
- **Open**: Low entropy, high coherence (well-understood, consistent)
- **Blind**: High entropy, low coherence (surprising, inconsistent)
- **Hidden**: Low entropy, low coherence (familiar but disconnected)
- **Unknown**: High entropy, high coherence (novel but consistent)

---

## Implementation Requirements

### JohariConfig Struct

```rust
use serde::{Deserialize, Serialize};

/// Configuration for the JohariClassifier.
///
/// Defines the entropy and coherence thresholds used to classify
/// memories into the four Johari Window quadrants.
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct JohariConfig {
    /// Entropy threshold for quadrant classification (default: 0.5)
    /// delta_s < entropy_threshold => "low entropy"
    /// delta_s >= entropy_threshold => "high entropy"
    pub entropy_threshold: f32,

    /// Coherence threshold for quadrant classification (default: 0.5)
    /// delta_c < coherence_threshold => "low coherence"
    /// delta_c >= coherence_threshold => "high coherence"
    pub coherence_threshold: f32,

    /// Optional per-quadrant retrieval strategy overrides
    #[serde(default)]
    pub quadrant_strategies: Option<QuadrantStrategies>,
}

/// Per-quadrant retrieval strategy configuration
#[derive(Debug, Clone, Serialize, Deserialize, Default)]
pub struct QuadrantStrategies {
    pub open: Option<RetrievalStrategyConfig>,
    pub blind: Option<RetrievalStrategyConfig>,
    pub hidden: Option<RetrievalStrategyConfig>,
    pub unknown: Option<RetrievalStrategyConfig>,
}

/// Configurable retrieval strategy parameters
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct RetrievalStrategyConfig {
    /// Search depth for graph traversal
    pub search_depth: u32,
    /// Whether to include neighbor nodes
    pub include_neighbors: bool,
    /// Confidence threshold for retrieval
    pub confidence_threshold: f32,
    /// Maximum number of results
    pub max_results: u32,
}
```

### Default Implementation

```rust
impl Default for JohariConfig {
    fn default() -> Self {
        Self {
            entropy_threshold: 0.5,
            coherence_threshold: 0.5,
            quadrant_strategies: None,
        }
    }
}

impl Default for RetrievalStrategyConfig {
    fn default() -> Self {
        Self {
            search_depth: 2,
            include_neighbors: true,
            confidence_threshold: 0.5,
            max_results: 10,
        }
    }
}
```

### Per-Quadrant Default Strategies

The JohariClassifier uses these defaults when `quadrant_strategies` is None:

| Quadrant | search_depth | include_neighbors | confidence_threshold | max_results |
|----------|--------------|-------------------|---------------------|-------------|
| Open | 1 | false | 0.8 | 5 |
| Blind | 3 | true | 0.4 | 20 |
| Hidden | 2 | true | 0.6 | 10 |
| Unknown | 4 | true | 0.3 | 30 |

```rust
impl JohariConfig {
    /// Get retrieval strategy for a specific quadrant
    pub fn get_strategy(&self, quadrant: JohariQuadrant) -> RetrievalStrategyConfig {
        // Check for custom strategy first
        if let Some(ref strategies) = self.quadrant_strategies {
            let custom = match quadrant {
                JohariQuadrant::Open => &strategies.open,
                JohariQuadrant::Blind => &strategies.blind,
                JohariQuadrant::Hidden => &strategies.hidden,
                JohariQuadrant::Unknown => &strategies.unknown,
            };
            if let Some(strategy) = custom {
                return strategy.clone();
            }
        }

        // Return default strategy for quadrant
        Self::default_strategy(quadrant)
    }

    /// Get default strategy for a quadrant
    fn default_strategy(quadrant: JohariQuadrant) -> RetrievalStrategyConfig {
        match quadrant {
            JohariQuadrant::Open => RetrievalStrategyConfig {
                search_depth: 1,
                include_neighbors: false,
                confidence_threshold: 0.8,
                max_results: 5,
            },
            JohariQuadrant::Blind => RetrievalStrategyConfig {
                search_depth: 3,
                include_neighbors: true,
                confidence_threshold: 0.4,
                max_results: 20,
            },
            JohariQuadrant::Hidden => RetrievalStrategyConfig {
                search_depth: 2,
                include_neighbors: true,
                confidence_threshold: 0.6,
                max_results: 10,
            },
            JohariQuadrant::Unknown => RetrievalStrategyConfig {
                search_depth: 4,
                include_neighbors: true,
                confidence_threshold: 0.3,
                max_results: 30,
            },
        }
    }
}
```

### Validation Method

```rust
impl JohariConfig {
    /// Validate configuration values are within acceptable ranges.
    pub fn validate(&self) -> Result<(), ConfigError> {
        // Thresholds must be in [0, 1]
        if self.entropy_threshold < 0.0 || self.entropy_threshold > 1.0 {
            return Err(ConfigError::InvalidValue {
                field: "entropy_threshold".to_string(),
                value: self.entropy_threshold.to_string(),
                reason: "must be in range [0, 1]".to_string(),
            });
        }

        if self.coherence_threshold < 0.0 || self.coherence_threshold > 1.0 {
            return Err(ConfigError::InvalidValue {
                field: "coherence_threshold".to_string(),
                value: self.coherence_threshold.to_string(),
                reason: "must be in range [0, 1]".to_string(),
            });
        }

        // Validate custom strategies if present
        if let Some(ref strategies) = self.quadrant_strategies {
            if let Some(ref s) = strategies.open { Self::validate_strategy("open", s)?; }
            if let Some(ref s) = strategies.blind { Self::validate_strategy("blind", s)?; }
            if let Some(ref s) = strategies.hidden { Self::validate_strategy("hidden", s)?; }
            if let Some(ref s) = strategies.unknown { Self::validate_strategy("unknown", s)?; }
        }

        Ok(())
    }

    fn validate_strategy(name: &str, strategy: &RetrievalStrategyConfig) -> Result<(), ConfigError> {
        if strategy.confidence_threshold < 0.0 || strategy.confidence_threshold > 1.0 {
            return Err(ConfigError::InvalidValue {
                field: format!("{}.confidence_threshold", name),
                value: strategy.confidence_threshold.to_string(),
                reason: "must be in range [0, 1]".to_string(),
            });
        }
        if strategy.max_results == 0 {
            return Err(ConfigError::InvalidValue {
                field: format!("{}.max_results", name),
                value: "0".to_string(),
                reason: "must be greater than 0".to_string(),
            });
        }
        Ok(())
    }
}
```

---

## Classification Logic

The JohariConfig thresholds determine quadrant classification:

```
                    Coherence
                 Low      High
              +--------+--------+
     Low      | Hidden |  Open  |
Entropy       +--------+--------+
     High     | Blind  |Unknown |
              +--------+--------+
```

Classification formula:
```rust
pub fn classify(&self, delta_s: f32, delta_c: f32) -> JohariQuadrant {
    let low_entropy = delta_s < self.config.entropy_threshold;
    let high_coherence = delta_c >= self.config.coherence_threshold;

    match (low_entropy, high_coherence) {
        (true, true) => JohariQuadrant::Open,
        (true, false) => JohariQuadrant::Hidden,
        (false, true) => JohariQuadrant::Unknown,
        (false, false) => JohariQuadrant::Blind,
    }
}
```

---

## Acceptance Criteria

- [ ] JohariConfig struct with 2 threshold fields
- [ ] QuadrantStrategies struct for per-quadrant overrides (optional)
- [ ] RetrievalStrategyConfig struct with 4 fields
- [ ] Default implementation returns spec-defined values (0.5, 0.5)
- [ ] `get_strategy(quadrant)` returns appropriate configuration
- [ ] Per-quadrant default strategies match specification table
- [ ] `validate()` method checks all constraints
- [ ] Serde serialization works correctly
- [ ] Integrates correctly with JohariClassifier

---

## Test Cases

```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_default_values() {
        let config = JohariConfig::default();
        assert_eq!(config.entropy_threshold, 0.5);
        assert_eq!(config.coherence_threshold, 0.5);
        assert!(config.quadrant_strategies.is_none());
    }

    #[test]
    fn test_default_validates() {
        let config = JohariConfig::default();
        assert!(config.validate().is_ok());
    }

    #[test]
    fn test_invalid_entropy_threshold() {
        let mut config = JohariConfig::default();
        config.entropy_threshold = 1.5;
        assert!(config.validate().is_err());

        config.entropy_threshold = -0.1;
        assert!(config.validate().is_err());
    }

    #[test]
    fn test_invalid_coherence_threshold() {
        let mut config = JohariConfig::default();
        config.coherence_threshold = 1.5;
        assert!(config.validate().is_err());
    }

    #[test]
    fn test_default_strategy_open() {
        let config = JohariConfig::default();
        let strategy = config.get_strategy(JohariQuadrant::Open);
        assert_eq!(strategy.search_depth, 1);
        assert!(!strategy.include_neighbors);
        assert_eq!(strategy.confidence_threshold, 0.8);
        assert_eq!(strategy.max_results, 5);
    }

    #[test]
    fn test_default_strategy_unknown() {
        let config = JohariConfig::default();
        let strategy = config.get_strategy(JohariQuadrant::Unknown);
        assert_eq!(strategy.search_depth, 4);
        assert!(strategy.include_neighbors);
        assert_eq!(strategy.confidence_threshold, 0.3);
        assert_eq!(strategy.max_results, 30);
    }

    #[test]
    fn test_custom_strategy_override() {
        let custom = RetrievalStrategyConfig {
            search_depth: 5,
            include_neighbors: false,
            confidence_threshold: 0.9,
            max_results: 3,
        };

        let config = JohariConfig {
            entropy_threshold: 0.5,
            coherence_threshold: 0.5,
            quadrant_strategies: Some(QuadrantStrategies {
                open: Some(custom.clone()),
                blind: None,
                hidden: None,
                unknown: None,
            }),
        };

        let strategy = config.get_strategy(JohariQuadrant::Open);
        assert_eq!(strategy.search_depth, 5);
        assert_eq!(strategy.max_results, 3);

        // Blind should still use default
        let blind_strategy = config.get_strategy(JohariQuadrant::Blind);
        assert_eq!(blind_strategy.search_depth, 3);
    }

    #[test]
    fn test_serde_roundtrip() {
        let config = JohariConfig::default();
        let json = serde_json::to_string(&config).unwrap();
        let deserialized: JohariConfig = serde_json::from_str(&json).unwrap();
        assert_eq!(config.entropy_threshold, deserialized.entropy_threshold);
        assert_eq!(config.coherence_threshold, deserialized.coherence_threshold);
    }

    #[test]
    fn test_serde_with_strategies() {
        let config = JohariConfig {
            entropy_threshold: 0.6,
            coherence_threshold: 0.4,
            quadrant_strategies: Some(QuadrantStrategies {
                open: Some(RetrievalStrategyConfig {
                    search_depth: 2,
                    include_neighbors: true,
                    confidence_threshold: 0.7,
                    max_results: 8,
                }),
                blind: None,
                hidden: None,
                unknown: None,
            }),
        };

        let json = serde_json::to_string(&config).unwrap();
        let deserialized: JohariConfig = serde_json::from_str(&json).unwrap();
        assert!(deserialized.quadrant_strategies.is_some());
    }
}
```

---

## YAML Configuration Example

```yaml
johari:
  entropy_threshold: 0.5
  coherence_threshold: 0.5
  quadrant_strategies:
    open:
      search_depth: 1
      include_neighbors: false
      confidence_threshold: 0.8
      max_results: 5
    blind:
      search_depth: 3
      include_neighbors: true
      confidence_threshold: 0.4
      max_results: 20
    hidden:
      search_depth: 2
      include_neighbors: true
      confidence_threshold: 0.6
      max_results: 10
    unknown:
      search_depth: 4
      include_neighbors: true
      confidence_threshold: 0.3
      max_results: 30
```

---

## File Structure

```
crates/context-graph-utl/
  src/
    config.rs           <- Implementation file (add JohariConfig here)
  tests/
    config_tests.rs     <- Test file
```

---

## Dependencies

- `serde`: Serialization/deserialization
- `context-graph-utl::johari::JohariQuadrant`: Quadrant enum (from M05-T08)

---

## Notes

- JohariConfig is part of the larger UtlConfig structure
- The default thresholds (0.5, 0.5) provide balanced quadrant distribution
- Per-quadrant strategies allow fine-tuning retrieval behavior
- The Unknown quadrant requires deepest search (most exploration) because high entropy + high coherence indicates novel but consistent information worth investigating
- The Open quadrant uses shallowest search because the information is well-understood
