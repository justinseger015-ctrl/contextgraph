# M05-T35: Implement KnowledgeGraph Integration for Coherence

```yaml
task_id: "M05-T35"
title: "Implement KnowledgeGraph Integration for Coherence"
module: "module-05"
layer: "integration"
priority: "high"
estimated_hours: 4
status: "pending"
created: "2026-01-04"
updated: "2026-01-04"
```

---

## Description

Complete KnowledgeGraph integration for structural coherence and contradiction detection. Implement compute_structural_coherence() using graph connectivity. Implement compute_contradiction_penalty() using search_similar() and edge analysis. Add find_contradiction_edge() calls for conflict detection. Replace stub implementations from M05-T14 with real graph queries. Handle graceful degradation when graph unavailable.

---

## File Paths

| Type | Path |
|------|------|
| Implementation | `crates/context-graph-utl/src/coherence/structural.rs` |
| Test | `crates/context-graph-utl/tests/structural_coherence_tests.rs` |

---

## Dependencies

| Task ID | Title | Status |
|---------|-------|--------|
| M05-T14 | Structural Coherence and Contradiction Detection (stub) | pending |
| Module 4 | Knowledge Graph completion | completed |

---

## Acceptance Criteria

- [ ] Structural coherence uses actual graph metrics
- [ ] Contradiction detection queries similar nodes
- [ ] Edge analysis identifies conflicting information
- [ ] Performance: < 5ms for graph queries
- [ ] Graceful fallback when graph unavailable

---

## Specification References

- SPEC-UTL-005 Section 4.2
- SPEC-UTL-005 Section 17.1

---

## Technical Notes

### Structural Coherence Algorithm

The structural coherence measures how well a new piece of information fits into the existing knowledge graph:

1. **Graph Connectivity Analysis**
   - Query the KnowledgeGraph for nodes similar to the input embedding
   - Measure edge density and path lengths to related concepts
   - Higher connectivity = higher structural coherence

2. **Contradiction Detection**
   - Use `search_similar()` to find potentially conflicting nodes
   - Apply `contradiction_similarity_threshold` (0.85) to identify near-duplicates
   - Check edge types for CONTRADICTS or CONFLICTS_WITH relationships
   - Call `find_contradiction_edge()` for explicit conflict detection

3. **Penalty Computation**
   - Contradiction penalty reduces overall coherence
   - Formula: `(semantic * semantic_weight + structural * structural_weight) * (1 - contradiction_penalty)`
   - `max_contradiction_penalty` caps the penalty at 0.5

### Graph Query Interface

```rust
/// Compute structural coherence using graph topology
pub fn compute_structural_coherence(
    &self,
    embedding: &[f32],
    graph: &KnowledgeGraph,
) -> f32 {
    // 1. Find similar nodes
    // 2. Compute connectivity metrics
    // 3. Return normalized coherence score [0, 1]
}

/// Detect contradictions with existing knowledge
pub fn compute_contradiction_penalty(
    &self,
    content: &str,
    embedding: &[f32],
    graph: &KnowledgeGraph,
) -> f32 {
    // 1. Search for similar nodes (k = contradiction_search_k)
    // 2. Check similarity threshold
    // 3. Analyze edges for conflicts
    // 4. Return penalty [0, max_contradiction_penalty]
}
```

### Graceful Degradation

When the KnowledgeGraph is unavailable or queries fail:
- Log warning with tracing
- Return `default_coherence_no_concepts` (0.4) for structural coherence
- Return 0.0 for contradiction penalty (assume no conflicts)
- Do not propagate errors; use Result or Option patterns

### Performance Considerations

- Cache recent graph query results
- Limit similarity search to top-k candidates
- Use async graph queries if available
- Target: < 5ms for complete structural coherence computation

---

## Implementation Checklist

1. [ ] Create `crates/context-graph-utl/src/coherence/structural.rs`
2. [ ] Implement `compute_structural_coherence()` with graph connectivity
3. [ ] Implement `compute_contradiction_penalty()` with similarity search
4. [ ] Add `find_contradiction_edge()` call integration
5. [ ] Implement graceful fallback for unavailable graph
6. [ ] Replace stub implementations from M05-T14
7. [ ] Add performance instrumentation (tracing spans)
8. [ ] Write unit tests for structural coherence
9. [ ] Write tests for contradiction detection
10. [ ] Write tests for graceful degradation
11. [ ] Benchmark graph query performance (< 5ms target)
12. [ ] Update module exports in `coherence/mod.rs`

---

## Test Cases

### Unit Tests

```rust
#[test]
fn test_structural_coherence_with_connected_nodes() {
    // Setup graph with connected nodes
    // Verify high coherence for well-connected input
}

#[test]
fn test_structural_coherence_isolated_node() {
    // Input has no similar nodes in graph
    // Verify low coherence score
}

#[test]
fn test_contradiction_penalty_duplicate() {
    // Near-duplicate content detected
    // Verify penalty applied
}

#[test]
fn test_contradiction_penalty_conflicting_edge() {
    // CONTRADICTS edge exists
    // Verify max penalty applied
}

#[test]
fn test_graceful_degradation_no_graph() {
    // Graph unavailable
    // Verify default values returned, no panic
}

#[test]
fn test_performance_under_5ms() {
    // Benchmark graph queries
    // Assert < 5ms for 100 nodes
}
```

---

*Module: 05 - UTL Integration*
*Task: 35 of 57*
*Layer: Integration*
