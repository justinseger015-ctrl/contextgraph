# M05-T23: UtlError Enum

```yaml
task_id: M05-T23
title: "UtlError Enum"
module: "Module 5: UTL Integration"
layer: "surface"
priority: "high"
status: "COMPLETE"
estimated_hours: 1
created: "2026-01-04"
completed: "2026-01-04"

file_path: "crates/context-graph-utl/src/error.rs"
test_location: "crates/context-graph-utl/src/error.rs (inline #[cfg(test)])"

dependencies: []

git_ref: "f521803 feat(utl): complete context-graph-utl crate with 453 tests passing"
```

---

## STATUS: COMPLETE

**Verification Date**: 2026-01-04

The `UtlError` enum is fully implemented at `crates/context-graph-utl/src/error.rs`:
- **Lines**: 408
- **Tests**: 20 inline tests (all passing)
- **Re-export**: Line 53 in `crates/context-graph-utl/src/lib.rs`

---

## Implementation Details

### File Location
```
crates/context-graph-utl/src/error.rs    # 408 lines, 20 tests
crates/context-graph-utl/src/lib.rs:53   # pub use error::{UtlError, UtlResult};
```

### UtlError Variants (17 total)

| # | Variant | Fields | Error Message Template |
|---|---------|--------|----------------------|
| 1 | `InvalidComputation` | `delta_s: f32, delta_c: f32, w_e: f32, phi: f32, reason: String` | "Invalid UTL computation: delta_s={}, delta_c={}, w_e={}, phi={}. {reason}" |
| 2 | `InvalidLambdaWeights` | `novelty: f32, consolidation: f32, reason: String` | "Invalid lambda weights: novelty={}, consolidation={}. {reason}" |
| 3 | `MissingContext` | `String` | "Missing context for UTL computation: {}" |
| 4 | `DimensionMismatch` | `expected: usize, actual: usize` | "Embedding dimension mismatch: expected {}, got {}" |
| 5 | `GraphError` | `String` | "Graph access error: {}" |
| 6 | `ConfigError` | `String` | "Configuration error: {}" |
| 7 | `InvalidLifecycleTransition` | `from: String, to: String, reason: String` | "Invalid lifecycle transition from {} to {}: {reason}" |
| 8 | `JohariError` | `String` | "Johari classification error: {}" |
| 9 | `PhaseError` | `String` | "Phase oscillator error: {}" |
| 10 | `SurpriseError` | `String` | "Surprise computation error: {}" |
| 11 | `CoherenceError` | `String` | "Coherence computation error: {}" |
| 12 | `EmptyInput` | (unit) | "Empty input provided for UTL computation" |
| 13 | `SerializationError` | `String` | "Serialization error: {}" |
| 14 | `InvalidParameter` | `name: String, value: String, reason: String` | "Invalid parameter '{name}': {value}. {reason}" |
| 15 | `NumericOverflow` | `operation: String, details: String` | "Numeric overflow/underflow in {operation}: {details}" |
| 16 | `EntropyError` | `String` | "Entropy computation error: {}" |
| 17 | `CapacityError` | `String` | "Memory/capacity error: {}" |

### Helper Constructors

```rust
// Lines 134-198
UtlError::nan_result(delta_s, delta_c, w_e, phi)      // InvalidComputation with "Result is NaN"
UtlError::infinite_result(delta_s, delta_c, w_e, phi) // InvalidComputation with "Result is infinite"
UtlError::lambda_sum_error(novelty, consolidation)    // InvalidLambdaWeights with sum info
UtlError::negative_lambda(novelty, consolidation)     // InvalidLambdaWeights with "negative" reason
UtlError::invalid_transition(from, to, reason)        // InvalidLifecycleTransition
UtlError::invalid_param(name, value, reason)          // InvalidParameter
```

### Classification Methods

```rust
// Lines 201-222
impl UtlError {
    /// Returns true if error can be retried with different parameters
    /// Recoverable: InvalidLambdaWeights, InvalidParameter, DimensionMismatch, EmptyInput
    pub fn is_recoverable(&self) -> bool;

    /// Returns true if error indicates computation failure
    /// Computation errors: InvalidComputation, SurpriseError, CoherenceError, PhaseError, EntropyError, NumericOverflow
    pub fn is_computation_error(&self) -> bool;
}
```

### Trait Implementations

- `#[derive(Debug, Error)]` via `thiserror` crate
- `impl From<serde_json::Error> for UtlError` (lines 126-130)

---

## Dependencies (Cargo.toml)

```toml
# Already configured in crates/context-graph-utl/Cargo.toml
[dependencies]
thiserror = "1.0"
serde_json = "1.0"
```

---

## Verification Commands

```bash
# 1. Check file exists and line count
wc -l crates/context-graph-utl/src/error.rs
# EXPECTED: 408 crates/context-graph-utl/src/error.rs

# 2. Run error module tests
cargo test -p context-graph-utl --lib error:: 2>&1 | grep -E "(test result|passed)"
# EXPECTED: test result: ok. 20 passed; 0 failed;

# 3. Verify re-export in lib.rs
grep -n "pub use error" crates/context-graph-utl/src/lib.rs
# EXPECTED: 53:pub use error::{UtlError, UtlResult};

# 4. Compilation check
cargo check -p context-graph-utl 2>&1 | tail -3
# EXPECTED: Finished `dev` profile

# 5. Full test run with verbose output
cargo test -p context-graph-utl --lib error:: -- --nocapture 2>&1 | head -50
```

---

## Source of Truth

| Item | Location |
|------|----------|
| **Definition** | `crates/context-graph-utl/src/error.rs` (lines 1-121) |
| **Tests** | `crates/context-graph-utl/src/error.rs` (lines 225-408) |
| **Re-export** | `crates/context-graph-utl/src/lib.rs:53` |
| **Type alias** | `pub type UtlResult<T> = Result<T, UtlError>;` (line 124) |

---

## Test Coverage (20 Tests)

| Test Name | Lines | Verifies |
|-----------|-------|----------|
| `test_error_display` | 230-241 | InvalidComputation formatting |
| `test_dimension_mismatch_display` | 244-252 | DimensionMismatch formatting |
| `test_empty_input_error` | 255-258 | EmptyInput variant |
| `test_nan_result_helper` | 261-266 | `nan_result()` helper |
| `test_infinite_result_helper` | 269-273 | `infinite_result()` helper |
| `test_lambda_sum_error_helper` | 276-282 | `lambda_sum_error()` helper |
| `test_negative_lambda_helper` | 285-289 | `negative_lambda()` helper |
| `test_invalid_transition_helper` | 292-298 | `invalid_transition()` helper |
| `test_invalid_param_helper` | 301-307 | `invalid_param()` helper |
| `test_is_recoverable` | 310-319 | `is_recoverable()` classification |
| `test_is_computation_error` | 322-328 | `is_computation_error()` classification |
| `test_lifecycle_transition_error` | 331-341 | InvalidLifecycleTransition |
| `test_johari_error` | 344-349 | JohariError variant |
| `test_numeric_overflow_error` | 352-360 | NumericOverflow variant |
| `test_from_serde_json_error` | 363-367 | From<serde_json::Error> impl |
| `test_missing_context_error` | 370-375 | MissingContext variant |
| `test_graph_error` | 378-383 | GraphError variant |
| `test_config_error` | 386-391 | ConfigError variant |
| `test_entropy_error` | 394-399 | EntropyError variant |
| `test_capacity_error` | 402-407 | CapacityError variant |

---

## Edge Case Validation

| Edge Case | Test | Expected Behavior |
|-----------|------|-------------------|
| Empty input | `test_empty_input_error` | Returns `UtlError::EmptyInput` |
| NaN in computation | `test_nan_result_helper` | Returns `InvalidComputation { reason: "Result is NaN" }` |
| Infinite result | `test_infinite_result_helper` | Returns `InvalidComputation { reason: "Result is infinite" }` |
| Lambda sum != 1.0 | `test_lambda_sum_error_helper` | Returns `InvalidLambdaWeights` with computed sum |
| Negative lambda | `test_negative_lambda_helper` | Returns `InvalidLambdaWeights { reason: "negative" }` |
| Invalid JSON | `test_from_serde_json_error` | Converts to `SerializationError` |

---

## Related Tasks

| Task | Relationship |
|------|--------------|
| M05-T21 | `LearningSignal.validate()` returns `UtlResult` |
| M05-T22 | `UtlProcessor` methods return `UtlResult` |
| M05-T06 | `LifecycleLambdaWeights` uses `InvalidLambdaWeights` |
| M05-T35 | Graph integration uses `GraphError` |
| M05-T17 | `PhaseOscillator` uses `PhaseError` |
| M05-T11 | `SurpriseCalculator` uses `SurpriseError` |
| M05-T13 | `CoherenceTracker` uses `CoherenceError` |

---

## Full State Verification Protocol

### Step 1: Define Source of Truth
The canonical source is `crates/context-graph-utl/src/error.rs`. All error types used across the UTL crate MUST be variants of `UtlError`.

### Step 2: Execute & Inspect
```bash
# Run all error tests and capture output
cargo test -p context-graph-utl --lib error:: -- --nocapture 2>&1 | tee /tmp/error_tests.log

# Verify 20 tests passed
grep "test result" /tmp/error_tests.log
# MUST show: test result: ok. 20 passed; 0 failed;
```

### Step 3: Boundary & Edge Case Audit

**Edge Case 1: Empty Input**
```bash
cargo test -p context-graph-utl --lib test_empty_input_error -- --nocapture 2>&1
# Verify: "Empty input provided" appears in output
```

**Edge Case 2: NaN Result**
```bash
cargo test -p context-graph-utl --lib test_nan_result_helper -- --nocapture 2>&1
# Verify: "NaN" and "delta_s=0.5" appear in output
```

**Edge Case 3: Lambda Sum Error**
```bash
cargo test -p context-graph-utl --lib test_lambda_sum_error_helper -- --nocapture 2>&1
# Verify: "sum to 1.0" and actual sum value appear in output
```

### Step 4: Evidence of Success
```bash
# Show actual enum variants
grep -E "^    [A-Z][a-zA-Z]+(\s|\{)" crates/context-graph-utl/src/error.rs | head -20
# Must show all 17 variants

# Show test count
cargo test -p context-graph-utl --lib error:: 2>&1 | grep "passed"
# Must show: 20 passed
```

---

## Sherlock Verification (MANDATORY)

After any audit of this task, run sherlock-holmes agent:

```
Use Task tool with subagent_type='sherlock-holmes':

Verify M05-T23 (UtlError Enum) implementation:
1. Read crates/context-graph-utl/src/error.rs (MUST be 408 lines)
2. Count enum variants (MUST be 17)
3. Run: cargo test -p context-graph-utl --lib error:: (MUST pass 20 tests)
4. Check line 53 of lib.rs re-exports UtlError and UtlResult
5. Verify thiserror derive macro is used
6. Confirm is_recoverable() and is_computation_error() methods exist
7. Report any discrepancies as ERRORS, not warnings
```

---

## Constraints (ENFORCED)

1. **NO BACKWARDS COMPATIBILITY**: Missing variants = compilation error
2. **NO MOCK DATA**: All tests use real `UtlError` instances
3. **FAIL FAST**: Invalid inputs return `Err(UtlError::...)`, never panic
4. **ROBUST LOGGING**: All error variants include context (field values in error messages)
5. **NO SILENT FAILURES**: Every error variant has descriptive message via `#[error(...)]`

---

## Constitution References

- `constitution.yaml` lines 148-167: UTL parameter definitions
- `constitution.yaml` line 61: "Result<T,E> for fallible ops, thiserror for derivation"
- `constitution.yaml` line 82: "AP-009: NaN/Infinity in UTL â†’ clamp to valid range"

---

*Task verified: 2026-01-04*
*Implementation: COMPLETE*
*Tests: 20 passing*
*Git ref: f521803*
