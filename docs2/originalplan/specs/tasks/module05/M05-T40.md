# M05-T40: Implement UTL Feature Flag Gating

## Task Metadata
- **ID**: M05-T40
- **Title**: Implement UTL Feature Flag Gating
- **Module**: 05 - UTL Integration
- **Layer**: integration
- **Priority**: high
- **Estimated Hours**: 2
- **Created**: 2026-01-04
- **Status**: pending

## Description

Implement feature flag gating for gradual UTL rollout. Configuration in config/default.toml: utl.enabled = true/false.

When disabled:
- UTL computation returns default values (L=0.5, quadrant=Open)
- CognitivePulse uses fallback values
- MCP tools skip UTL processing
- MemoryNode.utl_state remains None

When enabled:
- Full UTL computation active
- All UTL-dependent features operational

Include runtime toggle via MCP admin tool (admin/toggle_utl).

## File Paths

### Implementation
- `crates/context-graph-core/src/config/feature_flags.rs`

### Tests
- `crates/context-graph-core/tests/feature_flags_tests.rs`

## Dependencies

| Task ID | Title | Status |
|---------|-------|--------|
| M05-T22 | Implement UtlProcessor | pending |

## Acceptance Criteria

- [ ] utl.enabled config flag controls UTL activation
- [ ] Disabled mode returns safe default values
- [ ] No performance penalty when UTL disabled
- [ ] Runtime toggle available via admin tool
- [ ] Feature flag persists across restarts
- [ ] All UTL-dependent code paths check flag

## Specification References

- `constitution.yaml phases.0_Ghost`
- `PRD Section 12 (Phase 0: Ghost System)`

## Implementation Notes

### Feature Flag Configuration

```toml
# config/default.toml
[utl]
enabled = true  # Master UTL enable/disable flag
```

### Default Values When Disabled

```rust
// When UTL is disabled, return these defaults
const DEFAULT_LEARNING_MAGNITUDE: f32 = 0.5;
const DEFAULT_QUADRANT: JohariQuadrant = JohariQuadrant::Open;
```

### Runtime Toggle Interface

```rust
/// MCP admin tool for runtime UTL toggle
pub async fn toggle_utl(enabled: bool) -> Result<ToggleResponse, AdminError> {
    // 1. Update in-memory flag
    // 2. Persist to config if permanent
    // 3. Return confirmation with current state
}
```

### Performance Considerations

- Feature flag check must be O(1)
- Use atomic boolean for runtime flag
- No allocation when checking disabled state

## Testing Requirements

1. **Unit Tests**
   - Test flag loading from config
   - Test default values when disabled
   - Test runtime toggle functionality
   - Test persistence across restarts

2. **Integration Tests**
   - Test full system behavior with UTL disabled
   - Test MCP tools skip UTL processing
   - Test CognitivePulse fallback values
   - Test MemoryNode.utl_state is None

3. **Performance Tests**
   - Verify zero overhead when disabled
   - Benchmark flag check latency

## Rollback Plan

If UTL causes issues in production:
1. Set utl.enabled = false in config
2. Use admin/toggle_utl for immediate runtime disable
3. All UTL-dependent features gracefully degrade to defaults

---

*Task specification generated for Module 05 - UTL Integration*
