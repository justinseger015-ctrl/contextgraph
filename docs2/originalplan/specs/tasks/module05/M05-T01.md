# M05-T01: Define UtlConfig and UtlThresholds Structs

```yaml
task:
  id: "M05-T01"
  title: "Define UtlConfig and UtlThresholds Structs"
  module: "05 - UTL Integration"
  layer: "foundation"
  priority: "critical"
  estimated_hours: 2
  status: "COMPLETE"
  created: "2025-12-31"
  updated: "2026-01-04"
  version: "3.1.0"
  verified_by: "sherlock-holmes"
```

---

## TASK STATUS: COMPLETE (VERIFIED 2026-01-04)

**Sherlock-Holmes Forensic Audit Result: INNOCENT (COMPLETE)**

Implementation verified at:
```
crates/context-graph-utl/src/config.rs (1274 lines)
```

**Test Status:** 369 tests passing (14 config-specific tests)

---

## For AI Agents: Quick Context

This task implements the core configuration structs for the Unified Theory of Learning (UTL) system. The UTL formula is:

```
L = f((ΔS × ΔC) · wₑ · cos φ)
```

Where:
- ΔS = entropy/novelty change [0,1]
- ΔC = coherence/understanding change [0,1]
- wₑ = emotional weight [0.5, 1.5]
- φ = phase synchronization [0, π]
- L = learning magnitude output

The configuration structs define the parameters and thresholds for computing these values.

---

## Exact File Locations

| Item | Path | Line |
|------|------|------|
| UtlConfig struct | `crates/context-graph-utl/src/config.rs` | 35 |
| UtlThresholds struct | `crates/context-graph-utl/src/config.rs` | 920 |
| Tests (#[cfg(test)]) | `crates/context-graph-utl/src/config.rs` | 1047-1274 |
| Re-exports | `crates/context-graph-utl/src/lib.rs` | Line ~20 |

---

## UtlConfig Struct (Line 35)

```rust
#[derive(Debug, Clone, Serialize, Deserialize, Default)]
pub struct UtlConfig {
    pub surprise: SurpriseConfig,      // ΔS computation params
    pub coherence: CoherenceConfig,    // ΔC computation params
    pub emotional: EmotionalConfig,    // wₑ computation params
    pub phase: PhaseConfig,            // φ computation params
    pub johari: JohariConfig,          // Johari quadrant classification
    pub lifecycle: LifecycleConfig,    // Infancy/Growth/Maturity stages
    pub kl: KlConfig,                  // KL divergence for surprise
    pub thresholds: UtlThresholds,     // Quality thresholds
    pub debug: bool,                   // Debug mode flag
}
```

**Total: 9 fields**

---

## UtlThresholds Struct (Line 920)

```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct UtlThresholds {
    pub min_score: f32,               // 0.0 - minimum valid L
    pub max_score: f32,               // 1.0 - maximum valid L
    pub high_quality: f32,            // 0.6 (constitution: utl_avg > 0.6)
    pub low_quality: f32,             // 0.3 - below this needs attention
    pub coherence_recovery_secs: u64, // 10 (constitution: coherence_recovery < 10s)
    pub info_loss_tolerance: f32,     // 0.15 (constitution: info_loss < 15%)
    pub compression_target: f32,      // 0.6 (constitution: compression > 60%)
    pub float_tolerance: f32,         // 1e-6 - for float comparisons
    pub nan_replacement: f32,         // 0.0 - replace NaN with this
    pub inf_replacement: f32,         // 1.0 - replace Infinity with this
}
```

**Note:** UtlThresholds uses `impl Default` block (not derive) for explicit control.

---

## Constitution.yaml Compliance (VERIFIED)

| Requirement | Value | Code Location | Status |
|------------|-------|---------------|--------|
| wₑ range [0.5, 1.5] | min_weight: 0.5, max_weight: 1.5 | EmotionalConfig L368-369 | PASS |
| φ range [0, π] | min_phase: 0.0, max_phase: PI | PhaseConfig L471-472 | PASS |
| utl_avg > 0.6 | high_quality: 0.6 | UtlThresholds L961 | PASS |
| coherence_recovery < 10s | coherence_recovery_secs: 10 | UtlThresholds L963 | PASS |
| info_loss < 15% | info_loss_tolerance: 0.15 | UtlThresholds L964 | PASS |
| compression > 60% | compression_target: 0.6 | UtlThresholds L965 | PASS |
| Infancy 0-50, λ_ΔS=0.7, λ_ΔC=0.3 | StageConfig::default() | LifecycleConfig | PASS |
| Growth 50-500, λ_ΔS=0.5, λ_ΔC=0.5 | StageConfig | LifecycleConfig | PASS |
| Maturity 500+, λ_ΔS=0.3, λ_ΔC=0.7 | StageConfig | LifecycleConfig | PASS |

---

## Verification Commands (Run These)

```bash
# 1. Verify structs exist at correct locations
grep -n "pub struct UtlConfig" crates/context-graph-utl/src/config.rs
# Expected: 35:pub struct UtlConfig {

grep -n "pub struct UtlThresholds" crates/context-graph-utl/src/config.rs
# Expected: 920:pub struct UtlThresholds {

# 2. Run config tests
cargo test -p context-graph-utl config:: --lib
# Expected: 14 tests pass, 0 fail

# 3. Verify full test suite
cargo test -p context-graph-utl --lib 2>&1 | tail -3
# Expected: test result: ok. 369 passed; 0 failed;

# 4. Verify constitution compliance test
grep -A 30 "fn test_constitution_compliance" crates/context-graph-utl/src/config.rs
```

---

## MANDATORY: Full State Verification Protocol

### Source of Truth

The **source of truth** for this task is:
- **PRIMARY FILE**: `crates/context-graph-utl/src/config.rs`
- **TEST COMMAND**: `cargo test -p context-graph-utl config:: --lib`
- **BUILD COMMAND**: `cargo build -p context-graph-utl`

### Execute & Inspect Procedure

**CRITICAL:** Do NOT rely on return values alone. Perform these verification steps:

```bash
# STEP 1: Execute tests and capture output
cargo test -p context-graph-utl config:: --lib 2>&1 | tee /tmp/m05-t01-test-output.txt

# STEP 2: Verify specific test results (must show PASS for each)
grep -E "(test config|test.*utl.*config|test result)" /tmp/m05-t01-test-output.txt

# STEP 3: Read source of truth directly
grep -A 10 "pub struct UtlConfig" crates/context-graph-utl/src/config.rs
grep -A 12 "pub struct UtlThresholds" crates/context-graph-utl/src/config.rs

# STEP 4: Verify Default implementations produce valid configs
cargo test -p context-graph-utl test_utl_config_default --lib -- --nocapture
```

### Boundary & Edge Case Audit (3 Required)

**Edge Case 1: Empty/Default Config**
```bash
# State BEFORE: No config exists
# Action: Call UtlConfig::default()
# State AFTER: Valid config with constitution-compliant values
cargo test -p context-graph-utl test_utl_config_default --lib 2>&1
# REQUIRED OUTPUT: "test result: ok"
```

**Edge Case 2: Invalid Values**
```bash
# State BEFORE: Config with out-of-range values
# Action: Call validate()
# State AFTER: Result::Err with descriptive message
cargo test -p context-graph-utl test_surprise_config_validation --lib 2>&1
# REQUIRED OUTPUT: "test result: ok" (test verifies invalid configs are rejected)
```

**Edge Case 3: Serialization Roundtrip**
```bash
# State BEFORE: Valid UtlConfig
# Action: Serialize to JSON, deserialize back
# State AFTER: Identical config (field equality)
cargo test -p context-graph-utl test_serialization --lib 2>&1
# REQUIRED OUTPUT: "test result: ok"
```

### Evidence of Success

Generate completion evidence with this command:

```bash
echo "=== M05-T01 COMPLETION EVIDENCE ===" && \
echo "Timestamp: $(date -Is)" && \
echo "Git Hash: $(git rev-parse HEAD)" && \
echo "" && \
echo "SOURCE OF TRUTH VERIFICATION:" && \
echo "1. UtlConfig struct:" && \
grep -n "pub struct UtlConfig" crates/context-graph-utl/src/config.rs && \
echo "" && \
echo "2. UtlThresholds struct:" && \
grep -n "pub struct UtlThresholds" crates/context-graph-utl/src/config.rs && \
echo "" && \
echo "3. Test execution results:" && \
cargo test -p context-graph-utl config:: --lib 2>&1 | grep -E "test result|passed|failed" && \
echo "" && \
echo "4. Constitution compliance test:" && \
cargo test -p context-graph-utl test_constitution_compliance --lib 2>&1 | grep -E "test result|ok|FAILED" && \
echo "" && \
echo "=== VERIFICATION COMPLETE ==="
```

---

## Sherlock-Holmes Verification (MANDATORY)

Use the `sherlock-holmes` subagent with this exact prompt:

```
FORENSIC INVESTIGATION: M05-T01 UtlConfig and UtlThresholds

CLAIMS TO VERIFY (ASSUME ALL ARE LIES):

1. UtlConfig struct exists at crates/context-graph-utl/src/config.rs line 35
   - Execute: grep -n "pub struct UtlConfig" crates/context-graph-utl/src/config.rs
   - Verify derives: Debug, Clone, Serialize, Deserialize, Default

2. UtlThresholds struct exists at line 920
   - Execute: grep -n "pub struct UtlThresholds" crates/context-graph-utl/src/config.rs
   - Verify has 10 threshold fields

3. All config tests pass
   - Execute: cargo test -p context-graph-utl config:: --lib
   - Count exact pass/fail numbers

4. Constitution compliance
   - emotional weight range: [0.5, 1.5]
   - phase range: [0, PI]
   - lifecycle stages: Infancy(0-50), Growth(50-500), Maturity(500+)
   - high_quality = 0.6

5. No backwards compatibility hacks
   - Search: grep -rn "deprecated\|alias\|fallback\|compat" crates/context-graph-utl/src/config.rs
   - Expected: no matches

ASSUME ALL CODE IS GUILTY UNTIL PROVEN INNOCENT.
Report any discrepancy between this document and reality.
```

---

## Dependencies

### This Task Depends On
- **M05-T00**: COMPLETE - Crate initialized

### Tasks That Depend On This (All COMPLETE)
| Task | Title | Status |
|------|-------|--------|
| M05-T02 | SurpriseConfig | COMPLETE |
| M05-T03 | CoherenceConfig | COMPLETE |
| M05-T04 | EmotionalConfig | COMPLETE |
| M05-T07 | LifecycleConfig | COMPLETE |
| M05-T32 | PhaseConfig | COMPLETE |
| M05-T33 | JohariConfig | COMPLETE |
| M05-T34 | config/utl.yaml | Pending |

---

## NO BACKWARDS COMPATIBILITY

**CRITICAL RULE:** This codebase does NOT support backwards compatibility layers.

If changes are required:
1. **Modify the struct directly** - NO deprecated aliases
2. **Update all call sites** - NO fallback logic
3. **Fail fast on invalid config** - validation returns `Result<(), String>`
4. **Comprehensive error messages** - include field names, values, and expected ranges

Example error message format:
```
UtlConfig validation failed: emotional.min_weight (0.3) must be >= 0.5
```

---

## Reference Files

| File | Purpose | Critical For |
|------|---------|--------------|
| `docs2/constitution.yaml` | UTL parameter ranges (lines 148-167) | Default values |
| `docs2/contextprd.md` | UTL formula definition (Section 2.1) | Formula implementation |
| `crates/context-graph-utl/src/lib.rs` | Re-exports UtlConfig publicly | API surface |
| `steveprog/docs3/learntheory.md` | UTL theoretical background | Understanding L formula |

---

*Task Version: 3.1.0*
*Status: COMPLETE*
*Last Verified: 2026-01-04 by sherlock-holmes*
*Implementation: crates/context-graph-utl/src/config.rs (1274 lines)*
*Tests: 14 config tests + 355 other UTL tests = 369 total*
