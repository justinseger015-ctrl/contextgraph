# M05-T26: Implement utl_status MCP Tool

```yaml
metadata:
  id: "M05-T26"
  title: "Implement utl_status MCP Tool"
  module: "module-05"
  module_name: "UTL Integration"
  layer: "integration"
  priority: "critical"
  estimated_hours: 3
  created: "2026-01-04"
  status: "completed"
  completion_date: "2026-01-04"
  dependencies:
    - "M05-T22"  # UtlProcessor orchestrator (COMPLETED)
    - "M05-T24"  # UtlStatus/UtlStatusResponse structs (COMPLETED)
  spec_refs:
    - "SPEC-UTL-005 Section 10.1"
```

## STATUS: COMPLETED

All components have been implemented and verified. See Evidence of Completion section below.

## Description

The `utl_status` MCP tool exposes UTL system state via the JSON-RPC 2.0 protocol. This tool enables external systems (Claude, AI agents, monitoring) to query the current learning system status.

## What Was Implemented

### 1. Tool Definition Added (tools.rs:170-180)
```rust
ToolDefinition::new(
    "utl_status",
    "Query current UTL (Unified Theory of Learning) system state including lifecycle phase, \
     entropy, coherence, learning score, Johari quadrant, and consolidation phase.",
    json!({
        "type": "object",
        "properties": {},
        "required": []
    }),
),
```

### 2. Tool Name Constant Added (tools.rs:191)
```rust
pub const UTL_STATUS: &str = "utl_status";
```

### 3. Dispatch Case Added (handlers/tools.rs:68)
```rust
tool_names::UTL_STATUS => self.call_utl_status(id).await,
```

### 4. Handler Method Implemented (handlers/tools.rs:293-304)
```rust
pub(super) async fn call_utl_status(&self, id: Option<JsonRpcId>) -> JsonRpcResponse {
    debug!("Handling utl_status tool call");
    let status = self.utl_processor.get_status();
    Self::tool_result(id, status)
}
```

### 5. UtlProcessor Trait Extended (traits/utl_processor.rs:72-78)
```rust
/// Get current UTL system status as JSON.
fn get_status(&self) -> serde_json::Value;
```

### 6. Stub Implementation (stubs/utl_stub.rs:104-122)
```rust
fn get_status(&self) -> serde_json::Value {
    serde_json::json!({
        "lifecycle_phase": "Infancy",
        "interaction_count": 0,
        "entropy": 0.0,
        "coherence": 0.0,
        "learning_score": 0.0,
        "johari_quadrant": "Hidden",
        "consolidation_phase": "Wake",
        "phase_angle": 0.0,
        "thresholds": {
            "entropy_trigger": 0.9,
            "coherence_trigger": 0.2,
            "min_importance_store": 0.1,
            "consolidation_threshold": 0.3
        }
    })
}
```

### 7. Test Count Updated (handlers/tests/tools_list.rs:28-33)
Tests now verify 6 tools (was 5).

### 8. Integration Tests Added (handlers/tests/tools_call.rs:288-422)
Two new integration tests verify the complete tools/call path:
- `test_tools_call_utl_status` - Verifies full MCP response format and all schema fields
- `test_tools_call_utl_status_returns_stub_values` - Verifies stub returns expected defaults

## Source Files Modified

| File | Lines | Change |
|------|-------|--------|
| `crates/context-graph-mcp/src/tools.rs` | 170-180, 191 | Tool definition + constant |
| `crates/context-graph-mcp/src/handlers/tools.rs` | 68, 293-304 | Dispatch + handler |
| `crates/context-graph-core/src/traits/utl_processor.rs` | 72-78 | Trait extension |
| `crates/context-graph-core/src/stubs/utl_stub.rs` | 104-122 | Stub implementation |
| `crates/context-graph-mcp/src/handlers/tests/tools_list.rs` | 28-33 | Test count update |
| `crates/context-graph-mcp/src/handlers/tests/tools_call.rs` | 288-422 | Integration tests |

## Existing Types Used (NOT Duplicated)

The following types from `context-graph-utl/src/metrics.rs` are used for the real processor implementation (future work):

- `UtlStatus` (lines 417-439)
- `UtlStatusResponse` (lines 523-551)
- `ThresholdsResponse` (lines 553-570)
- `UtlStatus::to_mcp_response()` (lines 502-515)

The stub processor returns JSON matching the `UtlStatusResponse` schema directly.

## Verification Commands

```bash
# Build MCP crate
cargo build -p context-graph-mcp

# Run all MCP tests (47 tests pass)
cargo test -p context-graph-mcp

# Run tools_list tests specifically
cargo test -p context-graph-mcp tools_list
```

## Full State Verification Protocol

### 1. Source of Truth Definition

The source of truth for `utl_status` is:
- **Tool Registry**: `crates/context-graph-mcp/src/tools.rs` - tool defined in `get_tool_definitions()`
- **Dispatch Table**: `crates/context-graph-mcp/src/handlers/tools.rs` - match arm for `UTL_STATUS`
- **Trait Interface**: `crates/context-graph-core/src/traits/utl_processor.rs` - `get_status()` method

### 2. Execute & Inspect

After implementation, the following verification was performed:

```bash
# Verify tool exists in registry
grep -n "utl_status" crates/context-graph-mcp/src/tools.rs
# Result: Line 172 (tool definition), Line 191 (constant)

# Verify dispatch exists
grep -n "UTL_STATUS" crates/context-graph-mcp/src/handlers/tools.rs
# Result: Line 68 (dispatch case)

# Verify trait method exists
grep -n "get_status" crates/context-graph-core/src/traits/utl_processor.rs
# Result: Line 78 (method signature)

# Verify stub implementation
grep -n "get_status" crates/context-graph-core/src/stubs/utl_stub.rs
# Result: Line 104 (implementation)

# Run all tests
cargo test -p context-graph-mcp
# Result: 47 passed; 0 failed
```

### 3. Boundary & Edge Case Audit

| Edge Case | Pre-State | Action | Post-State | Status |
|-----------|-----------|--------|------------|--------|
| Fresh processor (0 interactions) | No status | Call get_status() | Returns Infancy, count=0 | PASS |
| Missing tool name | Request without name | tools/call | Error -32602 | PASS |
| Unknown tool name | Request with "bad_tool" | tools/call | Error "Unknown tool" | PASS |

### 4. Evidence of Success

```
$ cargo test -p context-graph-mcp 2>&1 | tail -10
test handlers::tests::tools_call::test_tools_call_utl_status ... ok
test handlers::tests::tools_call::test_tools_call_utl_status_returns_stub_values ... ok
test handlers::tests::tools_list::test_tools_list_contains_expected_tool_names ... ok
test handlers::tests::tools_list::test_tools_list_returns_all_6_tools ... ok
...
test result: ok. 49 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out
```

Tool list verification confirms `utl_status` is registered:
- 6 tools total (inject_context, store_memory, get_memetic_status, get_graph_manifest, search_graph, **utl_status**)
- Each tool has name, description, inputSchema
- All tools have valid JSON Schema with type: "object"
- Integration tests verify tools/call dispatch and response schema

## Acceptance Criteria Status

- [x] `utl_status` tool registered in `get_tool_definitions()`
- [x] `UTL_STATUS` constant added to `tool_names` module
- [x] Tool dispatch case added in `handle_tools_call()`
- [x] Handler method `call_utl_status()` implemented
- [x] Uses `UtlProcessor::get_status()` trait method
- [x] Stub implementation returns valid `UtlStatusResponse`-compatible JSON
- [x] Response matches expected schema
- [x] All tests pass with `cargo test -p context-graph-mcp`
- [x] Integration tests verify complete tools/call path (2 tests added)

## Future Work (M05-T27+)

1. **Real UtlProcessor implementation**: Replace stub with actual `UtlProcessor` from `context-graph-utl`
2. **Session-scoped queries**: Add session_id parameter for per-session UTL state
3. **Metrics integration**: Connect to real `UtlComputationMetrics` tracking
4. **Integration tests**: End-to-end JSON-RPC tests with live server

## Notes

- The stub processor returns default/initial status (Infancy stage, 0 interactions)
- Real processor will use `UtlStatus::to_mcp_response()` for proper conversion
- Response schema is forward-compatible for future field additions
- NO TYPE DUPLICATION - reuses existing types from context-graph-utl
