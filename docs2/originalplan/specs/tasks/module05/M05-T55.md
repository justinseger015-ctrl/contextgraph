# M05-T55: Implement Hyperbolic Entailment Interface Stubs

## Task Metadata
- **ID**: M05-T55
- **Title**: Implement Hyperbolic Entailment Interface Stubs
- **Module**: 05 - UTL Integration
- **Layer**: completion
- **Priority**: low
- **Estimated Hours**: 2
- **Created**: 2026-01-04
- **Status**: pending

## Description

Create hyperbolic entailment interface stubs for cone membership validation.

Per constitution.yaml refs (HE Cones: ICML, Poincare: NeurIPS):
- Hyperbolic space better represents hierarchical relationships
- Entailment cones define "is-a" relationships
- cone_membership(parent, child) -> bool

Create HyperbolicEntailmentInterface trait with:
- `check_entailment(parent_embedding, child_embedding) -> EntailmentResult`
- `get_cone_ancestors(node) -> Vec<NodeId>`
- `validate_hierarchy(nodes) -> HierarchyValidation`

Stub until Module 4 hyperbolic features complete.

Note: This interfaces with Module 4 graph layer.

## File Paths

### Implementation
- `crates/context-graph-utl/src/entailment/interface.rs`
- `crates/context-graph-utl/src/entailment/mod.rs`

### Tests
- `crates/context-graph-utl/tests/entailment_tests.rs`

## Dependencies

| Task ID | Title | Status |
|---------|-------|--------|
| M05-T22 | Implement UtlProcessor | pending |

## Acceptance Criteria

- [ ] HyperbolicEntailmentInterface trait defined
- [ ] EntailmentResult struct with confidence score
- [ ] Stub returns neutral results
- [ ] Interface compatible with Module 4 hyperbolic layer

## Specification References

- `constitution.yaml refs.external (HE Cones, Poincare)`

## Implementation Notes

### HyperbolicEntailmentInterface Trait

```rust
use async_trait::async_trait;

/// Interface for hyperbolic entailment cone operations
/// Stubs until Module 4 hyperbolic features are complete
#[async_trait]
pub trait HyperbolicEntailmentInterface: Send + Sync {
    /// Check if parent entails child in hyperbolic space
    ///
    /// Uses cone membership to determine hierarchical relationship.
    /// Per constitution.yaml, entailment cones define "is-a" relationships.
    ///
    /// # Arguments
    /// * `parent_embedding` - Parent node embedding in Poincare ball
    /// * `child_embedding` - Child node embedding in Poincare ball
    ///
    /// # Returns
    /// EntailmentResult with confidence score and cone membership
    async fn check_entailment(
        &self,
        parent_embedding: &[f32],
        child_embedding: &[f32],
    ) -> Result<EntailmentResult, EntailmentError>;

    /// Get all ancestors via cone membership traversal
    ///
    /// Returns nodes whose cones contain the given node.
    ///
    /// # Arguments
    /// * `node_id` - Node to find ancestors for
    ///
    /// # Returns
    /// Vector of ancestor node IDs ordered by distance
    async fn get_cone_ancestors(
        &self,
        node_id: &NodeId,
    ) -> Result<Vec<NodeId>, EntailmentError>;

    /// Validate hierarchical consistency of node set
    ///
    /// Checks for cycles, contradictions, and missing links.
    ///
    /// # Arguments
    /// * `nodes` - Set of nodes to validate
    ///
    /// # Returns
    /// HierarchyValidation with issues and suggestions
    async fn validate_hierarchy(
        &self,
        nodes: &[NodeId],
    ) -> Result<HierarchyValidation, EntailmentError>;
}
```

### EntailmentResult Struct

```rust
/// Result of entailment check between two nodes
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct EntailmentResult {
    /// Whether parent entails child (cone membership)
    pub entails: bool,

    /// Confidence score [0.0, 1.0]
    pub confidence: f32,

    /// Distance in hyperbolic space
    pub hyperbolic_distance: f32,

    /// Cone aperture angle used for check
    pub cone_aperture: f32,

    /// Whether reverse entailment holds (child entails parent)
    pub reverse_entails: bool,

    /// Additional metadata
    pub metadata: EntailmentMetadata,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct EntailmentMetadata {
    /// Curvature of the Poincare ball used
    pub curvature: f32,

    /// Computation time in microseconds
    pub compute_time_us: u64,

    /// Whether result came from cache
    pub cached: bool,
}

impl Default for EntailmentResult {
    fn default() -> Self {
        Self {
            entails: false,
            confidence: 0.5,  // Neutral confidence for stub
            hyperbolic_distance: 0.0,
            cone_aperture: std::f32::consts::PI / 6.0,  // 30 degrees default
            reverse_entails: false,
            metadata: EntailmentMetadata::default(),
        }
    }
}
```

### HierarchyValidation Struct

```rust
/// Validation result for hierarchical structure
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct HierarchyValidation {
    /// Whether hierarchy is valid
    pub is_valid: bool,

    /// Number of nodes validated
    pub node_count: usize,

    /// Detected issues
    pub issues: Vec<HierarchyIssue>,

    /// Suggested fixes
    pub suggestions: Vec<HierarchySuggestion>,

    /// Validation timestamp
    pub validated_at: DateTime<Utc>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum HierarchyIssue {
    /// Cycle detected in hierarchy
    Cycle { nodes: Vec<NodeId> },

    /// Contradicting entailment relationships
    Contradiction {
        node_a: NodeId,
        node_b: NodeId,
        reason: String,
    },

    /// Missing expected link
    MissingLink {
        parent: NodeId,
        child: NodeId,
        expected_confidence: f32,
    },

    /// Orphan node without ancestors
    OrphanNode { node: NodeId },
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct HierarchySuggestion {
    /// Type of suggested action
    pub action: SuggestionAction,

    /// Nodes affected
    pub nodes: Vec<NodeId>,

    /// Expected improvement
    pub expected_improvement: f32,

    /// Description
    pub description: String,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum SuggestionAction {
    AddLink,
    RemoveLink,
    RecomputeEmbedding,
    MergeNodes,
}
```

### Stub Implementation

```rust
/// Stub implementation that returns neutral results
/// until Module 4 hyperbolic features are complete
pub struct StubEntailmentInterface;

#[async_trait]
impl HyperbolicEntailmentInterface for StubEntailmentInterface {
    async fn check_entailment(
        &self,
        _parent_embedding: &[f32],
        _child_embedding: &[f32],
    ) -> Result<EntailmentResult, EntailmentError> {
        // Return neutral result - no entailment assumed
        Ok(EntailmentResult {
            entails: false,
            confidence: 0.5,  // Neutral confidence
            hyperbolic_distance: 0.0,
            cone_aperture: std::f32::consts::PI / 6.0,
            reverse_entails: false,
            metadata: EntailmentMetadata {
                curvature: -1.0,
                compute_time_us: 0,
                cached: false,
            },
        })
    }

    async fn get_cone_ancestors(
        &self,
        _node_id: &NodeId,
    ) -> Result<Vec<NodeId>, EntailmentError> {
        // Return empty ancestors - no hierarchy computed yet
        Ok(Vec::new())
    }

    async fn validate_hierarchy(
        &self,
        nodes: &[NodeId],
    ) -> Result<HierarchyValidation, EntailmentError> {
        // Return valid result - no issues detected in stub mode
        Ok(HierarchyValidation {
            is_valid: true,
            node_count: nodes.len(),
            issues: Vec::new(),
            suggestions: Vec::new(),
            validated_at: Utc::now(),
        })
    }
}
```

### Error Types

```rust
#[derive(Debug, Clone, thiserror::Error)]
pub enum EntailmentError {
    #[error("Invalid embedding dimension: expected {expected}, got {actual}")]
    InvalidDimension { expected: usize, actual: usize },

    #[error("Node not found: {0}")]
    NodeNotFound(NodeId),

    #[error("Computation failed: {0}")]
    ComputationFailed(String),

    #[error("Hyperbolic layer not available")]
    HyperbolicLayerUnavailable,

    #[error("Feature not implemented: {0}")]
    NotImplemented(String),
}
```

### Module 4 Integration Points

```rust
/// Integration with Module 4 hyperbolic graph layer
///
/// When Module 4 hyperbolic features are complete, this interface
/// will be implemented by the actual hyperbolic graph layer.
///
/// Expected Module 4 dependencies:
/// - PoincareEmbedding: Node embeddings in Poincare ball
/// - HyperbolicDistance: Distance metric in hyperbolic space
/// - ConeMembership: Entailment cone operations
///
/// Module 4 task references:
/// - M04-T27: Cone membership formula verification
/// - M04-T24: Cone membership CUDA kernel
/// - M04-T23: Poincare distance CUDA kernel
pub trait HyperbolicLayerBridge {
    /// Get Poincare embedding for node
    fn get_embedding(&self, node_id: &NodeId) -> Option<&[f32]>;

    /// Check cone membership using verified formula
    fn check_cone_membership(
        &self,
        parent: &[f32],
        child: &[f32],
        aperture: f32,
    ) -> bool;

    /// Compute Poincare distance
    fn poincare_distance(&self, a: &[f32], b: &[f32]) -> f32;
}
```

## Testing Requirements

1. **Unit Tests**
   - Test EntailmentResult default values
   - Test HierarchyValidation construction
   - Test error types
   - Test stub returns neutral confidence (0.5)

2. **Interface Tests**
   - Test trait object compatibility (`dyn HyperbolicEntailmentInterface`)
   - Test async operation compatibility
   - Test Send + Sync bounds

3. **Stub Behavior Tests**
   - `check_entailment` returns neutral (entails=false, confidence=0.5)
   - `get_cone_ancestors` returns empty vector
   - `validate_hierarchy` returns valid with no issues

4. **Serialization Tests**
   - Test EntailmentResult JSON serialization
   - Test HierarchyValidation JSON serialization
   - Test round-trip serialization

---

*Task specification generated for Module 05 - UTL Integration*
