# Context Graph Constitution v6.3.0
# 13-Perspectives Collaboration | E1 Foundation | Native Hooks
# ═══════════════════════════════════════════════════════════════

# CORE PHILOSOPHY: 13 embedders = 13 unique perspectives on every memory
# Each finds what OTHERS MISS. Combined = superior answers.
#
# Example: Query "What databases work with Rust?"
# - E1 finds: "database" or "Rust" semantically
# - E11 finds: "Diesel" (knows Diesel IS a database ORM - E1 missed this)
# - E7 finds: code using sqlx, diesel crates
# - Combined: Better answer than any single embedder

# ═══════════════════════════════════════════════════════════════
# EMBEDDERS (13 Perspectives)
# ═══════════════════════════════════════════════════════════════
embedders:
  # FOUNDATION
  E1: { name: V_meaning, dim: 1024, finds: "Semantic similarity", misses: "Entities, code patterns, causal links" }

  # SEMANTIC ENHANCERS (topic_weight: 1.0)
  E5: { name: V_causality, dim: 768, finds: "Causal chains (why X caused Y)", misses_by_E1: "Direction lost" }
  E6: { name: V_selectivity, sparse: true, finds: "Exact keyword matches", misses_by_E1: "Diluted by averaging" }
  E7: { name: V_correctness, dim: 1536, finds: "Code patterns, function signatures", misses_by_E1: "Treats code as NL" }
  E10: { name: V_multimodality, dim: 768, finds: "Same-goal work (different words)", integration: "Multiplicative boost on E1" }
  E12: { name: V_precision, per_token: true, finds: "Exact phrase matches", use: "Reranking only" }
  E13: { name: V_keyword_precision, sparse: true, finds: "Term expansions (fast→quick)", use: "Stage 1 recall" }

  # RELATIONAL ENHANCERS (topic_weight: 0.5)
  E8: { name: V_connectivity, dim: 384, finds: "Graph structure (X imports Y)" }
  E11: { name: V_factuality, dim: 768, finds: "Entity knowledge (Diesel=database ORM)", model: "KEPLER (RoBERTa-base + TransE)" }

  # TEMPORAL CONTEXT (topic_weight: 0.0, POST-RETRIEVAL ONLY)
  E2: { name: V_freshness, dim: 512, finds: "Recency" }
  E3: { name: V_periodicity, dim: 512, finds: "Time-of-day patterns" }
  E4: { name: V_ordering, dim: 512, finds: "Sequence (before/after)" }

  # STRUCTURAL (topic_weight: 0.5)
  E9: { name: V_robustness, dim: 1024, finds: "Noise-robust structure" }

# ═══════════════════════════════════════════════════════════════
# ARCHITECTURAL RULES (MUST follow)
# ═══════════════════════════════════════════════════════════════
arch_rules:
  # Core
  ARCH-01: "TeleologicalArray is atomic - all 13 embeddings or nothing"
  ARCH-02: "Apples-to-apples only - compare E1↔E1, never E1↔E5"
  ARCH-04: "Temporal (E2-E4) NEVER count toward topics"
  ARCH-05: "All 13 embedders required - missing = fatal"
  ARCH-06: "All memory ops through MCP tools only"
  ARCH-09: "Topic threshold: weighted_agreement >= 2.5"
  ARCH-10: "Divergence detection: SEMANTIC embedders only (E1,E5,E6,E7,E10,E12,E13)"

  # Retrieval Pipeline
  ARCH-12: "E1 is foundation - all retrieval starts with E1"
  ARCH-13: "Strategies: E1Only (default), MultiSpace (E1+enhancers), Pipeline (E13→E1→E12)"
  ARCH-17: "Strong E1 (>0.8): enhancers refine. Weak E1 (<0.4): enhancers broaden"
  ARCH-18: "E5 Causal: asymmetric similarity (cause→effect direction matters)"
  ARCH-21: "Multi-space fusion: use Weighted RRF, not weighted sum"

  # E10 Multiplicative Boost
  ARCH-28: "E10 uses multiplicative boost: E1 * (1 + boost), NOT linear blending"
  ARCH-29: "E10 boost adapts: strong E1=5%, medium=10%, weak=15%"
  ARCH-30: "E10 alignment: >0.5=boost, <0.5=reduce, =0.5=neutral"
  ARCH-33: "E10 multiplier clamped to [0.8, 1.2]"

  # Temporal (POST-RETRIEVAL ONLY)
  ARCH-25: "Temporal boosts POST-retrieval only, NOT in similarity fusion"

# ═══════════════════════════════════════════════════════════════
# ANTI-PATTERNS (FORBIDDEN)
# ═══════════════════════════════════════════════════════════════
forbidden:
  AP-02: "No cross-embedder comparison (E1↔E5)"
  AP-04: "No partial TeleologicalArray"
  AP-05: "No embedding fusion into single vector"
  AP-60: "Temporal (E2-E4) MUST NOT count toward topics"
  AP-73: "Temporal MUST NOT be used in similarity fusion"
  AP-74: "E12 ColBERT: reranking ONLY, not initial retrieval"
  AP-75: "E13 SPLADE: Stage 1 recall ONLY, not final ranking"
  AP-77: "E5 MUST NOT use symmetric cosine - causal is directional"
  AP-79: "MUST NOT use simple weighted sum - use Weighted RRF"
  AP-80: "E10 MUST NOT use linear blending - makes E10 compete with E1"
  AP-84: "E10 MUST NOT override E1 - when E1=0, result=0"

# ═══════════════════════════════════════════════════════════════
# TOPIC SYSTEM
# ═══════════════════════════════════════════════════════════════
topics:
  weighted_agreement:
    formula: "Sum(topic_weight_i × is_clustered_i)"
    threshold: 2.5
    max: 8.5  # 7×1.0 (semantic) + 2×0.5 (relational) + 1×0.5 (structural)
    temporal_contribution: 0.0  # ALWAYS

  categories:
    SEMANTIC: { embedders: [E1,E5,E6,E7,E10,E12,E13], weight: 1.0 }
    RELATIONAL: { embedders: [E8,E11], weight: 0.5 }
    STRUCTURAL: { embedders: [E9], weight: 0.5 }
    TEMPORAL: { embedders: [E2,E3,E4], weight: 0.0 }  # Never for topics

  divergence_detection: "SEMANTIC embedders only"

# ═══════════════════════════════════════════════════════════════
# MCP TOOLS
# ═══════════════════════════════════════════════════════════════
mcp_tools:
  search: [search_graph, search_causes, search_connections, search_by_intent]
  memory: [store_memory, inject_context, get_memetic_status]
  sequence: [get_conversation_context, get_session_timeline, traverse_memory_chain]
  topic: [get_topic_portfolio, get_topic_stability, detect_topics]
  causal: [get_causal_chain, search_causes]
  graph: [get_graph_path, search_connections]
  intent: [search_by_intent, find_contextual_matches, detect_intent_drift]
  entity: [extract_entities, search_by_entities, infer_relationship, find_related_entities, validate_knowledge, get_entity_graph]
  maintenance: [trigger_consolidation, trigger_dream, merge_concepts, forget_concept]

  search_strategies:
    E1Only: "Fast, simple semantic queries"
    MultiSpace: "E1 + enhancers via RRF - use when E1 blind spots matter"
    Pipeline: "E13 recall → E1 dense → E12 rerank - maximum precision"

# ═══════════════════════════════════════════════════════════════
# RETRIEVAL PIPELINE
# ═══════════════════════════════════════════════════════════════
retrieval:
  stages:
    S1: "E13 SPLADE sparse recall → 10K candidates"
    S2: "E1 Matryoshka ANN → 1K candidates"
    S3: "RRF across semantic spaces → 100 candidates"
    S4: "Topic alignment (weighted_agreement >= 2.5) → 50"
    S5: "E12 MaxSim rerank → 10 final results"

  # When to use which enhancer
  use_E5: "Causal queries (why, what caused)"
  use_E7: "Code queries (implementations, functions)"
  use_E10: "Intent queries (same goal, similar purpose)"
  use_E11: "Entity queries (specific named things)"
  use_E6_E13: "Keyword queries (exact terms, jargon)"

# ═══════════════════════════════════════════════════════════════
# MEMORY SOURCES
# ═══════════════════════════════════════════════════════════════
memory_sources:
  HookDescription: "Claude's description of tool use"
  ClaudeResponse: "Session summaries, significant responses"
  MDFileChunk: "Markdown file chunks (200 words, 50 overlap)"

# ═══════════════════════════════════════════════════════════════
# DREAM CONSOLIDATION
# ═══════════════════════════════════════════════════════════════
dream:
  trigger: "entropy > 0.7 AND churn > 0.5"
  nrem: "Hebbian replay - strengthen high-importance edges"
  rem: "Hyperbolic random walk - discover blind spots"

# ═══════════════════════════════════════════════════════════════
# KEY THRESHOLDS
# ═══════════════════════════════════════════════════════════════
thresholds:
  topic: 2.5           # weighted_agreement for topic detection
  high_sim: 0.75       # High similarity
  low_sim: 0.30        # Divergence threshold
  duplicate: 0.90      # Duplicate detection
  entropy_dream: 0.70  # Dream trigger
  churn_dream: 0.50    # Dream trigger

# ═══════════════════════════════════════════════════════════════
# HOOKS (Native Claude Code)
# ═══════════════════════════════════════════════════════════════
hooks:
  config: ".claude/settings.json"
  SessionStart: "Load topic portfolio, warm indexes"
  UserPromptSubmit: "Embed prompt, search, detect divergence, inject context"
  PreToolUse: "Inject brief relevant context"
  PostToolUse: "Capture + embed as HookDescription"
  Stop: "Capture response summary"
  SessionEnd: "Persist state, run HDBSCAN, check dream triggers"
