# TASK-M02-004: Define ValidationError Enum

```xml
<task_spec id="TASK-M02-004" version="1.0">
<metadata>
  <title>Define ValidationError Enum</title>
  <status>ready</status>
  <layer>foundation</layer>
  <module>module-02</module>
  <sequence>4</sequence>
  <priority>high</priority>
  <estimated_hours>1</estimated_hours>
  <implements>
    <item>TECH-CORE-002 Section 2.1: MemoryNode validation errors</item>
  </implements>
  <depends_on>
    <!-- No dependencies - this is a foundation task -->
  </depends_on>
  <estimated_complexity>low</estimated_complexity>
</metadata>

<context>
ValidationError is an error enum representing all possible validation failures when creating or modifying a MemoryNode. It provides clear, actionable error messages with context about what failed and why. This enum uses thiserror for ergonomic error derivation and integrates with Rust's standard error handling patterns.
</context>

<input_context_files>
  <file purpose="Constitution reference for error handling patterns">docs2/constitution.yaml</file>
</input_context_files>

<prerequisites>
  <check>crates/context-graph-core directory exists</check>
  <check>thiserror crate is in Cargo.toml dependencies</check>
</prerequisites>

<scope>
  <in_scope>
    - ValidationError enum with 4 variants
    - InvalidEmbeddingDimension { expected: usize, actual: usize }
    - OutOfBounds { field: String, value: f64, min: f64, max: f64 }
    - ContentTooLarge { size: usize, max_size: usize }
    - EmbeddingNotNormalized { magnitude: f64 }
    - thiserror derive for Error trait
    - Human-readable Display messages
    - Unit tests for error messages
  </in_scope>
  <out_of_scope>
    - MemoryNode::validate() implementation (handled in TASK-M02-006)
    - StorageError enum (handled in TASK-M02-025)
  </out_of_scope>
</scope>

<definition_of_done>
  <signatures>
    <signature file="crates/context-graph-core/src/memory_node.rs">
use thiserror::Error;

/// Errors that can occur during MemoryNode validation.
#[derive(Debug, Clone, Error, PartialEq)]
pub enum ValidationError {
    /// Embedding vector has incorrect dimensions.
    #[error("Invalid embedding dimension: expected {expected}, got {actual}")]
    InvalidEmbeddingDimension {
        expected: usize,
        actual: usize,
    },

    /// A numeric field is outside its valid range.
    #[error("Field '{field}' value {value} is out of bounds [{min}, {max}]")]
    OutOfBounds {
        field: String,
        value: f64,
        min: f64,
        max: f64,
    },

    /// Content exceeds maximum allowed size.
    #[error("Content size {size} bytes exceeds maximum allowed {max_size} bytes")]
    ContentTooLarge {
        size: usize,
        max_size: usize,
    },

    /// Embedding vector is not normalized (magnitude != 1.0).
    #[error("Embedding not normalized: magnitude is {magnitude:.6}, expected ~1.0")]
    EmbeddingNotNormalized {
        magnitude: f64,
    },
}
    </signature>
  </signatures>

  <constraints>
    - Must derive thiserror::Error for standard error trait implementation
    - Error messages must be human-readable and include all relevant context
    - Use f64 for numeric values in OutOfBounds to handle both f32 importance and f32 valence
    - Clone derive required for error propagation patterns
    - PartialEq derive required for testing
    - Follow AP-009: Never allow NaN/Infinity (validation prevents these)
  </constraints>

  <verification>
    - cargo build --package context-graph-core compiles without errors
    - cargo test --package context-graph-core validation passes all tests
    - cargo clippy --package context-graph-core shows no warnings
    - Error messages display correctly when printed
  </verification>
</definition_of_done>

<pseudo_code>
memory_node.rs:
  // Module documentation
  // Imports: thiserror::Error

  // ValidationError enum with thiserror derives

  #[derive(Debug, Clone, Error, PartialEq)]
  pub enum ValidationError:
    #[error("Invalid embedding dimension: expected {expected}, got {actual}")]
    InvalidEmbeddingDimension { expected: usize, actual: usize }

    #[error("Field '{field}' value {value} is out of bounds [{min}, {max}]")]
    OutOfBounds { field: String, value: f64, min: f64, max: f64 }

    #[error("Content size {size} bytes exceeds maximum {max_size} bytes")]
    ContentTooLarge { size: usize, max_size: usize }

    #[error("Embedding not normalized: magnitude is {magnitude:.6}, expected ~1.0")]
    EmbeddingNotNormalized { magnitude: f64 }

#[cfg(test)]
mod validation_tests:
  test_embedding_dimension_error_message()
  test_out_of_bounds_error_message()
  test_content_too_large_error_message()
  test_embedding_not_normalized_error_message()
  test_error_trait_implementation()
  test_clone_and_partial_eq()
</pseudo_code>

<files_to_create>
  <file path="crates/context-graph-core/src/memory_node.rs">ValidationError enum (MemoryNode added in TASK-M02-005)</file>
</files_to_create>

<files_to_modify>
  <file path="crates/context-graph-core/src/lib.rs">Add pub mod memory_node; and re-export ValidationError</file>
</files_to_modify>

<validation_criteria>
  <criterion>ValidationError enum compiles with 4 variants</criterion>
  <criterion>InvalidEmbeddingDimension displays expected and actual dimensions</criterion>
  <criterion>OutOfBounds displays field name, value, and valid range</criterion>
  <criterion>ContentTooLarge displays current size and maximum size</criterion>
  <criterion>EmbeddingNotNormalized displays magnitude with 6 decimal precision</criterion>
  <criterion>All errors implement std::error::Error trait via thiserror</criterion>
  <criterion>Errors are Clone and PartialEq for testing</criterion>
  <criterion>Error messages are actionable (user knows what to fix)</criterion>
</validation_criteria>

<test_commands>
  <command>cargo build --package context-graph-core</command>
  <command>cargo test --package context-graph-core validation -- --nocapture</command>
  <command>cargo clippy --package context-graph-core -- -D warnings</command>
</test_commands>
</task_spec>
```

## Implementation Notes

### Error Message Guidelines
Per constitution.yaml, error messages should be:
- Human-readable
- Include all relevant context
- Be actionable (tell user what to fix)

### Validation Thresholds (Reference for TASK-M02-006)
- Embedding dimension: 1536 (per PRD)
- Importance range: [0.0, 1.0]
- Emotional valence range: [-1.0, 1.0]
- Content max size: 1MB (1,048,576 bytes)
- Embedding normalization tolerance: magnitude ∈ [0.99, 1.01]

### Anti-Pattern AP-009 Compliance
"NaN/Infinity in UTL → clamp to valid range"
ValidationError helps enforce this by rejecting invalid values before they enter the system.

---

*Task ID: TASK-M02-004*
*Module: 02 - Core Infrastructure*
*Layer: Foundation*
