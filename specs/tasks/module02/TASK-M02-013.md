# TASK-M02-013: Create Storage Crate Structure

## Task Metadata
| Field | Value |
|-------|-------|
| **Status** | ✅ Complete |
| **Layer** | logic |
| **Priority** | critical |
| **Estimated Hours** | 1.5 |
| **Depends On** | TASK-M02-006 (MemoryNode methods) ✅ COMPLETE |
| **Completed** | 2025-12-31 |
| **Verified By** | Sherlock-Holmes forensic verification |

---

## Context

This task creates `crates/context-graph-storage/` - the RocksDB-based persistence layer for MemoryNodes and GraphEdges. This is the first Logic Layer task, unlocking TASK-M02-014 through TASK-M02-018.

**Why RocksDB**: Per constitution.yaml `db.vector: faiss_gpu`, but the actual node/edge storage uses RocksDB for fast key-value operations with column families.

---

## Current Codebase State (Verified 2025-12-31)

### Existing Structure
```
crates/
├── context-graph-core/      ← EXISTS, 379+ tests passing
│   ├── Cargo.toml           ← Uses workspace dependencies
│   └── src/
│       ├── lib.rs           ← Exports: Config, CoreError, CoreResult, Domain, EdgeType, NeurotransmitterWeights
│       ├── marblestone.rs   ← Contains: Domain, EdgeType, NeurotransmitterWeights
│       └── types/
│           ├── mod.rs       ← Exports: graph_edge::*, johari::*, memory_node::*, nervous::*, pulse::*, utl::*
│           ├── johari.rs    ← Contains: JohariQuadrant, Modality, TransitionTrigger, JohariTransition
│           ├── memory_node.rs ← Contains: NodeId, EmbeddingVector, ValidationError, MemoryNode, NodeMetadata
│           └── graph_edge.rs  ← Contains: EdgeId, GraphEdge (13 Marblestone fields)
├── context-graph-cuda/      ← EXISTS (stub)
├── context-graph-embeddings/ ← EXISTS (stub)
└── context-graph-mcp/       ← EXISTS (stub)
```

**context-graph-storage NOW EXISTS - created 2025-12-31.**

### Workspace Cargo.toml (Root)
Located at `/home/cabdru/contextgraph/Cargo.toml`:
- Uses `resolver = "2"`
- Members: `crates/context-graph-mcp`, `crates/context-graph-core`, `crates/context-graph-cuda`, `crates/context-graph-embeddings`
- **You MUST add `crates/context-graph-storage` to members**

### Available Workspace Dependencies
```toml
[workspace.dependencies]
tokio = { version = "1.35", features = ["full"] }
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
bincode = "1.3"
thiserror = "1.0"
uuid = { version = "1.6", features = ["v4", "serde"] }
chrono = { version = "0.4", features = ["serde"] }
context-graph-core = { path = "crates/context-graph-core" }
```

**rocksdb is NOT in workspace dependencies - add directly to storage crate.**

---

## Exact Implementation

### Step 1: Create Directory Structure

```bash
mkdir -p crates/context-graph-storage/src
```

### Step 2: Create Cargo.toml

**File**: `crates/context-graph-storage/Cargo.toml`

```toml
[package]
name = "context-graph-storage"
version = "0.1.0"
edition = "2021"
description = "Storage layer for Context Graph with RocksDB backend"
license = "MIT"

[dependencies]
context-graph-core = { path = "../context-graph-core" }
rocksdb = "0.22"
bincode = "1.3"
thiserror = "1.0"
uuid = { version = "1.6", features = ["v4", "serde"] }
chrono = { version = "0.4", features = ["serde"] }
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
tokio = { version = "1.35", features = ["sync"] }

[dev-dependencies]
tempfile = "3.10"
```

### Step 3: Create lib.rs

**File**: `crates/context-graph-storage/src/lib.rs`

```rust
//! Context Graph Storage Layer
//!
//! Provides persistent storage for the Context Graph system
//! using RocksDB as the underlying storage engine.
//!
//! # Architecture
//! - `memex`: Storage trait abstraction (Memex = "memory index")
//! - `rocksdb_backend`: RocksDB implementation
//! - `column_families`: Column family definitions per Johari quadrant
//! - `serialization`: Bincode serialization utilities
//! - `indexes`: Secondary index operations (tags, temporal, sources)
//!
//! # Constitution Reference
//! - db.dev: sqlite (ghost phase), db.prod: postgres16+
//! - db.vector: faiss_gpu (separate from RocksDB node storage)
//! - SEC-06: Soft delete 30-day recovery

pub mod column_families;
pub mod indexes;
pub mod memex;
pub mod rocksdb_backend;
pub mod serialization;

// Re-export core types for storage consumers
pub use context_graph_core::marblestone::{Domain, EdgeType, NeurotransmitterWeights};
pub use context_graph_core::types::{
    EdgeId, EmbeddingVector, GraphEdge, JohariQuadrant, MemoryNode, Modality, NodeId,
    NodeMetadata, ValidationError,
};
```

### Step 4: Create Placeholder Modules

**File**: `crates/context-graph-storage/src/memex.rs`
```rust
//! Memex storage trait abstraction.
//!
//! The Memex trait defines the storage contract for MemoryNode and GraphEdge
//! persistence. Named after Vannevar Bush's conceptual memory machine.
//!
//! # Implementors
//! - `RocksDbMemex`: Production RocksDB implementation (TASK-M02-016)
//!
//! # Constitution Reference
//! - SEC-06: All delete operations must be soft deletes with 30-day recovery
//! - AP-010: store_memory requires rationale

// TODO: Implement Memex trait in TASK-M02-026
// Required methods:
// - store_node(node: &MemoryNode) -> Result<NodeId, StorageError>
// - get_node(id: NodeId) -> Result<Option<MemoryNode>, StorageError>
// - update_node(node: &MemoryNode) -> Result<(), StorageError>
// - delete_node(id: NodeId, soft: bool) -> Result<(), StorageError>
// - store_edge(edge: &GraphEdge) -> Result<EdgeId, StorageError>
// - get_edge(id: EdgeId) -> Result<Option<GraphEdge>, StorageError>
// - get_edges_from(node_id: NodeId) -> Result<Vec<GraphEdge>, StorageError>
// - get_edges_to(node_id: NodeId) -> Result<Vec<GraphEdge>, StorageError>
```

**File**: `crates/context-graph-storage/src/rocksdb_backend.rs`
```rust
//! RocksDB storage backend implementation.
//!
//! Provides persistent storage using RocksDB with column families
//! for Johari quadrant separation and efficient indexing.
//!
//! # Performance Targets (constitution.yaml)
//! - inject_context: p95 < 25ms, p99 < 50ms
//! - faiss_1M_k100: < 2ms (vector search, separate system)
//!
//! # Column Families
//! See `column_families.rs` for definitions.

// TODO: Implement in TASK-M02-016 (Open/Close), TASK-M02-017 (Node CRUD), TASK-M02-018 (Edge CRUD)
```

**File**: `crates/context-graph-storage/src/column_families.rs`
```rust
//! RocksDB column family definitions.
//!
//! Column families provide logical separation of data types and
//! enable efficient range queries within each category.
//!
//! # Column Families
//! | Name | Purpose | Key Format |
//! |------|---------|------------|
//! | nodes | Primary node storage | NodeId (UUID bytes) |
//! | edges | Graph edge storage | EdgeId (UUID bytes) |
//! | embeddings | Embedding vectors | NodeId (UUID bytes) |
//! | metadata | Node metadata | NodeId (UUID bytes) |
//! | johari_open | Open quadrant index | NodeId |
//! | johari_hidden | Hidden quadrant index | NodeId |
//! | johari_blind | Blind quadrant index | NodeId |
//! | johari_unknown | Unknown quadrant index | NodeId |
//! | temporal | Time-based index | timestamp_ms:NodeId |
//! | tags | Tag index | tag:NodeId |
//! | sources | Source index | source_uri:NodeId |
//! | system | System metadata | key string |

// TODO: Implement get_column_family_descriptors() in TASK-M02-015
```

**File**: `crates/context-graph-storage/src/serialization.rs`
```rust
//! Bincode serialization utilities.
//!
//! Provides efficient binary serialization for MemoryNode, GraphEdge,
//! and EmbeddingVector using bincode.
//!
//! # Performance
//! - MemoryNode serialized: ~6.5KB average (with 1536D embedding)
//! - GraphEdge serialized: ~200 bytes
//! - Round-trip overhead: < 100μs

// TODO: Implement in TASK-M02-014
// Required functions:
// - serialize_node(node: &MemoryNode) -> Result<Vec<u8>, StorageError>
// - deserialize_node(bytes: &[u8]) -> Result<MemoryNode, StorageError>
// - serialize_edge(edge: &GraphEdge) -> Result<Vec<u8>, StorageError>
// - deserialize_edge(bytes: &[u8]) -> Result<GraphEdge, StorageError>
// - serialize_embedding(embedding: &EmbeddingVector) -> Result<Vec<u8>, StorageError>
// - deserialize_embedding(bytes: &[u8]) -> Result<EmbeddingVector, StorageError>
```

**File**: `crates/context-graph-storage/src/indexes.rs`
```rust
//! Secondary index operations.
//!
//! Provides query capabilities beyond primary key lookup:
//! - Query by Johari quadrant
//! - Query by tag
//! - Query by time range
//! - Query by source
//!
//! # Index Strategy
//! Indexes are maintained as separate column families with
//! composite keys enabling efficient range scans.

// TODO: Implement in TASK-M02-023
// Required functions:
// - get_nodes_by_quadrant(quadrant: JohariQuadrant) -> Result<Vec<NodeId>, StorageError>
// - get_nodes_by_tag(tag: &str) -> Result<Vec<NodeId>, StorageError>
// - get_nodes_in_time_range(start: DateTime<Utc>, end: DateTime<Utc>) -> Result<Vec<NodeId>, StorageError>
```

### Step 5: Update Workspace Cargo.toml

**File**: `/home/cabdru/contextgraph/Cargo.toml`

Add `"crates/context-graph-storage"` to the workspace members array.

---

## Verification Commands

Run these commands in order. All MUST pass.

```bash
# 1. Verify directory structure exists
ls -la crates/context-graph-storage/
ls -la crates/context-graph-storage/src/

# 2. Build storage crate (confirms compilation)
cargo build --package context-graph-storage

# 3. Run tests (even with no tests, confirms setup)
cargo test --package context-graph-storage

# 4. Generate documentation (confirms doc comments parse)
cargo doc --package context-graph-storage --no-deps

# 5. Verify all modules are importable
cargo check --package context-graph-storage
```

**Expected Output for cargo build**:
```
   Compiling context-graph-storage v0.1.0 (/home/cabdru/contextgraph/crates/context-graph-storage)
    Finished `dev` profile [unoptimized + debuginfo] target(s) in X.XXs
```

---

## Full State Verification Protocol

### Source of Truth
The source of truth is the filesystem and cargo toolchain:
1. `crates/context-graph-storage/` directory with all files
2. `Cargo.toml` (root) includes storage in workspace members
3. `cargo build --package context-graph-storage` succeeds
4. `cargo test --package context-graph-storage` succeeds

### Verification Steps

**BEFORE Implementation - Capture State:**
```bash
# Document non-existence
ls -la crates/ 2>&1 | grep storage || echo "context-graph-storage DOES NOT EXIST"
grep "context-graph-storage" Cargo.toml || echo "NOT in workspace members"
```

**AFTER Implementation - Verify State:**
```bash
# 1. Directory exists with all files
ls crates/context-graph-storage/src/*.rs
# Expected: column_families.rs  indexes.rs  lib.rs  memex.rs  rocksdb_backend.rs  serialization.rs

# 2. Workspace includes storage
grep "context-graph-storage" Cargo.toml
# Expected: "crates/context-graph-storage",

# 3. Cargo build works
cargo build --package context-graph-storage 2>&1 | tail -3
# Expected: Finished `dev` profile...

# 4. Re-exports work
echo 'use context_graph_storage::{MemoryNode, GraphEdge, JohariQuadrant};' | cargo check --stdin --package context-graph-storage 2>&1 || cargo build --package context-graph-storage
```

### Edge Cases to Test Manually

1. **Empty crate builds**: Run `cargo build --package context-graph-storage` - must compile with empty placeholder modules.

2. **Re-exports resolve**: The `pub use` statements in `lib.rs` must correctly import from `context_graph_core`.

3. **RocksDB links**: `rocksdb = "0.22"` dependency must download and link (may require system libs on first build).

---

## Common Failure Modes

| Error | Cause | Fix |
|-------|-------|-----|
| `error[E0432]: unresolved import` | Wrong path in `pub use` | Check `context_graph_core::types::*` exports |
| `can't find crate for context_graph_storage` | Not in workspace | Add to `Cargo.toml` members |
| `failed to select a version for rocksdb` | Missing system deps | Install `libclang-dev` on Linux |
| `error: expected item, found keyword` | Syntax error in placeholder | Check for trailing content after TODO |

---

## Files Created Checklist

- [ ] `crates/context-graph-storage/Cargo.toml`
- [ ] `crates/context-graph-storage/src/lib.rs`
- [ ] `crates/context-graph-storage/src/memex.rs`
- [ ] `crates/context-graph-storage/src/rocksdb_backend.rs`
- [ ] `crates/context-graph-storage/src/column_families.rs`
- [ ] `crates/context-graph-storage/src/serialization.rs`
- [ ] `crates/context-graph-storage/src/indexes.rs`
- [ ] Updated `/home/cabdru/contextgraph/Cargo.toml` (workspace members)

---

## Definition of Done

1. ✅ All 7 files created with exact content shown above
2. ✅ `cargo build --package context-graph-storage` compiles with 0 errors
3. ✅ `cargo test --package context-graph-storage` runs (0 tests is OK)
4. ✅ `cargo doc --package context-graph-storage --no-deps` generates docs
5. ✅ Re-exports from `context_graph_core` resolve correctly

---

## Final Sherlock-Holmes Verification

After completing this task, spawn a `sherlock-holmes` subagent to verify:

```
INVESTIGATION MANDATE:
1. Verify crates/context-graph-storage/ exists with all 7 files
2. Run: cargo build --package context-graph-storage
3. Run: cargo test --package context-graph-storage
4. Run: cargo clippy --package context-graph-storage -- -D warnings
5. Confirm Cargo.toml workspace includes context-graph-storage
6. Test that imports work: MemoryNode, GraphEdge, JohariQuadrant from storage crate
7. Report any failures with exact error messages
```

**Evidence of Success**: Sherlock must provide terminal output showing:
- Build succeeded
- 0 clippy warnings
- All re-exports resolve

---

## Next Tasks (Unlocked by This Task)

| Task | Description |
|------|-------------|
| TASK-M02-014 | Bincode serialization functions |
| TASK-M02-015 | Column family descriptors |
| TASK-M02-025 | StorageError enum |

---

*Task ID: TASK-M02-013*
*Module: 02 - Core Infrastructure*
*Layer: Logic*
*Last Updated: 2025-12-31*
