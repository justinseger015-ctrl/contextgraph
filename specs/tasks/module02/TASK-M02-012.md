# TASK-M02-012: Implement Johari Transition Logic

```xml
<task_spec id="TASK-M02-012" version="1.0">
<metadata>
  <title>Implement Johari Transition Logic</title>
  <status>blocked</status>
  <layer>foundation</layer>
  <module>module-02</module>
  <sequence>12</sequence>
  <priority>high</priority>
  <estimated_hours>2</estimated_hours>
  <implements>
    <item>TECH-CORE-002 Section 2.2: Johari transition specification</item>
  </implements>
  <depends_on>
    <task_ref>TASK-M02-001</task_ref>
  </depends_on>
  <estimated_complexity>medium</estimated_complexity>
</metadata>

<context>
This task implements the state machine logic for transitioning MemoryNodes between Johari quadrants. Each quadrant has specific allowed transitions triggered by different events (explicit sharing, self-recognition, pattern discovery, etc.). This enables the dynamic reclassification of knowledge as the agent's awareness changes.
</context>

<input_context_files>
  <file purpose="JohariQuadrant enum">crates/context-graph-core/src/johari.rs</file>
  <file purpose="PRD reference for quadrant transitions">docs2/contextprd.md</file>
</input_context_files>

<prerequisites>
  <check>TASK-M02-001 (JohariQuadrant enum) is complete</check>
</prerequisites>

<scope>
  <in_scope>
    - TransitionTrigger enum with 6 variants
    - JohariTransition struct with from, to, trigger, timestamp fields
    - JohariQuadrant::valid_transitions() method
    - JohariQuadrant::can_transition_to() method
    - JohariTransition::new() constructor
    - Unit tests for all transition rules
  </in_scope>
  <out_of_scope>
    - Automatic transition detection logic (handled in higher-level modules)
    - Dream-based transitions (handled in dream module)
  </out_of_scope>
</scope>

<definition_of_done>
  <signatures>
    <signature file="crates/context-graph-core/src/johari.rs">
use chrono::{DateTime, Utc};

/// Triggers that can cause a Johari quadrant transition.
#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash, Serialize, Deserialize)]
#[serde(rename_all = "snake_case")]
pub enum TransitionTrigger {
    /// User explicitly shares hidden knowledge (Hidden → Open).
    ExplicitShare,

    /// Agent recognizes pattern in blind spot (Blind → Open/Hidden).
    SelfRecognition,

    /// Dream consolidation discovers new patterns (Unknown → various).
    PatternDiscovery,

    /// User marks knowledge as private (Open → Hidden).
    Privatize,

    /// External observation reveals blind spot (Unknown → Blind).
    ExternalObservation,

    /// Dream consolidation surfaces unknown knowledge (Unknown → Open/Hidden).
    DreamConsolidation,
}

/// Record of a quadrant transition.
#[derive(Debug, Clone, PartialEq, Serialize, Deserialize)]
pub struct JohariTransition {
    /// Starting quadrant.
    pub from: JohariQuadrant,

    /// Ending quadrant.
    pub to: JohariQuadrant,

    /// What triggered this transition.
    pub trigger: TransitionTrigger,

    /// When this transition occurred.
    pub timestamp: DateTime&lt;Utc&gt;,
}

impl JohariTransition {
    /// Create a new transition record with current timestamp.
    pub fn new(from: JohariQuadrant, to: JohariQuadrant, trigger: TransitionTrigger) -> Self;
}

impl JohariQuadrant {
    /// Get all valid transitions from this quadrant.
    ///
    /// Returns a slice of (target_quadrant, trigger) pairs.
    pub fn valid_transitions(&amp;self) -> &amp;'static [(JohariQuadrant, TransitionTrigger)];

    /// Check if a transition to the target quadrant is valid.
    pub fn can_transition_to(&amp;self, target: JohariQuadrant) -> bool;

    /// Attempt to transition to a target quadrant with the given trigger.
    /// Returns Ok(transition) if valid, Err(message) if invalid.
    pub fn transition_to(
        &amp;self,
        target: JohariQuadrant,
        trigger: TransitionTrigger,
    ) -> Result&lt;JohariTransition, String&gt;;
}

impl TransitionTrigger {
    /// Returns a description of this trigger.
    pub fn description(&amp;self) -> &amp;'static str;
}
    </signature>
  </signatures>

  <constraints>
    - Transition rules must match specification exactly
    - Open can only transition to Hidden (via Privatize)
    - Hidden can only transition to Open (via ExplicitShare)
    - Blind can transition to Open (via SelfRecognition) or Hidden (via SelfRecognition)
    - Unknown can transition to Open, Hidden, or Blind (via various triggers)
    - No self-transitions allowed (from == to is invalid)
    - Invalid transitions return error with descriptive message
  </constraints>

  <verification>
    - cargo build --package context-graph-core compiles without errors
    - cargo test --package context-graph-core johari_transition passes all tests
    - cargo clippy --package context-graph-core shows no warnings
  </verification>
</definition_of_done>

<pseudo_code>
johari.rs (append after JohariQuadrant):
  // TransitionTrigger enum
  #[derive(Debug, Clone, Copy, PartialEq, Eq, Hash, Serialize, Deserialize)]
  #[serde(rename_all = "snake_case")]
  pub enum TransitionTrigger {
    ExplicitShare,
    SelfRecognition,
    PatternDiscovery,
    Privatize,
    ExternalObservation,
    DreamConsolidation,
  }

  impl TransitionTrigger:
    fn description(&amp;self):
      match self:
        ExplicitShare => "User explicitly shares hidden knowledge"
        SelfRecognition => "Agent recognizes pattern in blind spot"
        PatternDiscovery => "Dream consolidation discovers new patterns"
        Privatize => "User marks knowledge as private"
        ExternalObservation => "External observation reveals blind spot"
        DreamConsolidation => "Dream consolidation surfaces unknown knowledge"

  // JohariTransition struct
  #[derive(Debug, Clone, PartialEq, Serialize, Deserialize)]
  pub struct JohariTransition {
    pub from: JohariQuadrant,
    pub to: JohariQuadrant,
    pub trigger: TransitionTrigger,
    pub timestamp: DateTime&lt;Utc&gt;,
  }

  impl JohariTransition:
    fn new(from, to, trigger):
      Self { from, to, trigger, timestamp: Utc::now() }

  // Add to JohariQuadrant impl
  impl JohariQuadrant:
    fn valid_transitions(&amp;self):
      // Static arrays for each quadrant
      static OPEN_TRANSITIONS: [(JohariQuadrant, TransitionTrigger); 1] =
        [(Hidden, Privatize)];
      static HIDDEN_TRANSITIONS: [(JohariQuadrant, TransitionTrigger); 1] =
        [(Open, ExplicitShare)];
      static BLIND_TRANSITIONS: [(JohariQuadrant, TransitionTrigger); 2] =
        [(Open, SelfRecognition), (Hidden, SelfRecognition)];
      static UNKNOWN_TRANSITIONS: [(JohariQuadrant, TransitionTrigger); 4] =
        [(Open, DreamConsolidation), (Hidden, DreamConsolidation),
         (Blind, ExternalObservation), (Open, PatternDiscovery)];

      match self:
        Open => &amp;OPEN_TRANSITIONS
        Hidden => &amp;HIDDEN_TRANSITIONS
        Blind => &amp;BLIND_TRANSITIONS
        Unknown => &amp;UNKNOWN_TRANSITIONS

    fn can_transition_to(&amp;self, target):
      if self == target: return false  // No self-transitions
      self.valid_transitions().iter().any(|(t, _)| t == target)

    fn transition_to(&amp;self, target, trigger):
      if self == target:
        return Err("Cannot transition to same quadrant")
      // Check if transition is valid for this trigger
      let valid = self.valid_transitions().iter()
        .any(|(t, tr)| t == target &amp;&amp; tr == trigger);
      if valid:
        Ok(JohariTransition::new(*self, target, trigger))
      else:
        Err(format!("Invalid transition: {:?} -> {:?} via {:?}", self, target, trigger))

#[cfg(test)]
mod transition_tests:
  test_open_to_hidden_via_privatize()
  test_open_cannot_go_to_blind()
  test_hidden_to_open_via_explicit_share()
  test_blind_to_open_via_self_recognition()
  test_blind_to_hidden_via_self_recognition()
  test_unknown_to_open_via_dream()
  test_unknown_to_blind_via_observation()
  test_no_self_transitions()
  test_invalid_trigger_rejected()
  test_transition_creates_record()
</pseudo_code>

<files_to_create>
  <!-- File already exists from TASK-M02-001 -->
</files_to_create>

<files_to_modify>
  <file path="crates/context-graph-core/src/johari.rs">Add TransitionTrigger enum, JohariTransition struct, and transition methods</file>
  <file path="crates/context-graph-core/src/lib.rs">Re-export TransitionTrigger, JohariTransition</file>
</files_to_modify>

<validation_criteria>
  <criterion>TransitionTrigger enum has 6 variants</criterion>
  <criterion>JohariTransition struct has from, to, trigger, timestamp fields</criterion>
  <criterion>valid_transitions(Open) returns [(Hidden, Privatize)]</criterion>
  <criterion>valid_transitions(Hidden) returns [(Open, ExplicitShare)]</criterion>
  <criterion>valid_transitions(Blind) returns transitions to Open and Hidden via SelfRecognition</criterion>
  <criterion>valid_transitions(Unknown) returns transitions to Open, Hidden, Blind via various triggers</criterion>
  <criterion>can_transition_to() returns false for same quadrant (no self-transitions)</criterion>
  <criterion>transition_to() returns Ok(JohariTransition) for valid transitions</criterion>
  <criterion>transition_to() returns Err with descriptive message for invalid transitions</criterion>
</validation_criteria>

<test_commands>
  <command>cargo build --package context-graph-core</command>
  <command>cargo test --package context-graph-core johari_transition -- --nocapture</command>
  <command>cargo clippy --package context-graph-core -- -D warnings</command>
</test_commands>
</task_spec>
```

## Implementation Notes

### Johari Transition State Machine

```
┌─────────────────────────────────────────────────────────────┐
│                      JOHARI TRANSITIONS                      │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   OPEN ◄───── ExplicitShare ───── HIDDEN                    │
│     │                                │                       │
│     └─────── Privatize ──────────────┘                       │
│                                                              │
│   BLIND ────┬── SelfRecognition ────► OPEN                  │
│             └── SelfRecognition ────► HIDDEN                │
│                                                              │
│   UNKNOWN ──┬── DreamConsolidation ─► OPEN                  │
│             ├── DreamConsolidation ─► HIDDEN                │
│             ├── ExternalObservation ► BLIND                 │
│             └── PatternDiscovery ───► OPEN                  │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### Transition Rules Summary
| From | To | Trigger |
|------|-----|---------|
| Open | Hidden | Privatize |
| Hidden | Open | ExplicitShare |
| Blind | Open | SelfRecognition |
| Blind | Hidden | SelfRecognition |
| Unknown | Open | DreamConsolidation, PatternDiscovery |
| Unknown | Hidden | DreamConsolidation |
| Unknown | Blind | ExternalObservation |

---

*Task ID: TASK-M02-012*
*Module: 02 - Core Infrastructure*
*Layer: Foundation*
