# TASK-M02-008: Define NeurotransmitterWeights Struct (Marblestone)

```xml
<task_spec id="TASK-M02-008" version="1.0">
<metadata>
  <title>Define NeurotransmitterWeights Struct (Marblestone)</title>
  <status>blocked</status>
  <layer>foundation</layer>
  <module>module-02</module>
  <sequence>8</sequence>
  <priority>high</priority>
  <estimated_hours>2</estimated_hours>
  <implements>
    <item>TECH-CORE-002 Section 2.5: NeurotransmitterWeights specification</item>
    <item>Marblestone Integration Spec: NT edge modulation</item>
  </implements>
  <depends_on>
    <task_ref>TASK-M02-007</task_ref>
  </depends_on>
  <estimated_complexity>medium</estimated_complexity>
</metadata>

<context>
NeurotransmitterWeights implements the Marblestone architecture's neurotransmitter-inspired edge modulation system. It contains three weight components (excitatory, inhibitory, modulatory) that influence edge traversal behavior. Domain-specific profiles enable context-aware graph traversal, mimicking how biological neural networks adapt signal propagation based on context.
</context>

<input_context_files>
  <file purpose="Domain enum dependency">crates/context-graph-core/src/marblestone.rs</file>
  <file purpose="Constitution reference for NT weights">docs2/constitution.yaml</file>
  <file purpose="PRD reference for weight formula">docs2/contextprd.md</file>
</input_context_files>

<prerequisites>
  <check>TASK-M02-007 (Domain enum) is complete</check>
</prerequisites>

<scope>
  <in_scope>
    - NeurotransmitterWeights struct with 3 f32 fields
    - excitatory: strengthening signal [0.0, 1.0]
    - inhibitory: weakening signal [0.0, 1.0]
    - modulatory: domain-adjustment signal [0.0, 1.0]
    - for_domain() factory method with domain-specific profiles
    - compute_effective_weight() method
    - validate() method
    - Default trait implementation
    - Serde Serialize/Deserialize derives
    - Unit tests for all domain profiles
  </in_scope>
  <out_of_scope>
    - GraphEdge struct (handled in TASK-M02-010)
    - Edge traversal logic (handled in TASK-M02-011)
  </out_of_scope>
</scope>

<definition_of_done>
  <signatures>
    <signature file="crates/context-graph-core/src/marblestone.rs">
/// Neurotransmitter-inspired weight modulation for graph edges.
///
/// Based on the Marblestone architecture, edges are modulated by three signals:
/// - Excitatory: Strengthens connections (like glutamate)
/// - Inhibitory: Weakens connections (like GABA)
/// - Modulatory: Context-dependent adjustment (like dopamine/serotonin)
#[derive(Debug, Clone, Copy, PartialEq, Serialize, Deserialize)]
pub struct NeurotransmitterWeights {
    /// Excitatory signal strength [0.0, 1.0]. Higher = stronger connection.
    pub excitatory: f32,
    /// Inhibitory signal strength [0.0, 1.0]. Higher = weaker connection.
    pub inhibitory: f32,
    /// Modulatory signal strength [0.0, 1.0]. Context-dependent adjustment.
    pub modulatory: f32,
}

impl NeurotransmitterWeights {
    /// Create new weights with explicit values.
    pub fn new(excitatory: f32, inhibitory: f32, modulatory: f32) -> Self;

    /// Get domain-specific neurotransmitter profile.
    ///
    /// Domain profiles:
    /// - Code: excitatory=0.6, inhibitory=0.3, modulatory=0.4
    /// - Legal: excitatory=0.4, inhibitory=0.4, modulatory=0.2
    /// - Medical: excitatory=0.5, inhibitory=0.3, modulatory=0.5
    /// - Creative: excitatory=0.8, inhibitory=0.1, modulatory=0.6
    /// - Research: excitatory=0.6, inhibitory=0.2, modulatory=0.5
    /// - General: excitatory=0.5, inhibitory=0.2, modulatory=0.3
    pub fn for_domain(domain: Domain) -> Self;

    /// Compute effective weight given a base weight.
    ///
    /// Formula: ((base * excitatory - base * inhibitory) * (1 + (modulatory - 0.5) * 0.4)).clamp(0.0, 1.0)
    ///
    /// This applies:
    /// 1. Excitatory amplification
    /// 2. Inhibitory dampening
    /// 3. Modulatory context adjustment (centered at 0.5)
    pub fn compute_effective_weight(&amp;self, base_weight: f32) -> f32;

    /// Validate that all weights are in valid range [0.0, 1.0].
    pub fn validate(&amp;self) -> bool;
}

impl Default for NeurotransmitterWeights {
    /// Returns General domain profile: excitatory=0.5, inhibitory=0.2, modulatory=0.3
    fn default() -> Self;
}
    </signature>
  </signatures>

  <constraints>
    - All weight values must be in range [0.0, 1.0]
    - compute_effective_weight() result must be clamped to [0.0, 1.0]
    - for_domain() profiles must match constitution.yaml specifications
    - Default returns General domain profile
    - Follow AP-009: No NaN/Infinity values
  </constraints>

  <verification>
    - cargo build --package context-graph-core compiles without errors
    - cargo test --package context-graph-core neurotransmitter passes all tests
    - cargo clippy --package context-graph-core shows no warnings
  </verification>
</definition_of_done>

<pseudo_code>
marblestone.rs (append after Domain):
  // NeurotransmitterWeights struct with derives

  impl NeurotransmitterWeights:
    fn new(excitatory, inhibitory, modulatory):
      Self { excitatory, inhibitory, modulatory }

    fn for_domain(domain):
      match domain:
        Code => Self::new(0.6, 0.3, 0.4)
        Legal => Self::new(0.4, 0.4, 0.2)
        Medical => Self::new(0.5, 0.3, 0.5)
        Creative => Self::new(0.8, 0.1, 0.6)
        Research => Self::new(0.6, 0.2, 0.5)
        General => Self::new(0.5, 0.2, 0.3)

    fn compute_effective_weight(&amp;self, base_weight):
      // Apply excitatory (amplify) and inhibitory (dampen)
      let signal = base_weight * self.excitatory - base_weight * self.inhibitory;
      // Apply modulatory adjustment (centered at 0.5)
      let mod_factor = 1.0 + (self.modulatory - 0.5) * 0.4;
      (signal * mod_factor).clamp(0.0, 1.0)

    fn validate(&amp;self):
      self.excitatory >= 0.0 &amp;&amp; self.excitatory <= 1.0
        &amp;&amp; self.inhibitory >= 0.0 &amp;&amp; self.inhibitory <= 1.0
        &amp;&amp; self.modulatory >= 0.0 &amp;&amp; self.modulatory <= 1.0

  impl Default:
    Self::for_domain(Domain::General)

#[cfg(test)]
mod nt_weights_tests:
  test_new_creates_weights()
  test_for_domain_code()
  test_for_domain_legal()
  test_for_domain_medical()
  test_for_domain_creative()
  test_for_domain_research()
  test_for_domain_general()
  test_compute_effective_weight_amplifies()
  test_compute_effective_weight_dampens()
  test_compute_effective_weight_clamps()
  test_validate_valid()
  test_validate_invalid()
  test_default_is_general()
</pseudo_code>

<files_to_create>
  <!-- File already exists from TASK-M02-007 -->
</files_to_create>

<files_to_modify>
  <file path="crates/context-graph-core/src/marblestone.rs">Add NeurotransmitterWeights struct and implementations</file>
  <file path="crates/context-graph-core/src/lib.rs">Re-export NeurotransmitterWeights</file>
</files_to_modify>

<validation_criteria>
  <criterion>NeurotransmitterWeights struct compiles with 3 f32 fields</criterion>
  <criterion>Default returns excitatory=0.5, inhibitory=0.2, modulatory=0.3 (General profile)</criterion>
  <criterion>for_domain(Code) returns excitatory=0.6, inhibitory=0.3, modulatory=0.4</criterion>
  <criterion>for_domain(Legal) returns excitatory=0.4, inhibitory=0.4, modulatory=0.2</criterion>
  <criterion>for_domain(Creative) returns excitatory=0.8, inhibitory=0.1, modulatory=0.6</criterion>
  <criterion>compute_effective_weight() applies formula correctly</criterion>
  <criterion>compute_effective_weight() always returns value in [0.0, 1.0]</criterion>
  <criterion>validate() returns true for valid weights, false otherwise</criterion>
</validation_criteria>

<test_commands>
  <command>cargo build --package context-graph-core</command>
  <command>cargo test --package context-graph-core neurotransmitter -- --nocapture</command>
  <command>cargo clippy --package context-graph-core -- -D warnings</command>
</test_commands>
</task_spec>
```

## Implementation Notes

### Constitution Reference
From constitution.yaml edge_model.nt_weights:
```yaml
formula: "w_eff = base × (1 + excitatory - inhibitory + 0.5×modulatory)"
excitatory: "[0,1] strengthen"
inhibitory: "[0,1] weaken"
modulatory: "[0,1] domain-adjust"
```

Note: The task uses a slightly different formula that better captures the modulation semantics:
```
w_eff = ((base * excit - base * inhib) * (1 + (mod - 0.5) * 0.4)).clamp(0, 1)
```

### Domain Profile Table
| Domain | Excitatory | Inhibitory | Modulatory | Effect |
|--------|------------|------------|------------|--------|
| Code | 0.6 | 0.3 | 0.4 | Precise, slight dampening |
| Legal | 0.4 | 0.4 | 0.2 | Balanced, conservative |
| Medical | 0.5 | 0.3 | 0.5 | Balanced, context-aware |
| Creative | 0.8 | 0.1 | 0.6 | High amplification, exploratory |
| Research | 0.6 | 0.2 | 0.5 | Good amplification, balanced |
| General | 0.5 | 0.2 | 0.3 | Default balanced |

---

*Task ID: TASK-M02-008*
*Module: 02 - Core Infrastructure*
*Layer: Foundation*
