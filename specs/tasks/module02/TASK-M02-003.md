# TASK-M02-003: Define NodeMetadata Struct

```xml
<task_spec id="TASK-M02-003" version="1.0">
<metadata>
  <title>Define NodeMetadata Struct</title>
  <status>blocked</status>
  <layer>foundation</layer>
  <module>module-02</module>
  <sequence>3</sequence>
  <priority>high</priority>
  <estimated_hours>3</estimated_hours>
  <implements>
    <item>REQ-CORE-003: Metadata requirements</item>
    <item>TECH-CORE-002 Section 2.3: NodeMetadata specification</item>
  </implements>
  <depends_on>
    <task_ref>TASK-M02-002</task_ref>
  </depends_on>
  <estimated_complexity>medium</estimated_complexity>
</metadata>

<context>
NodeMetadata is a container struct holding all supplementary information about a MemoryNode beyond its core content and embedding. It includes source tracking, tagging, versioning, soft-delete support, and hierarchical relationships. This struct enables rich querying, lifecycle management, and provenance tracking for memories.
</context>

<input_context_files>
  <file purpose="Constitution reference for soft-delete rules">docs2/constitution.yaml</file>
  <file purpose="Modality enum dependency">crates/context-graph-core/src/metadata.rs</file>
</input_context_files>

<prerequisites>
  <check>TASK-M02-002 (Modality enum) is complete</check>
  <check>Modality enum is accessible in metadata.rs</check>
</prerequisites>

<scope>
  <in_scope>
    - NodeMetadata struct with 13 fields
    - source: Option&lt;String&gt; - origin identifier
    - language: Option&lt;String&gt; - natural language code (e.g., "en")
    - modality: Modality - content type
    - tags: Vec&lt;String&gt; - user-defined tags
    - utl_score: Option&lt;f32&gt; - cached UTL learning score
    - consolidated: bool - consolidation status
    - consolidated_at: Option&lt;DateTime&lt;Utc&gt;&gt; - consolidation timestamp
    - version: u32 - version counter
    - deleted: bool - soft delete flag
    - deleted_at: Option&lt;DateTime&lt;Utc&gt;&gt; - deletion timestamp
    - parent_id: Option&lt;Uuid&gt; - hierarchical parent
    - child_ids: Vec&lt;Uuid&gt; - hierarchical children
    - custom: HashMap&lt;String, serde_json::Value&gt; - custom attributes
    - All builder/modifier methods
    - Unit tests
  </in_scope>
  <out_of_scope>
    - MemoryNode struct (handled in TASK-M02-005)
    - Persistence/storage (handled in Module 02 storage tasks)
  </out_of_scope>
</scope>

<definition_of_done>
  <signatures>
    <signature file="crates/context-graph-core/src/metadata.rs">
use chrono::{DateTime, Utc};
use serde::{Deserialize, Serialize};
use std::collections::HashMap;
use uuid::Uuid;

/// Metadata container for MemoryNode supplementary information.
#[derive(Debug, Clone, PartialEq, Serialize, Deserialize)]
pub struct NodeMetadata {
    /// Source identifier (e.g., file path, URL, session ID)
    pub source: Option&lt;String&gt;,
    /// Natural language code (ISO 639-1, e.g., "en", "es")
    pub language: Option&lt;String&gt;,
    /// Content modality type
    pub modality: Modality,
    /// User-defined tags for categorization
    pub tags: Vec&lt;String&gt;,
    /// Cached UTL learning score [0.0, 1.0]
    pub utl_score: Option&lt;f32&gt;,
    /// Whether this node has been consolidated
    pub consolidated: bool,
    /// Timestamp when consolidation occurred
    pub consolidated_at: Option&lt;DateTime&lt;Utc&gt;&gt;,
    /// Version counter (incremented on updates)
    pub version: u32,
    /// Soft delete flag
    pub deleted: bool,
    /// Timestamp when soft deletion occurred
    pub deleted_at: Option&lt;DateTime&lt;Utc&gt;&gt;,
    /// Parent node ID for hierarchical relationships
    pub parent_id: Option&lt;Uuid&gt;,
    /// Child node IDs for hierarchical relationships
    pub child_ids: Vec&lt;Uuid&gt;,
    /// Custom user-defined attributes
    pub custom: HashMap&lt;String, serde_json::Value&gt;,
}

impl NodeMetadata {
    /// Create new metadata with default values.
    pub fn new() -> Self;

    /// Set the source identifier.
    pub fn with_source(self, source: impl Into&lt;String&gt;) -> Self;

    /// Set the language code.
    pub fn with_language(self, language: impl Into&lt;String&gt;) -> Self;

    /// Set the modality.
    pub fn with_modality(self, modality: Modality) -> Self;

    /// Add a tag (deduplicates automatically).
    pub fn add_tag(&amp;mut self, tag: impl Into&lt;String&gt;);

    /// Remove a tag. Returns true if tag was present.
    pub fn remove_tag(&amp;mut self, tag: &amp;str) -> bool;

    /// Check if a tag exists.
    pub fn has_tag(&amp;self, tag: &amp;str) -> bool;

    /// Set a custom attribute.
    pub fn set_custom(&amp;mut self, key: impl Into&lt;String&gt;, value: serde_json::Value);

    /// Get a custom attribute.
    pub fn get_custom(&amp;self, key: &amp;str) -> Option&lt;&amp;serde_json::Value&gt;;

    /// Remove a custom attribute. Returns the removed value if present.
    pub fn remove_custom(&amp;mut self, key: &amp;str) -> Option&lt;serde_json::Value&gt;;

    /// Mark as consolidated with current timestamp.
    pub fn mark_consolidated(&amp;mut self);

    /// Mark as deleted (soft delete) with current timestamp.
    pub fn mark_deleted(&amp;mut self);

    /// Restore from soft deletion.
    pub fn restore(&amp;mut self);

    /// Increment version counter. Saturates at u32::MAX.
    pub fn increment_version(&amp;mut self);

    /// Estimate memory size in bytes.
    pub fn estimated_size(&amp;self) -> usize;
}

impl Default for NodeMetadata {
    fn default() -> Self;
}
    </signature>
  </signatures>

  <constraints>
    - Tags must be deduplicated (no duplicates in Vec)
    - Version increment must saturate at u32::MAX (not wrap)
    - mark_deleted() sets both deleted=true and deleted_at=Some(Utc::now())
    - restore() sets deleted=false and deleted_at=None
    - mark_consolidated() sets both consolidated=true and consolidated_at=Some(Utc::now())
    - estimated_size() should account for string lengths, vec capacities, hashmap overhead
    - Follow SEC-06: Soft delete with 30-day recovery
  </constraints>

  <verification>
    - cargo build --package context-graph-core compiles without errors
    - cargo test --package context-graph-core metadata passes all tests
    - cargo clippy --package context-graph-core shows no warnings
  </verification>
</definition_of_done>

<pseudo_code>
metadata.rs (append to existing):
  // Imports: chrono, uuid, serde_json, HashMap

  // NodeMetadata struct with derives

  impl NodeMetadata:
    fn new():
      Self {
        source: None,
        language: None,
        modality: Modality::default(), // Text
        tags: Vec::new(),
        utl_score: None,
        consolidated: false,
        consolidated_at: None,
        version: 1,
        deleted: false,
        deleted_at: None,
        parent_id: None,
        child_ids: Vec::new(),
        custom: HashMap::new(),
      }

    fn with_source(self, source): Self { source: Some(source.into()), ..self }
    fn with_language(self, lang): Self { language: Some(lang.into()), ..self }
    fn with_modality(self, mod): Self { modality: mod, ..self }

    fn add_tag(&amp;mut self, tag):
      let tag = tag.into();
      if !self.tags.contains(&amp;tag):
        self.tags.push(tag)

    fn remove_tag(&amp;mut self, tag):
      if let Some(pos) = self.tags.iter().position(|t| t == tag):
        self.tags.remove(pos);
        true
      else: false

    fn has_tag(&amp;self, tag): self.tags.iter().any(|t| t == tag)

    fn set_custom(&amp;mut self, key, value): self.custom.insert(key.into(), value)
    fn get_custom(&amp;self, key): self.custom.get(key)
    fn remove_custom(&amp;mut self, key): self.custom.remove(key)

    fn mark_consolidated(&amp;mut self):
      self.consolidated = true
      self.consolidated_at = Some(Utc::now())

    fn mark_deleted(&amp;mut self):
      self.deleted = true
      self.deleted_at = Some(Utc::now())

    fn restore(&amp;mut self):
      self.deleted = false
      self.deleted_at = None

    fn increment_version(&amp;mut self):
      self.version = self.version.saturating_add(1)

    fn estimated_size(&amp;self):
      base = size_of::&lt;Self&gt;()
      + self.source.as_ref().map_or(0, |s| s.len())
      + self.language.as_ref().map_or(0, |s| s.len())
      + self.tags.iter().map(|t| t.len()).sum()
      + self.child_ids.len() * 16  // UUID size
      + self.custom estimate
      return base

  impl Default: Self::new()

#[cfg(test)]
mod metadata_tests:
  test_new_defaults()
  test_builder_methods()
  test_tag_operations()
  test_custom_attributes()
  test_mark_consolidated()
  test_soft_delete_restore()
  test_version_increment_saturation()
  test_estimated_size()
  test_serde_roundtrip()
</pseudo_code>

<files_to_create>
  <!-- File already exists from TASK-M02-002 -->
</files_to_create>

<files_to_modify>
  <file path="crates/context-graph-core/src/metadata.rs">Add NodeMetadata struct and implementations</file>
  <file path="crates/context-graph-core/src/lib.rs">Re-export NodeMetadata</file>
</files_to_modify>

<validation_criteria>
  <criterion>NodeMetadata struct compiles with all 13 fields</criterion>
  <criterion>Builder pattern methods (with_*) work correctly</criterion>
  <criterion>add_tag() deduplicates (adding same tag twice results in one entry)</criterion>
  <criterion>remove_tag() returns true if tag existed, false otherwise</criterion>
  <criterion>has_tag() correctly checks tag presence</criterion>
  <criterion>Custom attribute CRUD operations work correctly</criterion>
  <criterion>mark_consolidated() sets timestamp to current UTC time</criterion>
  <criterion>Soft delete/restore cycle works: mark_deleted() -> restore() clears flags</criterion>
  <criterion>increment_version() saturates at u32::MAX instead of wrapping</criterion>
  <criterion>estimated_size() returns reasonable approximation (within 20% of actual)</criterion>
  <criterion>Serde round-trip preserves all fields including DateTime</criterion>
</validation_criteria>

<test_commands>
  <command>cargo build --package context-graph-core</command>
  <command>cargo test --package context-graph-core metadata -- --nocapture</command>
  <command>cargo clippy --package context-graph-core -- -D warnings</command>
</test_commands>
</task_spec>
```

## Implementation Notes

### Soft Delete Compliance (SEC-06)
Per constitution.yaml SEC-06: "Soft delete 30-day recovery (exception: user_requested+soft_delete=false)"
- Default behavior is soft delete (deleted=true, deleted_at=timestamp)
- Hard delete only when explicitly requested by user AND soft_delete=false
- The 30-day recovery window is enforced at the storage layer

### Tag Deduplication
Tags should be case-sensitive but deduplicated. Consider using a HashSet internally if frequent lookups are needed, but Vec is acceptable for small tag counts.

### Custom Attributes
The `custom` field uses `serde_json::Value` to allow arbitrary JSON-compatible values. This enables extensibility without schema changes.

---

*Task ID: TASK-M02-003*
*Module: 02 - Core Infrastructure*
*Layer: Foundation*
