# M05-T22: UtlProcessor Main Orchestrator

```yaml
task_id: M05-T22
title: "UtlProcessor Main Orchestrator"
module: "Module 5: UTL Integration"
layer: "surface"
priority: "critical"
status: "complete"
estimated_hours: 4
created: "2026-01-04"
updated: "2026-01-04"
completed: "2026-01-04"

file_path: "crates/context-graph-utl/src/processor.rs"
test_file: "crates/context-graph-utl/src/processor.rs" # inline tests

dependencies:
  - "M05-T11"  # SurpriseCalculator - crates/context-graph-utl/src/surprise/calculator.rs
  - "M05-T13"  # CoherenceTracker - crates/context-graph-utl/src/coherence/tracker.rs
  - "M05-T16"  # EmotionalWeightCalculator - crates/context-graph-utl/src/emotional/calculator.rs
  - "M05-T17"  # PhaseOscillator - crates/context-graph-utl/src/phase/oscillator.rs
  - "M05-T18"  # JohariClassifier - crates/context-graph-utl/src/johari/classifier.rs
  - "M05-T19"  # LifecycleManager - crates/context-graph-utl/src/lifecycle/manager.rs
  - "M05-T20"  # compute_learning_magnitude - lib.rs:103
  - "M05-T21"  # LearningSignal, UtlState - lib.rs:276, lib.rs:457

spec_refs:
  - "constitution.yaml lines 148-167 (UTL formula and lifecycle)"
  - "contextprd.md Section 2.1-2.4 (UTL equation, Johari, lifecycle)"
  - "learntheory.md (Unified Theory of Learning)"
```

---

## COMPLETION SUMMARY

**STATUS: COMPLETE** - Verified by Sherlock-Holmes forensic investigation.

### Implementation Location
- **File**: `crates/context-graph-utl/src/processor.rs` (768 lines)
- **Module export**: `lib.rs:49` - `pub mod processor;`
- **Type re-exports**: `lib.rs:68` - `pub use processor::{SessionContext, UtlProcessor};`

### Test Verification
```bash
cargo test -p context-graph-utl --lib 2>&1 | tail -5
# test result: ok. 405 passed; 0 failed; 0 ignored
```

### All Acceptance Criteria MET:
- [x] `crates/context-graph-utl/src/processor.rs` exists (26,633 bytes)
- [x] `UtlProcessor::new()` compiles and runs
- [x] `UtlProcessor::compute_learning()` returns valid `LearningSignal`
- [x] All 6 components integrated (surprise, coherence, emotional, phase, johari, lifecycle)
- [x] Lifecycle progression works (Infancy → Growth at 50 interactions)
- [x] Lambda weights update with lifecycle stage
- [x] Johari quadrant classification works
- [x] `SessionContext` manages sliding embedding window
- [x] Performance: < 10ms for full computation with 50 context embeddings
- [x] All tests pass: 405 passing tests
- [x] No NaN/Infinity values (per AP-009)

---

## Implementation Details

### UtlProcessor Struct (processor.rs:65-89)
```rust
pub struct UtlProcessor {
    surprise_calculator: SurpriseCalculator,
    coherence_tracker: CoherenceTracker,
    emotional_calculator: EmotionalWeightCalculator,
    phase_oscillator: PhaseOscillator,
    johari_classifier: JohariClassifier,
    lifecycle_manager: LifecycleManager,
    config: UtlConfig,
    computation_count: u64,
}
```

### Key Methods
| Method | Location | Purpose |
|--------|----------|---------|
| `new(config)` | Line 99 | Create processor (panics on invalid config) |
| `try_new(config)` | Line 115 | Fallible construction |
| `with_defaults()` | Line 131 | Create with default config |
| `compute_learning()` | Line 158 | Main UTL computation |
| `compute_learning_with_state()` | Line 230 | With explicit emotional state |
| `lifecycle_stage()` | Line 274 | Get current stage |
| `lambda_weights()` | Line 280 | Get current weights |
| `reset()` | Line 308 | Reset to initial state |
| `restore_lifecycle()` | Line 316 | Restore from persistence |

### Threshold Configuration
The processor uses `UtlThresholds` from config.rs:
```rust
// config.rs:916-963
pub struct UtlThresholds {
    pub high_quality: f32,  // Default: 0.6 (consolidation threshold)
    pub low_quality: f32,   // Default: 0.3 (storage threshold)
    // ... other fields
}
```

Usage in processor.rs:204-205:
```rust
let should_consolidate = magnitude > self.config.thresholds.high_quality;
let should_store = magnitude > self.config.thresholds.low_quality;
```

### SessionContext Struct (processor.rs:347-365)
```rust
pub struct SessionContext {
    pub session_id: Uuid,
    pub recent_embeddings: Vec<Vec<f32>>,
    pub max_window_size: usize,
    pub interaction_count: u64,
    pub started_at: DateTime<Utc>,
    pub last_activity: DateTime<Utc>,
}
```

---

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                       UtlProcessor                          │
│                                                             │
│  ┌──────────────┐   ┌──────────────┐   ┌──────────────┐   │
│  │ Surprise     │   │ Coherence    │   │ Emotional    │   │
│  │ Calculator   │   │ Tracker      │   │ Calculator   │   │
│  │ (delta_s)    │   │ (delta_c)    │   │ (w_e)        │   │
│  └──────┬───────┘   └──────┬───────┘   └──────┬───────┘   │
│         │                   │                   │           │
│         ▼                   ▼                   ▼           │
│  ┌──────────────────────────────────────────────────────┐  │
│  │          compute_learning_magnitude_validated        │  │
│  │          L = (ΔS × ΔC) · wₑ · cos φ                  │  │
│  └──────────────────────┬───────────────────────────────┘  │
│                         │                                   │
│  ┌──────────────┐       │       ┌──────────────┐           │
│  │ Phase        │───────┼───────│ Lifecycle    │           │
│  │ Oscillator   │       │       │ Manager      │           │
│  │ (phi)        │       │       │ (lambda)     │           │
│  └──────────────┘       │       └──────────────┘           │
│                         ▼                                   │
│  ┌──────────────────────────────────────────────────────┐  │
│  │                JohariClassifier                       │  │
│  │                (quadrant + action)                    │  │
│  └──────────────────────┬───────────────────────────────┘  │
│                         │                                   │
│                         ▼                                   │
│                  LearningSignal                             │
└─────────────────────────────────────────────────────────────┘
```

---

## Constitution Reference

### UTL Formula (constitution.yaml:152-157)
```yaml
utl:
  formula: "L = f((ΔS × ΔC) · wₑ · cos φ)"
  params:
    ΔS: "[0,1] entropy/novelty"
    ΔC: "[0,1] coherence/understanding"
    wₑ: "[0.5,1.5] emotional weight"
    φ: "[0,π] phase sync"
```

### Lifecycle Lambda Weights (constitution.yaml:165-167)
```yaml
lifecycle:
  infancy:  { n: "0-50",   λ_ΔS: 0.7, λ_ΔC: 0.3, stance: "capture-novelty" }
  growth:   { n: "50-500", λ_ΔS: 0.5, λ_ΔC: 0.5, stance: "balanced" }
  maturity: { n: "500+",   λ_ΔS: 0.3, λ_ΔC: 0.7, stance: "curation-coherence" }
```

### Johari Quadrant Actions (constitution.yaml:159-163)
```yaml
johari:
  Open: "ΔS<0.5, ΔC>0.5 → direct recall"
  Blind: "ΔS>0.5, ΔC<0.5 → discovery (epistemic_action/dream)"
  Hidden: "ΔS<0.5, ΔC<0.5 → private (get_neighborhood)"
  Unknown: "ΔS>0.5, ΔC>0.5 → frontier"
```

---

## Test Coverage (20+ tests in processor.rs)

| Test | Purpose | Status |
|------|---------|--------|
| `test_processor_creation` | Verify default construction | PASS |
| `test_processor_try_new_with_valid_config` | Fallible construction | PASS |
| `test_compute_learning_basic` | Basic computation | PASS |
| `test_compute_learning_empty_context` | Empty context handling | PASS |
| `test_lifecycle_progression` | Stage transitions | PASS |
| `test_lambda_weights_change_with_stage` | Weight updates | PASS |
| `test_johari_quadrant_classification` | Quadrant mapping | PASS |
| `test_computation_count_tracking` | Metrics | PASS |
| `test_processor_reset` | Reset functionality | PASS |
| `test_restore_lifecycle` | Persistence restore | PASS |
| `test_performance_under_10ms` | Performance target | PASS |
| `test_session_context_creation` | SessionContext init | PASS |
| `test_session_add_embedding` | Embedding addition | PASS |
| `test_session_window_sliding` | Sliding window | PASS |
| `test_session_staleness` | Stale detection | PASS |
| `test_session_clear_context` | Context clearing | PASS |
| `test_single_dimension_embedding` | Edge case | PASS |
| `test_large_context_window` | 1000 embeddings | PASS |
| `test_empty_content` | Empty string input | PASS |
| `test_identical_embeddings` | Zero variance | PASS |

---

## Related Tasks

| Task | Relationship | Status |
|------|--------------|--------|
| M05-T11 | SurpriseCalculator dependency | COMPLETE |
| M05-T13 | CoherenceTracker dependency | COMPLETE |
| M05-T16 | EmotionalWeightCalculator dependency | COMPLETE |
| M05-T17 | PhaseOscillator dependency | COMPLETE |
| M05-T18 | JohariClassifier dependency | COMPLETE |
| M05-T19 | LifecycleManager dependency | COMPLETE |
| M05-T20 | compute_learning_magnitude dependency | COMPLETE |
| M05-T21 | LearningSignal, UtlState dependency | COMPLETE |
| M05-T24 | UtlMetrics, UtlStatus (uses processor output) | COMPLETE |
| M05-T26 | utl_status MCP tool (uses processor) | PENDING |
| M05-T30 | SessionContext (included in this task) | COMPLETE |

---

*Task completed: 2026-01-04*
*Verified by: Sherlock-Holmes forensic investigation*
*Test result: 405 passed, 0 failed*
