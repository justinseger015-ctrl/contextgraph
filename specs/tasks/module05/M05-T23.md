# M05-T23: UtlError Enum

```yaml
task_id: M05-T23
title: "UtlError Enum"
module: "Module 5: UTL Integration"
layer: "surface"
priority: "high"
status: "COMPLETE"
estimated_hours: 1
created: "2026-01-04"
completed: "2026-01-04"

file_path: "crates/context-graph-utl/src/error.rs"
test_location: "crates/context-graph-utl/src/error.rs (inline #[cfg(test)])"

dependencies: []

git_ref: "f521803 feat(utl): complete context-graph-utl crate with 453 tests passing"
```

---

## Current State (VERIFIED 2026-01-04)

**STATUS: COMPLETE** - The `UtlError` enum is fully implemented in `crates/context-graph-utl/src/error.rs` (408 lines, 20 inline tests).

### Verification Commands
```bash
# Verify file exists and line count
wc -l crates/context-graph-utl/src/error.rs
# Expected: 408 crates/context-graph-utl/src/error.rs

# Run error module tests
cargo test -p context-graph-utl --lib error 2>&1 | grep -E "(test result|passed)"
# Expected: test result: ok. 20 passed; 0 failed;

# Verify UtlError is exported in lib.rs
grep -n "pub use error" crates/context-graph-utl/src/lib.rs
# Expected: pub use error::{UtlError, UtlResult};
```

---

## Implementation Summary

### Location
- **File**: `crates/context-graph-utl/src/error.rs`
- **Lines**: 408
- **Tests**: 20 (inline `#[cfg(test)]`)
- **Re-export**: `crates/context-graph-utl/src/lib.rs` line ~55

### UtlError Variants (16 total)

| Variant | Fields | Use Case |
|---------|--------|----------|
| `InvalidComputation` | `delta_s, delta_c, w_e, phi, reason` | NaN/Infinity in UTL formula |
| `InvalidLambdaWeights` | `novelty, consolidation, reason` | Lambda weights != 1.0 |
| `MissingContext` | `String` | Missing embedding/context |
| `DimensionMismatch` | `expected, actual` | Embedding dimension mismatch |
| `GraphError` | `String` | Knowledge graph access errors |
| `ConfigError` | `String` | Configuration validation failures |
| `InvalidLifecycleTransition` | `from, to, reason` | Invalid stage transitions |
| `JohariError` | `String` | Johari classification errors |
| `PhaseError` | `String` | Phase oscillator errors |
| `SurpriseError` | `String` | Surprise computation errors |
| `CoherenceError` | `String` | Coherence computation errors |
| `EmptyInput` | (unit) | Empty input provided |
| `SerializationError` | `String` | JSON serialization failures |
| `InvalidParameter` | `name, value, reason` | Invalid parameter values |
| `NumericOverflow` | `operation, details` | Numeric overflow/underflow |
| `EntropyError` | `String` | Entropy computation errors |
| `CapacityError` | `String` | Memory/capacity errors |

### Helper Constructors

```rust
UtlError::nan_result(delta_s, delta_c, w_e, phi)
UtlError::infinite_result(delta_s, delta_c, w_e, phi)
UtlError::lambda_sum_error(novelty, consolidation)
UtlError::negative_lambda(novelty, consolidation)
UtlError::invalid_transition(from, to, reason)
UtlError::invalid_param(name, value, reason)
```

### Classification Methods

```rust
impl UtlError {
    /// Returns true if error can be retried with different parameters
    pub fn is_recoverable(&self) -> bool;

    /// Returns true if error is a computation failure
    pub fn is_computation_error(&self) -> bool;
}
```

### Trait Implementations

- `#[derive(Debug, Error)]` via `thiserror`
- `impl From<serde_json::Error> for UtlError`

---

## Dependencies

### Cargo.toml (already configured)
```toml
[dependencies]
thiserror = "1.0"
serde_json = "1.0"  # For From<serde_json::Error>
```

---

## Related Tasks

| Task | Relationship |
|------|--------------|
| M05-T21 | LearningSignal.validate() returns `UtlResult` |
| M05-T22 | UtlProcessor returns `UtlResult` |
| M05-T06 | LifecycleLambdaWeights uses `InvalidLambdaWeights` |
| M05-T35 | Graph integration uses `GraphError` |

---

## Full State Verification (FOR FUTURE AUDITS)

### Source of Truth
The `UtlError` enum is the canonical error type for all UTL computations. It is:
1. Defined in `crates/context-graph-utl/src/error.rs`
2. Re-exported via `crates/context-graph-utl/src/lib.rs`
3. Used by all UTL modules (surprise, coherence, emotional, phase, johari, lifecycle, processor)

### Verification Checklist

```bash
# 1. Verify compilation (no errors)
cargo check -p context-graph-utl 2>&1 | tail -3
# Expected: Finished `dev` profile

# 2. Run all error tests
cargo test -p context-graph-utl --lib error:: 2>&1 | grep -E "test.*ok|passed"
# Expected: 20 passed

# 3. Verify thiserror derivation works (Display trait)
cargo test -p context-graph-utl --lib -- test_error_display 2>&1 | grep -E "ok|FAILED"
# Expected: ok

# 4. Verify From<serde_json::Error> conversion
cargo test -p context-graph-utl --lib -- test_from_serde_json_error 2>&1 | grep -E "ok|FAILED"
# Expected: ok

# 5. Verify is_recoverable() classification
cargo test -p context-graph-utl --lib -- test_is_recoverable 2>&1 | grep -E "ok|FAILED"
# Expected: ok

# 6. Verify is_computation_error() classification
cargo test -p context-graph-utl --lib -- test_is_computation_error 2>&1 | grep -E "ok|FAILED"
# Expected: ok
```

### Edge Case Audit

| Edge Case | Test | Expected Behavior |
|-----------|------|-------------------|
| Empty input | `test_empty_input_error` | Returns `UtlError::EmptyInput` |
| NaN in computation | `test_nan_result_helper` | Returns `InvalidComputation` with "NaN" reason |
| Infinite result | `test_infinite_result_helper` | Returns `InvalidComputation` with "infinite" reason |
| Lambda sum != 1.0 | `test_lambda_sum_error_helper` | Returns `InvalidLambdaWeights` with sum details |
| Negative lambda | `test_negative_lambda_helper` | Returns `InvalidLambdaWeights` with "negative" reason |
| Invalid JSON | `test_from_serde_json_error` | Converts to `SerializationError` |

### Evidence of Success

Run this command to see actual test output:
```bash
cargo test -p context-graph-utl --lib error:: -- --nocapture 2>&1 | head -50
```

---

## Sherlock Verification (MANDATORY FINAL STEP)

After any modifications to this task or related code, you MUST run Sherlock verification:

```
Use Task tool with subagent_type='sherlock-holmes' to verify:
1. File exists at crates/context-graph-utl/src/error.rs
2. All 16 variants are present
3. All 20 tests pass
4. UtlError is properly re-exported in lib.rs
5. No compilation errors
6. Error messages are descriptive and actionable
```

### Sherlock Verification Prompt
```
Verify M05-T23 (UtlError Enum) implementation:
1. Read crates/context-graph-utl/src/error.rs
2. Confirm 16 enum variants exist
3. Run: cargo test -p context-graph-utl --lib error::
4. Verify 20 tests pass
5. Check lib.rs re-exports UtlError and UtlResult
6. Report any discrepancies
```

---

## Notes

- **NO BACKWARDS COMPATIBILITY**: If any variant or method is missing, fail fast with compilation error
- **NO MOCK DATA**: All tests use real UtlError instances
- **FAIL FAST**: Invalid inputs must return `Err(UtlError::...)`, never panic
- **LOGGING**: All error variants include context for debugging (field values in error messages)

---

*Task verified: 2026-01-04*
*Implementation: COMPLETE*
*Tests: 20 passing*
*Git ref: f521803*
