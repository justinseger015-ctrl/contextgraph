# M05-T25: Create Module Integration Tests and Benchmarks

```yaml
metadata:
  id: "M05-T25"
  title: "Create Module Integration Tests and Benchmarks"
  module: "module-05"
  module_name: "UTL Integration"
  layer: "surface"
  priority: "critical"
  estimated_hours: 5
  created: "2026-01-04"
  updated: "2026-01-04"
  status: "complete"
  dependencies:
    - "M05-T22"  # UtlProcessor orchestrator - COMPLETED
    - "M05-T24"  # UtlMetrics and UtlStatus - COMPLETED
  spec_refs:
    - "TECH-UTL-005 Section 12"
    - "SPEC-UTL-005 Section 12, 13"
    - "constitution.yaml (utl section, lines 148-167)"
    - "contextprd.md (Section 5: Learning Theory)"
```

## IMPLEMENTATION STATUS: COMPLETE

All integration tests and benchmarks are **fully implemented**:

| File | Lines | Status |
|------|-------|--------|
| `crates/context-graph-utl/tests/integration_tests.rs` | 1016 | **COMPLETE** |
| `crates/context-graph-utl/benches/utl_bench.rs` | 390 | **COMPLETE** |
| `crates/context-graph-utl/benches/surprise_bench.rs` | 300 | **COMPLETE** |

## Source of Truth (Canonical Files)

| Reference | Path | Key Content |
|-----------|------|-------------|
| Constitution | `/home/cabdru/contextgraph/docs2/constitution.yaml` | UTL formula (line 152), lifecycle (164-167), Johari (159-163) |
| PRD | `/home/cabdru/contextgraph/docs2/contextprd.md` | Section 5: UTL formalization |
| Module Index | `/home/cabdru/contextgraph/specs/tasks/module05/_index.md` | Task dependencies and status |
| Learning Theory | `/home/cabdru/steveprog/docs3/learntheory.md` | Theoretical foundations |
| CUDA Report | `/home/cabdru/contextgraph/docs2/CUDA-13-1-RTX-5090-Report.md` | Performance targets |

## UTL Formula (constitution.yaml line 152)

```
L = f((ΔS × ΔC) · wₑ · cos φ)

Parameters:
  ΔS: [0,1] entropy/novelty (surprise)
  ΔC: [0,1] coherence/understanding
  wₑ: [0.5,1.5] emotional weight
  φ: [0,π] phase sync angle
```

## Lifecycle Thresholds (constitution.yaml lines 164-167)

| Stage | Interactions | λ_ΔS (lambda_s) | λ_ΔC (lambda_c) | Stance |
|-------|-------------|-----------------|-----------------|--------|
| Infancy | 0-49 | 0.7 | 0.3 | capture-novelty |
| Growth | 50-499 | 0.5 | 0.5 | balanced |
| Maturity | 500+ | 0.3 | 0.7 | curation-coherence |

**CRITICAL**: Transitions occur AT 50 and AT 500 interactions, with hysteresis=10.

## Johari Window Mapping (constitution.yaml lines 159-163)

| Quadrant | Condition | Action |
|----------|-----------|--------|
| Open | ΔS<0.5, ΔC>0.5 | DirectRecall |
| Blind | ΔS>0.5, ΔC<0.5 | TriggerDream |
| Hidden | ΔS<0.5, ΔC<0.5 | GetNeighborhood |
| Unknown | ΔS>0.5, ΔC>0.5 | EpistemicAction |

## Actual API (Verified from Codebase)

### Core Functions (lib.rs)

```rust
pub fn compute_learning_magnitude(delta_s: f32, delta_c: f32, w_e: f32, phi: f32) -> f32
pub fn compute_learning_magnitude_validated(delta_s: f32, delta_c: f32, w_e: f32, phi: f32) -> Result<f32, UtlError>
```

### LearningSignal (lib.rs)

```rust
pub struct LearningSignal {
    pub magnitude: f32,           // [0, 1]
    pub delta_s: f32,             // [0, 1]
    pub delta_c: f32,             // [0, 1]
    pub w_e: f32,                 // [0.5, 1.5]
    pub phi: f32,                 // [0, π]
    pub lambda_weights: Option<LifecycleLambdaWeights>,
    pub quadrant: JohariQuadrant,
    pub suggested_action: SuggestedAction,
    pub is_high_learning: bool,
    pub should_consolidate: bool,
    pub latency_us: u64,
}
```

### UtlProcessor API (processor.rs)

```rust
impl UtlProcessor {
    pub fn with_defaults() -> Self
    pub fn new(config: UtlConfig) -> Self

    // Primary compute method - takes (content, embedding, context)
    pub fn compute_learning(
        &mut self,
        content: &str,
        embedding: &[f32],
        context: &[Vec<f32>]
    ) -> Result<LearningSignal, UtlError>

    pub fn compute_learning_with_state(
        &mut self,
        content: &str,
        embedding: &[f32],
        context: &[Vec<f32>],
        emotional_state: EmotionalState
    ) -> Result<LearningSignal, UtlError>

    pub fn lifecycle_stage(&self) -> LifecycleStage
    pub fn interaction_count(&self) -> u64
    pub fn computation_count(&self) -> u64
    pub fn restore_lifecycle(&mut self, count: u64)
    pub fn reset(&mut self)
}
```

### LifecycleLambdaWeights (lifecycle/lambda.rs)

```rust
impl LifecycleLambdaWeights {
    pub fn for_stage(stage: LifecycleStage) -> Self
    pub fn lambda_s(&self) -> f32  // novelty weight (NOT lambda_novelty)
    pub fn lambda_c(&self) -> f32  // consolidation weight (NOT lambda_consolidation)
}
```

### EmotionalWeightCalculator (emotional/calculator.rs)

```rust
impl EmotionalWeightCalculator {
    pub fn new(config: &EmotionalConfig) -> Self

    // Method signature uses compute_emotional_weight, not compute_weight
    pub fn compute_emotional_weight(&self, content: &str, state: EmotionalState) -> f32
}
```

### JohariClassifier (johari/classifier.rs)

```rust
impl JohariClassifier {
    pub fn default() -> Self
    pub fn classify(&self, delta_s: f32, delta_c: f32) -> JohariQuadrant
}
```

## Existing Integration Tests (1016 lines)

All tests in `crates/context-graph-utl/tests/integration_tests.rs`:

| Test | Purpose |
|------|---------|
| `test_full_utl_pipeline_with_real_data` | Complete pipeline with bounds validation |
| `test_formula_mathematical_properties` | Zero surprise/coherence/cos properties |
| `test_formula_computation_accuracy` | Exact formula: L = (ΔS × ΔC) · wₑ · cos φ |
| `test_anti_phase_suppresses_learning` | φ=π yields L=0 |
| `test_lifecycle_transitions_at_thresholds` | Full 0→500 progression |
| `test_lifecycle_boundary_exact_at_50` | Exact transition at 50 |
| `test_lifecycle_boundary_exact_at_500` | Transition with hysteresis |
| `test_lambda_weights_per_lifecycle_stage` | λ_s and λ_c values |
| `test_lambda_weights_sum_to_one` | Invariant: λ_s + λ_c = 1.0 |
| `test_johari_quadrant_classification` | All 4 quadrants |
| `test_suggested_actions_per_quadrant` | Quadrant→Action mapping |
| `test_johari_boundary_values` | Edge at (0.5, 0.5) |
| `test_nan_infinity_prevention_edge_cases` | Numerical stability |
| `test_error_handling_out_of_bounds_delta_s` | Validation errors |
| `test_error_handling_out_of_bounds_delta_c` | Validation errors |
| `test_error_handling_out_of_bounds_w_e` | Validation errors |
| `test_error_handling_out_of_bounds_phi` | Validation errors |
| `test_emotional_weight_bounds` | w_e in [0.5, 1.5] |
| `test_emotional_state_modifiers` | State affects weight |
| `test_empty_context` | Edge: no context |
| `test_zero_embedding` | Edge: zero vector |
| `test_empty_content` | Edge: empty string |
| `test_single_context` | Edge: single reference |
| `test_max_values` | Edge: all 1.0 → L=1.0 |
| `test_min_values` | Edge: all 0.0 → L=0.0 |
| `test_phi_orthogonal` | Edge: φ=π/2 → L≈0 |
| `test_identical_embeddings` | Low surprise |
| `test_learning_intensity_categories` | Low/Medium/High |
| `test_utl_state_from_signal` | State extraction |
| `test_utl_state_validation` | NaN detection |
| `test_performance_under_10ms` | <10ms latency |
| `test_performance_large_context` | 100 vectors <50ms |
| `test_learning_signal_serialization` | JSON roundtrip |
| `test_utl_state_serialization` | JSON roundtrip |
| `test_processor_reset` | State reset |
| `test_processor_restore_lifecycle` | Lifecycle restoration |
| `test_stage_thresholds_progression` | Threshold values |

## Existing Benchmarks

### utl_bench.rs (390 lines)

| Benchmark | Target |
|-----------|--------|
| `compute_learning_magnitude` | <100μs |
| `compute_learning_magnitude_validated` | <100μs |
| `full_utl_computation` | <10ms |
| `full_utl_with_emotional_state` | <10ms |
| `surprise_calculation` | <5ms |
| `emotional_weight` | <1ms |
| `emotional_weight_empty` | <1ms |
| `coherence_tracking` | <2ms |
| `johari_classification` | <1μs |
| `phase_oscillator_get` | <1μs |
| `lifecycle_stage_get` | <1μs |
| `lifecycle_weights_get` | <1μs |
| `utl_context_scaling` (10, 25, 50, 100) | Linear |
| `utl_embedding_dimension` (384, 768, 1536, 3072) | Linear |
| `batch_100_computations` | <1s |
| `processor_creation_*` | <1ms |

### surprise_bench.rs (300 lines)

| Benchmark | Target |
|-----------|--------|
| `compute_surprise_384dim_10ctx` | <2ms |
| `compute_surprise_1536dim_50ctx` | <5ms |
| `compute_surprise_empty_context` | <100μs |
| `compute_kl_divergence_*` | <100μs |
| `compute_cosine_distance_*` | <50μs |
| `surprise_context_scaling` | Linear |
| `surprise_dimension_scaling` | Linear |

## Verification Commands

```bash
# Run integration tests
cargo test --package context-graph-utl --test integration_tests -- --nocapture

# Run all UTL tests (385 tests)
cargo test --package context-graph-utl -- --nocapture

# Run benchmarks
cargo bench --package context-graph-utl

# Verify compilation
cargo build --package context-graph-utl

# Clippy check
cargo clippy --package context-graph-utl -- -D warnings
```

## Full State Verification Protocol

### 1. Source of Truth

| Data | Location | Accessor |
|------|----------|----------|
| Learning magnitude | `LearningSignal.magnitude` | Returned by `compute_learning()` |
| Lifecycle stage | `LifecycleManager` internal | `processor.lifecycle_stage()` |
| Interaction count | `UtlProcessor` internal | `processor.interaction_count()` |

### 2. Execute & Inspect

After every test, verify state separately:

```rust
let signal = processor.compute_learning(content, &embedding, &context)?;

// Separate read to verify state
assert_eq!(processor.computation_count(), expected);
assert_eq!(processor.lifecycle_stage(), expected_stage);
assert!(signal.magnitude >= 0.0 && signal.magnitude <= 1.0);
```

### 3. Boundary Edge Cases (with state logging)

| Edge Case | Before | After | Test |
|-----------|--------|-------|------|
| 49→50 interactions | Infancy | Growth | `test_lifecycle_boundary_exact_at_50` |
| 499→500 interactions | Growth | Maturity | `test_lifecycle_boundary_exact_at_500` |
| Empty input | Any valid state | Valid signal (L≈0) | `test_empty_context` |

### 4. Evidence of Success

```bash
# Verify all tests pass
cargo test --package context-graph-utl 2>&1 | tail -3
# Expected: test result: ok. 385 passed; 0 failed;

# Verify benchmarks run
cargo bench --package context-graph-utl 2>&1 | grep "time:"
# All times should be under targets
```

## Sherlock-Holmes Verification Checklist

Run with sherlock-holmes agent before marking complete:

```yaml
verification:
  agent: sherlock-holmes
  checks:
    - name: "Tests Compile"
      command: "cargo build --package context-graph-utl"
      expected: "exit 0"

    - name: "Tests Pass"
      command: "cargo test --package context-graph-utl --test integration_tests"
      expected: "All tests pass"

    - name: "Formula Properties"
      command: "cargo test test_formula -- --nocapture"
      expected: "test_formula_mathematical_properties ... ok"

    - name: "Lifecycle Boundaries"
      command: "cargo test test_lifecycle_boundary -- --nocapture"
      expected: "Both 50 and 500 boundary tests pass"

    - name: "Johari Classification"
      command: "cargo test test_johari -- --nocapture"
      expected: "All 4 quadrants classified correctly"

    - name: "Error Handling"
      command: "cargo test test_error_handling -- --nocapture"
      expected: "All validation errors trigger correctly"

    - name: "Benchmarks Run"
      command: "cargo bench --package context-graph-utl 2>&1 | head -30"
      expected: "Benchmarks complete without error"

    - name: "No Warnings"
      command: "cargo clippy --package context-graph-utl -- -D warnings"
      expected: "exit 0"
```

## Acceptance Criteria (VERIFIED)

- [x] `test_full_utl_pipeline_with_real_data` - Full pipeline validation
- [x] `test_formula_mathematical_properties` - Formula correctness
- [x] `test_lifecycle_transitions_at_thresholds` - 50/500 thresholds
- [x] `test_lambda_weights_per_lifecycle_stage` - Marblestone weights (0.7/0.3, 0.5/0.5, 0.3/0.7)
- [x] `test_johari_quadrant_classification` - All 4 quadrants
- [x] `test_suggested_actions_per_quadrant` - Action mapping
- [x] `test_nan_infinity_prevention_edge_cases` - Numerical stability
- [x] `test_error_handling_out_of_bounds_*` - Fail fast validation
- [x] `test_emotional_weight_bounds` - [0.5, 1.5] bounds
- [x] All benchmarks created and documented
- [x] All edge cases tested (empty, zero, max, min, orthogonal)
- [x] Serialization roundtrip tests

## Mandatory Requirements Compliance

### NO BACKWARDS COMPATIBILITY

- Errors use `UtlError` with context (component, values, expected vs actual)
- No silent degradation - fail fast
- All validation errors propagate via `Result<T, UtlError>`

### NO MOCK DATA

- All tests use deterministic embeddings via `generate_embedding(dim, seed)`
- Real emotional content strings for weight calculation
- Context windows have realistic 1536-dim vectors

### FULL STATE VERIFICATION

- Pre-conditions validated before computation
- Invariants (bounds) maintained during computation
- Post-conditions verified via assertions
- Side effects (lifecycle transitions) logged and tested

---

*Task status: COMPLETE*
*Integration tests: 1016 lines, 36+ tests*
*Benchmarks: 690 lines total*
*Verified: 2026-01-04*
