# M03-F13: BatchConfig Struct Enhancement

## Task Status: COMPLETE (Verified 2026-01-01)

**Implementation Location**: `crates/context-graph-embeddings/src/config.rs`
**Lines**: 153-320 (PaddingStrategy: 153-202, BatchConfig: 204-320)
**Tests**: 357 tests passing (config module has 47+ dedicated tests)

---

## Summary

This task added `PaddingStrategy` enum and enhanced `BatchConfig` struct with `min_batch_size`, `dynamic_batching`, and type-safe padding strategy fields. The implementation follows constitution.yaml specifications exactly.

---

## What Was Implemented

### 1. PaddingStrategy Enum (Lines 153-202)

```rust
#[derive(Debug, Clone, Copy, PartialEq, Eq, Serialize, Deserialize, Default)]
#[serde(rename_all = "snake_case")]
pub enum PaddingStrategy {
    MaxLength,          // Pad to model's max_tokens
    #[default]
    DynamicMax,         // Pad to longest in batch (most efficient)
    PowerOfTwo,         // Pad to next power of 2 (cache-friendly)
    Bucket,             // Use buckets: 64, 128, 256, 512
}
```

**Methods**:
- `PaddingStrategy::all()` - Returns slice of all 4 variants
- `PaddingStrategy::as_str()` - Returns snake_case string representation

### 2. BatchConfig Struct (Lines 204-320)

| Field | Type | Default | Source |
|-------|------|---------|--------|
| `max_batch_size` | `usize` | 32 | constitution.yaml |
| `min_batch_size` | `usize` | 1 | M03-F13 addition |
| `max_wait_ms` | `u64` | 50 | constitution.yaml |
| `dynamic_batching` | `bool` | true | M03-F13 addition |
| `padding_strategy` | `PaddingStrategy` | DynamicMax | M03-F13 addition |
| `sort_by_length` | `bool` | true | PRD Section 4.3 |

### 3. Validation Rules (BatchConfig::validate)

| Rule | Error Condition |
|------|-----------------|
| max_batch_size > 0 | Returns ConfigError if 0 |
| min_batch_size <= max_batch_size | Returns ConfigError if min > max |
| max_wait_ms > 0 when min_batch_size > 1 | Returns ConfigError if wait=0 with min>1 |

### 4. Exports (lib.rs line 41)

```rust
pub use config::PaddingStrategy;
```

---

## Verification Protocol (For Future Audits)

### Source of Truth
- **Primary File**: `crates/context-graph-embeddings/src/config.rs`
- **Export File**: `crates/context-graph-embeddings/src/lib.rs`
- **Test Results**: `cargo test --package context-graph-embeddings`

### Quick Verification Commands

```bash
# 1. Verify PaddingStrategy enum exists with 4 variants
grep -A 20 "pub enum PaddingStrategy" crates/context-graph-embeddings/src/config.rs

# 2. Verify BatchConfig has 6 fields
grep -A 35 "pub struct BatchConfig" crates/context-graph-embeddings/src/config.rs

# 3. Verify export
grep "PaddingStrategy" crates/context-graph-embeddings/src/lib.rs

# 4. Run all tests (MUST pass)
cargo test --package context-graph-embeddings

# 5. Run clippy (MUST have 0 warnings)
cargo clippy --package context-graph-embeddings -- -D warnings
```

### Expected Test Output

All tests related to M03-F13 should pass:
```
test config::tests::test_padding_strategy_default_is_dynamic_max ... ok
test config::tests::test_padding_strategy_all_variants ... ok
test config::tests::test_padding_strategy_as_str ... ok
test config::tests::test_padding_strategy_serde_roundtrip ... ok
test config::tests::test_padding_strategy_serde_snake_case ... ok
test config::tests::test_padding_strategy_copy ... ok
test config::tests::test_batch_config_new_defaults ... ok
test config::tests::test_batch_config_toml_roundtrip ... ok
test config::tests::test_batch_config_partial_toml_uses_defaults ... ok
test config::tests::test_batch_min_exceeds_max_fails ... ok
test config::tests::test_batch_zero_wait_with_min_batch_greater_than_one_fails ... ok
test config::tests::test_batch_zero_wait_with_min_batch_one_succeeds ... ok
```

---

## Full State Verification Protocol

### 1. Define Source of Truth
- **Location**: `crates/context-graph-embeddings/src/config.rs`
- **What to verify**:
  - `PaddingStrategy` enum at lines 153-202
  - `BatchConfig` struct at lines 204-320
  - Test section at lines 1309-1410

### 2. Execute & Inspect

```bash
# Compile check (MUST succeed)
cargo check --package context-graph-embeddings

# Run tests (MUST show 357+ passed, 0 failed)
cargo test --package context-graph-embeddings 2>&1 | tail -5

# Verify struct definition directly
grep -c "pub min_batch_size" crates/context-graph-embeddings/src/config.rs
# Expected: 1

grep -c "pub dynamic_batching" crates/context-graph-embeddings/src/config.rs
# Expected: 1

grep -c "pub padding_strategy: PaddingStrategy" crates/context-graph-embeddings/src/config.rs
# Expected: 1
```

### 3. Boundary & Edge Case Verification

**Edge Case 1: Default Configuration**
```bash
cargo test --package context-graph-embeddings test_batch_config_default -- --nocapture
```
- **Before**: BatchConfig uninitialized
- **After**: All 6 fields have correct defaults
- **Evidence**: Test assertion passes

**Edge Case 2: Invalid min > max**
```bash
cargo test --package context-graph-embeddings test_batch_min_exceeds_max_fails -- --nocapture
```
- **Before**: Config with min_batch_size=64, max_batch_size=32
- **After**: Returns EmbeddingError::ConfigError
- **Evidence**: Test passes, error message contains "cannot exceed"

**Edge Case 3: max_wait_ms=0 with min_batch_size > 1**
```bash
cargo test --package context-graph-embeddings test_batch_zero_wait_with_min_batch_greater_than_one_fails -- --nocapture
```
- **Before**: Config with max_wait_ms=0, min_batch_size=4
- **After**: Returns EmbeddingError::ConfigError
- **Evidence**: Test passes, error message contains "max_wait_ms"

### 4. Evidence of Success Log

```bash
cargo test --package context-graph-embeddings 2>&1 | grep -E "(test result|passed|failed)"
# Expected output:
# test result: ok. 357 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out
```

---

## Constitution.yaml Compliance

| Requirement | Source | Implementation |
|-------------|--------|----------------|
| max_batch_size = 32 | constitution.yaml:embeddings.batch | `default_max_batch_size() = 32` |
| max_wait_ms = 50 | constitution.yaml:perf.latency | `default_max_wait_ms() = 50` |
| >100 items/sec throughput | constitution.yaml:perf.throughput | Enabled by BatchProcessor (M03-L17) |
| sort_by_length reduces padding | PRD Section 4.3 | `default_sort_by_length() = true` |
| Dynamic batching | constitution.yaml:embeddings.batch | `default_dynamic_batching() = true` |

---

## Dependencies

| Dependency | Status | Notes |
|------------|--------|-------|
| M03-F08 (EmbeddingError) | COMPLETE | Used for ConfigError variant |
| None other | - | This task has no unmet dependencies |

---

## What Comes Next

Tasks that depend on M03-F13:
- **M03-L16**: BatchQueue and Request Types (uses BatchConfig)
- **M03-L17**: BatchProcessor (uses BatchConfig for batch logic)

---

## NO BACKWARDS COMPATIBILITY

The old `padding_strategy: String` field was replaced with `PaddingStrategy` enum. Any code using the old string-based approach will fail to compile. This is intentional - fail fast, no fallbacks.

---

## Task Metadata

```yaml
task_id: M03-F13
title: BatchConfig Struct Enhancement
status: COMPLETE
verified: 2026-01-01
layer: foundation
sequence: 13
implements: constitution.yaml:embeddings.batch, PRD Section 4.3
depends_on: M03-F08
file_modified: crates/context-graph-embeddings/src/config.rs
lines_added: ~170 (PaddingStrategy + BatchConfig enhancements)
tests_added: 12 (6 PaddingStrategy + 3 BatchConfig new + 3 validation)
total_tests: 357 (package-wide)
clippy_warnings: 0
```
