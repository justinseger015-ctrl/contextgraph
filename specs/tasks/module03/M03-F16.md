# M03-F16: Module Structure and Public Exports

```xml
<task_spec id="M03-F16" version="3.0">
<metadata>
  <title>Finalize Module Structure and Public Exports</title>
  <status>VERIFIED</status>
  <layer>foundation</layer>
  <sequence>16</sequence>
  <implements>PRD Section 4.3, Rust module conventions, constitution.yaml</implements>
  <depends_on>M03-F01 through M03-F15</depends_on>
  <verified_date>2026-01-01</verified_date>
  <test_count>460</test_count>
  <clippy_warnings>0</clippy_warnings>
</metadata>
```

## CRITICAL: Current State Audit (2026-01-01)

**Tasks M03-F01 through M03-F15 are IMPLEMENTED.** The Foundation layer types exist.

### Existing Crate Structure

```
crates/context-graph-embeddings/src/
├── lib.rs              # ✓ EXISTS - Crate root with re-exports
├── config.rs           # ✓ EXISTS - EmbeddingConfig + sub-configs (2700+ lines, 200+ tests)
├── error.rs            # ✓ EXISTS - EmbeddingError + EmbeddingResult (500+ lines)
├── provider.rs         # ✓ EXISTS - EmbeddingProvider trait
├── stub.rs             # ✓ EXISTS - StubEmbedder for development
├── types/
│   ├── mod.rs          # ✓ EXISTS - Module exports
│   ├── model_id.rs     # ✓ EXISTS - ModelId enum (12 variants)
│   ├── dimensions.rs   # ✓ EXISTS - Dimension constants
│   ├── embedding.rs    # ✓ EXISTS - ModelEmbedding struct
│   ├── concatenated.rs # ✓ EXISTS - ConcatenatedEmbedding
│   ├── fused.rs        # ✓ EXISTS - FusedEmbedding + AuxiliaryEmbeddingData
│   └── input.rs        # ✓ EXISTS - ModelInput, InputType, ImageFormat
└── traits/
    ├── mod.rs          # ✓ EXISTS - Module exports
    ├── embedding_model.rs # ✓ EXISTS - EmbeddingModel trait
    └── model_factory.rs   # ✓ EXISTS - ModelFactory trait + configs
```

### Current lib.rs Exports (VERIFIED 2026-01-01)

```rust
// ACTUAL exports in lib.rs - ALL VERIFIED PRESENT
pub mod config;
pub mod error;
pub mod provider;
pub mod stub;
pub mod traits;
pub mod types;

// Config exports (8 types)
pub use config::{
    BatchConfig,
    CacheConfig,
    EmbeddingConfig,
    EvictionPolicy,
    FusionConfig,
    GpuConfig,
    ModelRegistryConfig,
    PaddingStrategy,
};

// Error exports (2 types)
pub use error::{EmbeddingError, EmbeddingResult};

// Provider exports (2 types)
pub use provider::EmbeddingProvider;
pub use stub::StubEmbedder;

// Trait exports (8 items)
pub use traits::{
    DevicePlacement,
    EmbeddingModel,
    ModelFactory,
    QuantizationMode,
    SingleModelConfig,
    MEMORY_ESTIMATES,
    TOTAL_MEMORY_ESTIMATE,
    get_memory_estimate,
};

// Type exports (10 types + 1 module)
pub use types::{
    AuxiliaryEmbeddingData,
    ConcatenatedEmbedding,
    FusedEmbedding,
    ImageFormat,
    InputType,
    ModelEmbedding,
    ModelId,
    ModelInput,
    TokenizerFamily,
};
pub use types::dimensions;

// Constants (2 items)
pub const DEFAULT_DIMENSION: usize = 1536;
pub const CONCATENATED_DIMENSION: usize = 8320;
```

---

## Task Objective

**Verify and finalize** the module structure for `context-graph-embeddings`. This task:

1. Validates all Foundation types are properly exported
2. Ensures `cargo check`, `cargo test`, `cargo doc`, and `cargo clippy` pass
3. Verifies re-exports are accessible from crate root
4. Adds missing exports if any Foundation types are not re-exported

---

## Definition of Done

### Required Validations

```bash
# ALL MUST PASS - NO FALLBACKS
cargo check --package context-graph-embeddings
cargo test --package context-graph-embeddings
cargo doc --package context-graph-embeddings --no-deps
cargo clippy --package context-graph-embeddings -- -D warnings
```

### Required Constants

| Constant | Value | Status |
|----------|-------|--------|
| `DEFAULT_DIMENSION` | 1536 | ✓ EXISTS |
| `CONCATENATED_DIMENSION` | 8320 | ✓ EXISTS |

### Required Re-exports from Crate Root

| Type | Status |
|------|--------|
| `EmbeddingConfig` | ✓ EXISTS |
| `BatchConfig` | ✓ EXISTS |
| `CacheConfig` | ✓ EXISTS |
| `GpuConfig` | ✓ EXISTS |
| `FusionConfig` | ✓ EXISTS |
| `EvictionPolicy` | ✓ EXISTS |
| `PaddingStrategy` | ✓ EXISTS |
| `ModelRegistryConfig` | ✓ EXISTS |
| `EmbeddingError` | ✓ EXISTS |
| `EmbeddingResult` | ✓ EXISTS |
| `ModelId` | ✓ EXISTS |
| `EmbeddingModel` | ✓ EXISTS |
| `ModelFactory` | ✓ EXISTS |
| `DevicePlacement` | ✓ EXISTS |
| `QuantizationMode` | ✓ EXISTS |
| `SingleModelConfig` | ✓ EXISTS |
| `EmbeddingProvider` | ✓ EXISTS |
| `StubEmbedder` | ✓ EXISTS |

### Re-export Status (ALL COMPLETE)

All types are now properly re-exported from lib.rs:

| Type | Location | Status |
|------|----------|--------|
| `ModelEmbedding` | `types::embedding` | ✅ EXPORTED |
| `ConcatenatedEmbedding` | `types::concatenated` | ✅ EXPORTED |
| `FusedEmbedding` | `types::fused` | ✅ EXPORTED |
| `AuxiliaryEmbeddingData` | `types::fused` | ✅ EXPORTED |
| `ModelInput` | `types::input` | ✅ EXPORTED |
| `InputType` | `types::input` | ✅ EXPORTED |
| `ImageFormat` | `types::input` | ✅ EXPORTED |
| `TokenizerFamily` | `types::model_id` | ✅ EXPORTED |
| `dimensions` module | `types::dimensions` | ✅ EXPORTED |
| `MEMORY_ESTIMATES` | `traits::model_factory` | ✅ EXPORTED |
| `TOTAL_MEMORY_ESTIMATE` | `traits::model_factory` | ✅ EXPORTED |
| `get_memory_estimate` | `traits::model_factory` | ✅ EXPORTED |

---

## Implementation Steps

### Step 1: Add Missing Re-exports to lib.rs

Edit `crates/context-graph-embeddings/src/lib.rs` to add:

```rust
// Add to types re-exports
pub use types::{
    ConcatenatedEmbedding,
    FusedEmbedding,
    AuxiliaryEmbeddingData,
    ImageFormat,
    InputType,
    ModelEmbedding,
    ModelId,
    ModelInput,
    TokenizerFamily,
};
pub use types::dimensions;

// Add to traits re-exports
pub use traits::{
    DevicePlacement,
    EmbeddingModel,
    ModelFactory,
    QuantizationMode,
    SingleModelConfig,
    MEMORY_ESTIMATES,
    TOTAL_MEMORY_ESTIMATE,
    get_memory_estimate,
};
```

### Step 2: Run Verification Commands

```bash
cargo check --package context-graph-embeddings
cargo test --package context-graph-embeddings
cargo clippy --package context-graph-embeddings -- -D warnings
cargo doc --package context-graph-embeddings --no-deps
```

**FAIL FAST**: If any command fails, fix immediately. No workarounds.

### Step 3: Write Integration Test

Create test in `config.rs` or separate test file:

```rust
#[test]
fn test_all_types_accessible_from_crate_root() {
    // Config types
    let _: context_graph_embeddings::EmbeddingConfig;
    let _: context_graph_embeddings::BatchConfig;
    let _: context_graph_embeddings::CacheConfig;
    let _: context_graph_embeddings::GpuConfig;
    let _: context_graph_embeddings::FusionConfig;
    let _: context_graph_embeddings::EvictionPolicy;
    let _: context_graph_embeddings::PaddingStrategy;

    // Error types
    let _: context_graph_embeddings::EmbeddingError;

    // Core types
    let _: context_graph_embeddings::ModelId;
    let _: context_graph_embeddings::ModelEmbedding;
    let _: context_graph_embeddings::ConcatenatedEmbedding;
    let _: context_graph_embeddings::FusedEmbedding;
    let _: context_graph_embeddings::ModelInput;
    let _: context_graph_embeddings::InputType;
    let _: context_graph_embeddings::ImageFormat;

    // Constants
    assert_eq!(context_graph_embeddings::DEFAULT_DIMENSION, 1536);
    assert_eq!(context_graph_embeddings::CONCATENATED_DIMENSION, 8320);
}
```

---

## Full State Verification Requirements

After completing the implementation, perform these verification steps:

### Source of Truth

- `crates/context-graph-embeddings/src/lib.rs` is the authoritative source for public API
- All Foundation types (M03-F01 through M03-F15) MUST be accessible from crate root
- `cargo doc` output defines the public contract

### Execute & Inspect

```bash
# 1. Compile and verify no errors
cargo check -p context-graph-embeddings 2>&1 | head -50

# 2. Run all tests
cargo test -p context-graph-embeddings 2>&1

# 3. Check for warnings (must be 0)
cargo clippy -p context-graph-embeddings -- -D warnings 2>&1

# 4. Generate docs (must succeed)
cargo doc -p context-graph-embeddings --no-deps 2>&1

# 5. Verify crate can be imported
echo 'use context_graph_embeddings::*;' | rustfmt --check
```

### Boundary & Edge Case Audit

| Test Case | Before State | After State | Verification |
|-----------|--------------|-------------|--------------|
| Import `ModelId` from root | `use context_graph_embeddings::ModelId` | Compiles | `cargo check` passes |
| Import `FusedEmbedding` from root | `use context_graph_embeddings::FusedEmbedding` | Compiles | `cargo check` passes |
| Access `dimensions` module | `use context_graph_embeddings::dimensions` | Compiles | `cargo check` passes |
| Invalid import path | `use context_graph_embeddings::foo` | Error | Compiler rejects |

### Evidence of Success

Record in this document or PR:

```
[VERIFICATION LOG]
Date: 2026-01-01 17:28:00
cargo check: PASS
cargo test: PASS (460 tests - 440 unit + 20 doc tests)
cargo clippy: PASS (0 warnings)
cargo doc: PASS
All re-exports verified: YES (32/32 exports)
Missing types: NONE

EXPORTS VERIFIED:
- Config types: 8/8 present
- Error types: 2/2 present
- Provider types: 2/2 present
- Trait exports: 8/8 present
- Type exports: 10/10 present
- Constants: 2/2 present (DEFAULT_DIMENSION=1536, CONCATENATED_DIMENSION=8320)

SHERLOCK-HOLMES VERDICT: CASE CLOSED - M03-F16 COMPLETE
```

---

## Manual Output Verification

After implementation, verify these concrete outputs:

1. **Documentation**: Open `target/doc/context_graph_embeddings/index.html`
   - All modules listed: config, error, provider, stub, traits, types
   - All re-exports visible in main page
   - No broken links

2. **Test Output**: `cargo test -p context-graph-embeddings`
   - Count of passed tests (expect 200+)
   - Count of ignored tests
   - No failures

3. **Clippy Output**: `cargo clippy -p context-graph-embeddings -- -D warnings`
   - Must show: "Finished" with 0 warnings

---

## sherlock-holmes Verification

**MANDATORY**: At task completion, spawn `sherlock-holmes` subagent to verify:

```
Verify M03-F16 Module Structure task is complete:

1. Check lib.rs contains ALL re-exports listed in task document
2. Verify cargo check, cargo test, cargo doc, cargo clippy all pass
3. Confirm constants DEFAULT_DIMENSION=1536, CONCATENATED_DIMENSION=8320
4. Verify no compilation warnings
5. Test that types can be imported from crate root
6. Inspect test output for expected count (200+ tests)
7. Document any discrepancies found

Evidence required:
- Screenshot or copy of cargo test output
- Cargo clippy output showing 0 warnings
- Confirmation all types importable from root
```

---

## Error Handling Policy

**NO BACKWARDS COMPATIBILITY. NO FALLBACKS.**

- If `cargo check` fails → FIX THE CODE, do not create workarounds
- If a type is missing → ADD IT, do not create stub types
- If tests fail → FIX THE TESTS, do not ignore them
- If clippy warns → FIX THE WARNING, do not suppress it

All errors must be logged with:
```
[ERROR] Component: <module>
[ERROR] File: <path>:<line>
[ERROR] Message: <error message>
[ERROR] Action: <what was done to fix>
```

---

## Reference: constitution.yaml Performance Budgets

From `/home/cabdru/contextgraph/docs2/constitution.yaml`:

```yaml
performance_budgets:
  single_embed: "<10ms"
  batch_embed_64: "<50ms"
  reflex_cache: "<100μs"
```

Ensure module structure does not introduce unnecessary overhead.

---

---

## Integration with Module 4 (Graph Storage)

This module exports types required by the Knowledge Graph (Module 4):

| Export | Used By Module 4 For |
|--------|---------------------|
| `FusedEmbedding` | KnowledgeNode.embedding field (1536D) |
| `AuxiliaryEmbeddingData` | ColBERT per-token storage |
| `ModelId` | Embedding provenance tracking |
| `dimensions::FUSED_OUTPUT` | Vector dimension validation |
| `TokenizerFamily` | Tokenizer sharing across models |

---

## Dependency Graph

```
M03-F01 (ModelId) ────────────────────────┐
M03-F02 (dimensions) ────────────────────┤
M03-F03 (ModelEmbedding) ────────────────┤
M03-F04 (ConcatenatedEmbedding) ─────────┤
M03-F05 (FusedEmbedding) ────────────────┼──► M03-F16 (Module Exports) ──► Module 4
M03-F06 (ModelInput) ────────────────────┤
M03-F07 (InputType) ─────────────────────┤
M03-F08 (EmbeddingError) ────────────────┤
M03-F09 (EmbeddingModel) ────────────────┤
M03-F10 (ModelFactory) ──────────────────┤
M03-F11 (EmbeddingConfig) ───────────────┤
M03-F12 (ModelRegistryConfig) ───────────┤
M03-F13 (BatchConfig) ───────────────────┤
M03-F14 (FusionConfig) ──────────────────┤
M03-F15 (CacheConfig, GpuConfig) ────────┘
```

---

## References

- PRD: `/home/cabdru/contextgraph/docs2/contextprd.md` Section 4 (Data Model)
- Constitution: `/home/cabdru/contextgraph/docs2/constitution.yaml` (dirs, naming, rules)
- CUDA Report: `/home/cabdru/contextgraph/docs2/CUDA-13-1-RTX-5090-Report.md`
- System Specs: `/home/cabdru/contextgraph/docs2/systemspecs.md` (RTX 5090 + 9950X3D)
- Traceability: `/home/cabdru/contextgraph/specs/tasks/module03/_traceability.md`
- Index: `/home/cabdru/contextgraph/specs/tasks/module03/_index.md`

---

*Task ID: M03-F16*
*Module: 03 - 12-Model Embedding Pipeline*
*Layer: Foundation*
*Version: 3.0 (VERIFIED 2026-01-01)*
*Status: COMPLETE - 460 tests passing, 0 clippy warnings*
