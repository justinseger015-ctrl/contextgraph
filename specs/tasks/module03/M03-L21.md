# M03-L21: Expert Networks (8 Experts) for FuseMoE

> **Version**: 2.3 | **Status**: COMPLETE | **Layer**: logic | **Sequence**: 21

## CRITICAL STATUS: ALREADY IMPLEMENTED

**This task has been COMPLETED and VERIFIED by Sherlock-Holmes forensic investigation on 2026-01-01.**

**Source Files (Source of Truth):**
- `crates/context-graph-embeddings/src/fusion/experts.rs` (1207 lines)
- `crates/context-graph-embeddings/src/fusion/mod.rs` (module exports)
- `crates/context-graph-embeddings/src/lib.rs` (crate re-exports)

**Verification Status:** 51 tests passing, 0 clippy warnings, compilation clean.

---

## Quick Context for AI Agent

### What Exists (Source of Truth)

| Artifact | Path | Status | Verification Command |
|----------|------|--------|---------------------|
| Expert struct | `fusion/experts.rs:121-137` | IMPLEMENTED | `grep -n "pub struct Expert" crates/context-graph-embeddings/src/fusion/experts.rs` |
| ExpertPool struct | `fusion/experts.rs:353-363` | IMPLEMENTED | `grep -n "pub struct ExpertPool" crates/context-graph-embeddings/src/fusion/experts.rs` |
| Activation enum | `fusion/experts.rs:41-93` | IMPLEMENTED | `grep -n "pub enum Activation" crates/context-graph-embeddings/src/fusion/experts.rs` |
| Module export | `fusion/mod.rs:34-38` | EXPORTED | `cat crates/context-graph-embeddings/src/fusion/mod.rs` |
| Lib re-export | `lib.rs:83` | EXPORTED | `grep "pub use fusion" crates/context-graph-embeddings/src/lib.rs` |
| Unit tests | `fusion/experts.rs:644-1207` | 51 PASSING | `cargo test -p context-graph-embeddings expert 2>&1 \| tail -20` |

### Architecture

```
12 Model Outputs -> Concatenate (8320D) -> GatingNetwork -> select_top_k()
                                                |
                                       (indices, weights)
                                                |
                              ExpertPool.forward_topk()
                                                |
                              Weighted combination -> 1536D fused output
```

### Key Constants (from `types/dimensions.rs`)

```rust
pub const TOTAL_CONCATENATED: usize = 8320;  // Input dimension (sum of 12 models)
pub const NUM_EXPERTS: usize = 8;             // Expert count
pub const FUSED_OUTPUT: usize = 1536;         // Output dimension
pub const TOP_K_EXPERTS: usize = 4;           // Default top-k (per constitution.yaml)
```

**IMPORTANT**: TOP_K_EXPERTS changed from 2 to 4 based on constitution.yaml specification: `fuse_moe: { top_k: 4, laplace_alpha: 0.01 }`

---

## Metadata

| Field | Value |
|-------|-------|
| **Task ID** | M03-L21 |
| **Title** | Expert Networks (8 Experts) for FuseMoE |
| **Status** | COMPLETE |
| **Layer** | logic |
| **Sequence** | 21 |
| **Implements** | PRD-EMB-004: FuseMoE Mixture of Experts Fusion |
| **Depends On** | M03-F02 (dimensions), M03-F14 (FusionConfig), M03-L20 (GatingNetwork) |
| **Blocks** | M03-L22 (FuseMoE Router) |
| **Completed** | 2026-01-01 |
| **Verified By** | Sherlock-Holmes forensic investigation |

---

## Implementation Summary

### Expert (Single FFN)

```rust
pub struct Expert {
    input_to_hidden: Linear,    // 8320 -> 4096
    hidden_to_output: Linear,   // 4096 -> 1536
    activation: Activation,     // GELU default
    expert_id: usize,           // 0-7
    input_dim: usize,           // 8320
    hidden_dim: usize,          // 4096
    output_dim: usize,          // 1536
}

impl Expert {
    pub fn new(expert_id, input_dim, hidden_dim, output_dim, activation) -> EmbeddingResult<Self>;
    pub fn forward(&self, input: &[f32], batch_size: usize) -> EmbeddingResult<Vec<f32>>;
    pub fn expert_id(&self) -> usize;
    pub fn parameter_count(&self) -> usize;  // ~40.4M per expert
}
```

### ExpertPool (8 Experts)

```rust
pub struct ExpertPool {
    experts: Vec<Expert>,  // 8 experts
    input_dim: usize,      // 8320
    hidden_dim: usize,     // 4096
    output_dim: usize,     // 1536
}

impl ExpertPool {
    pub fn new(config: &FusionConfig) -> EmbeddingResult<Self>;
    pub fn forward(&self, input: &[f32], batch_size: usize, expert_idx: usize) -> EmbeddingResult<Vec<f32>>;
    pub fn forward_topk(&self, input: &[f32], batch_size: usize, indices: &[usize], weights: &[f32], top_k: usize) -> EmbeddingResult<Vec<f32>>;
    pub fn num_experts(&self) -> usize;
    pub fn total_parameter_count(&self) -> usize;  // ~323M total
}
```

### Activation

```rust
pub enum Activation {
    Gelu,  // x * 0.5 * (1 + tanh(sqrt(2/pi) * (x + 0.044715 * x^3)))
    Relu,  // max(0, x)
    Silu,  // x * sigmoid(x)
}
```

**GELU Constants (verified):**
- `SQRT_2_OVER_PI = 0.797_884_6` (correct: sqrt(2/pi) = 0.7978845608)
- `COEF = 0.044715` (standard GELU approximation coefficient)

---

## Full State Verification Protocol

### 1. Source of Truth Definition

| Source | Location | What It Proves |
|--------|----------|----------------|
| `fusion/experts.rs` file | `crates/context-graph-embeddings/src/fusion/experts.rs` | Implementation exists and is complete |
| `cargo check` | Terminal output | Code compiles without errors |
| `cargo test expert` | Terminal output | All 51 tests pass |
| `cargo clippy` | Terminal output | No warnings (code quality) |

### 2. Execute & Inspect Commands

Run these commands to verify implementation state:

```bash
# 1. Verify file exists and line count
wc -l crates/context-graph-embeddings/src/fusion/experts.rs
# Expected output: 1207 crates/context-graph-embeddings/src/fusion/experts.rs

# 2. Verify compiles without errors
cargo check -p context-graph-embeddings 2>&1 | head -10
# Expected: "Finished `dev` profile" with 0 errors

# 3. Verify all tests pass
cargo test -p context-graph-embeddings expert 2>&1 | tail -20
# Expected: "test result: ok. 51 passed; 0 failed"

# 4. Verify clippy clean (no warnings)
cargo clippy -p context-graph-embeddings -- -D warnings 2>&1 | head -10
# Expected: "Finished" with 0 warnings

# 5. Verify module exports
grep -n "pub use experts" crates/context-graph-embeddings/src/fusion/mod.rs
# Expected: Line 37: pub use experts::{Activation, Expert, ExpertPool};

# 6. Verify lib re-exports
grep "pub use fusion" crates/context-graph-embeddings/src/lib.rs
# Expected: pub use fusion::{Activation, Expert, ExpertPool, GatingNetwork, LayerNorm, Linear};
```

### 3. Boundary & Edge Case Audit

The following edge cases are tested in `fusion/experts.rs`:

| Edge Case | Test Function | Before State | After State | Expected Result |
|-----------|---------------|--------------|-------------|-----------------|
| **Empty batch** | `edge_case_empty_batch()` | batch_size=0 | Error returned | `EmbeddingError::EmptyInput` |
| **Equal weights** | `edge_case_equal_weights()` | 4 experts, weights=[0.25, 0.25, 0.25, 0.25] | Weighted average | All 4 experts contribute equally |
| **Extreme weights** | `edge_case_extreme_weights()` | weights=[0.999, 0.001, 0.0, 0.0] | Near-single expert | Output ~= single expert output (idx=0) |

Run edge case tests specifically:
```bash
cargo test -p context-graph-embeddings edge_case 2>&1 | grep -E "test.*edge_case"
# Expected: 3 tests pass
```

### 4. Evidence of Success Log

After running `cargo test -p context-graph-embeddings expert 2>&1 | tail -30`:

```
running 51 tests
test fusion::experts::tests::test_activation_default ... ok
test fusion::experts::tests::test_activation_gelu_negative ... ok
test fusion::experts::tests::test_activation_gelu_positive ... ok
test fusion::experts::tests::test_activation_gelu_zero ... ok
test fusion::experts::tests::test_activation_relu ... ok
test fusion::experts::tests::test_activation_silu ... ok
test fusion::experts::tests::test_expert_creation ... ok
test fusion::experts::tests::test_expert_output_shape ... ok
...
test fusion::experts::tests::test_integration_with_gating_network ... ok

test result: ok. 51 passed; 0 failed; 0 ignored; 0 measured; finished in 126.29s
```

---

## Error Handling (Fail Fast - NO Fallbacks)

| Error Condition | Error Variant | Action |
|-----------------|---------------|--------|
| batch_size == 0 | `EmbeddingError::EmptyInput` | Immediate return |
| input.len() != expected | `EmbeddingError::DimensionMismatch` | Immediate return with expected/got values |
| expert_idx >= NUM_EXPERTS | `EmbeddingError::InvalidExpertIndex` | Immediate return with index/max values |
| dimension == 0 in constructor | `EmbeddingError::InvalidDimension` | Immediate return with expected/actual |
| weights sum != 1.0 | Log warning via `tracing::warn!` | Continue (soft constraint) |

**NO FALLBACKS**: If any error occurs, the function returns immediately with a descriptive error. No silent failures, no default values, no workarounds.

---

## Constraints Enforced

| Constraint | Implementation | Verification |
|------------|----------------|--------------|
| Pure Rust Vec<f32> | No candle imports | `grep -r "candle" crates/context-graph-embeddings/src/fusion/` returns nothing |
| 8 experts exactly | `NUM_EXPERTS = 8` const | Compile-time assertion in `dimensions.rs:171-174` |
| Input dim = 8320 | `TOTAL_CONCATENATED` const | Compile-time assertion in `dimensions.rs:153-156` |
| Output dim = 1536 | `FUSED_OUTPUT` const | Compile-time assertion in `dimensions.rs:159-162` |
| Top-K = 4 | `TOP_K_EXPERTS` const | Compile-time assertion in `dimensions.rs:177-180` |
| GELU activation default | `Activation::Gelu` as default | `#[default]` attribute on enum |

---

## Integration with GatingNetwork (M03-L20)

```rust
#[test]
fn test_integration_with_gating_network() {
    let config = FusionConfig::default();
    let gating = GatingNetwork::new(&config).unwrap();
    let pool = ExpertPool::new(&config).unwrap();

    let input = vec![0.5f32; TOTAL_CONCATENATED];
    let probs = gating.forward(&input, 1).unwrap();
    let (indices, weights) = gating.select_top_k(&probs, 1, TOP_K_EXPERTS).unwrap();
    let output = pool.forward_topk(&input, 1, &indices, &weights, TOP_K_EXPERTS).unwrap();

    assert_eq!(output.len(), FUSED_OUTPUT);  // 1536D
    for &val in &output { assert!(val.is_finite()); }  // No NaN/Inf
}
```

---

## Next Task: M03-L22 (FuseMoE Router)

This task (M03-L21) is **COMPLETE** and unblocks:
- **M03-L22**: FuseMoE Router - Combines GatingNetwork + ExpertPool into full FuseMoE

Usage pattern for M03-L22:
```rust
let gating = GatingNetwork::new(&config)?;
let experts = ExpertPool::new(&config)?;

// Full FuseMoE forward:
let probs = gating.forward(&concatenated_8320, batch_size)?;
let (indices, weights) = gating.select_top_k(&probs, batch_size, TOP_K_EXPERTS)?;
let fused = experts.forward_topk(&concatenated_8320, batch_size, &indices, &weights, TOP_K_EXPERTS)?;
// fused: Vec<f32> of length batch_size * 1536
```

---

## Sherlock-Holmes Forensic Checklist

If re-verifying this implementation, run:

```bash
# Master verification command (run all checks in sequence)
echo "=== M03-L21 VERIFICATION ===" && \
wc -l crates/context-graph-embeddings/src/fusion/experts.rs && \
cargo check -p context-graph-embeddings 2>&1 | tail -5 && \
cargo clippy -p context-graph-embeddings -- -D warnings 2>&1 | tail -5 && \
cargo test -p context-graph-embeddings expert 2>&1 | tail -10 && \
grep -r "candle" crates/context-graph-embeddings/src/fusion/ || echo "NO CANDLE - GOOD" && \
echo "=== VERIFICATION COMPLETE ==="
```

Expected output summary:
- File: 1207 lines
- Cargo check: "Finished" (0 errors)
- Cargo clippy: "Finished" (0 warnings)
- Tests: "51 passed; 0 failed"
- No candle imports

**Checklist:**
- [x] FILE EXISTS: `crates/context-graph-embeddings/src/fusion/experts.rs` exists (1207 lines)
- [x] MODULE EXPORT: `fusion/mod.rs` exports `experts` module and types
- [x] LIB EXPORT: `lib.rs` re-exports fusion types at line 83
- [x] STRUCT COMPLETE: `Expert` has all 7 fields
- [x] STRUCT COMPLETE: `ExpertPool` has all 4 fields
- [x] DIMENSIONS CORRECT: Uses TOTAL_CONCATENATED=8320, FUSED_OUTPUT=1536, NUM_EXPERTS=8, TOP_K_EXPERTS=4
- [x] NO CANDLE: Zero imports from candle crate
- [x] GELU CORRECT: Uses exact approximation formula (sqrt(2/pi) * (x + 0.044715 * x^3))
- [x] ERROR HANDLING: All error paths return proper EmbeddingError variants
- [x] TESTS PASS: `cargo test -p context-graph-embeddings expert` succeeds (51 tests)
- [x] CLIPPY CLEAN: `cargo clippy -p context-graph-embeddings` has no warnings
- [x] INTEGRATION: Test with GatingNetwork.select_top_k() works end-to-end

---

*Task completed: 2026-01-01*
*Verified by: Sherlock-Holmes forensic investigation*
*Module: 03 - 12-Model Embedding Pipeline*
*Version: 2.3*
